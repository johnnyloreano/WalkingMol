var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,i,r;e=e||{},t=void 0!==e.parent?e.parent:document.body,i=void 0!==e.id?e.id:"oldie",r=Detector.getWebGLErrorMessage(),r.id=i,t.appendChild(r)}};"object"==typeof module&&(module.exports=Detector),THREE.TrackballControls=function(e,t,i){function r(e){u.enabled!==!1&&(window.removeEventListener("keydown",r),v=u._state,u._state===u.STATE.NONE&&(e.keyCode!==u.keys[u.STATE.ROTATE]||u.noRotate?e.keyCode!==u.keys[u.STATE.ZOOM]||u.noZoom?e.keyCode!==u.keys[u.STATE.PAN]||u.noPan||(u._state=u.STATE.PAN):u._state=u.STATE.ZOOM:u._state=u.STATE.ROTATE))}function o(e){u.enabled!==!1&&(u._state=v,window.addEventListener("keydown",r,!1))}function n(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state===u.STATE.NONE&&(u._state=e.button),u._state!==u.STATE.ROTATE||u.noRotate?u._state!==u.STATE.ZOOM||u.noZoom?u._state!==u.STATE.PAN||u.noPan||(u._panStart.copy(w(e.pageX,e.pageY)),u._panEnd.copy(u._panStart)):(u._zoomStart.copy(w(e.pageX,e.pageY)),u._zoomEnd.copy(u._zoomStart)):(u._rotateStart.copy(T(e.pageX,e.pageY)),u._rotateEnd.copy(u._rotateStart)),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",a,!1),u.dispatchEvent(E))}function s(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state!==u.STATE.ROTATE||u.noRotate?u._state!==u.STATE.ZOOM||u.noZoom?u._state!==u.STATE.PAN||u.noPan||u._panEnd.copy(w(e.pageX,e.pageY)):u._zoomEnd.copy(w(e.pageX,e.pageY)):u._rotateEnd.copy(T(e.pageX,e.pageY)))}function a(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state=u.STATE.NONE,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),u.dispatchEvent(C))}function c(e){if(u.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),u._zoomStart.y=.005*t,u.dispatchEvent(E),u.dispatchEvent(C)}}function d(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._state=u.STATE.TOUCH_ROTATE,u._rotateStart.copy(T(e.touches[0].pageX,e.touches[0].pageY)),u._rotateEnd.copy(u._rotateStart);break;case 2:u._state=u.STATE.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;y=g=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panStart.copy(w(r,o)),u._panEnd.copy(u._panStart);break;default:u._state=u.STATE.NONE}u.dispatchEvent(E)}}function l(e){if(u.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:u._rotateEnd.copy(T(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;y=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(w(r,o));break;default:u._state=u.STATE.NONE}}function h(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._rotateEnd.copy(T(e.touches[0].pageX,e.touches[0].pageY)),u._rotateStart.copy(u._rotateEnd);break;case 2:g=y=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(w(t,i)),u._panStart.copy(u._panEnd)}u._state=u.STATE.NONE,u.dispatchEvent(C)}}var u=this;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var p=1e-6,m=new THREE.Vector3;this._state=this.STATE.NONE;var v=this.STATE.NONE,f=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var g=0,y=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var b={type:"change"},E={type:"start"},C={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var w=function(){var e=new THREE.Vector2;return function(t,i){return e.set((t-u.screen.left)/u.screen.width,(i-u.screen.top)/u.screen.height),e}}(),T=function(){var e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,o){i.set((r-.5*u.screen.width-u.screen.left)/(.5*u.screen.width),(.5*u.screen.height+u.screen.top-o)/(.5*u.screen.height),0);var n=i.length();return u.noRoll?n<Math.SQRT1_2?i.z=Math.sqrt(1-n*n):i.z=.5/n:n>1?i.normalize():i.z=Math.sqrt(1-n*n),f.copy(u.object.position).sub(u.target),e.copy(u.object.up).setLength(i.y),e.add(t.copy(u.object.up).cross(f).setLength(i.x)),e.add(f.setLength(i.z)),e}}();this.rotateCamera=function(e,t){var r=new THREE.Vector3,o=new THREE.Quaternion;return function(e,t){var n;void 0===e&&(n=Math.acos(u._rotateStart.dot(u._rotateEnd)/u._rotateStart.length()/u._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(r.crossVectors(u._rotateStart,u._rotateEnd).normalize(),n*=u.rotateSpeed,o.setFromAxisAngle(r,-n)):o.copy(e),void 0!==t&&t!==!0||i.quaternion.multiplyQuaternions(o,i.quaternion),f.applyQuaternion(o),u.object.up.applyQuaternion(o),u._rotateEnd.applyQuaternion(o),u.staticMoving?u._rotateStart.copy(u._rotateEnd):(o.setFromAxisAngle(r,n*(u.dynamicDampingFactor-1)),u._rotateStart.applyQuaternion(o)))}}(),this.zoomCamera=function(e,t){if(u._state===u.STATE.TOUCH_ZOOM_PAN){var r;void 0!==e?r=e:(r=g/y,g=y),f.multiplyScalar(r),void 0!==t&&t!==!0||(i._zoomFactor*=r)}else{var r;r=void 0!==e?e:1+(u._zoomEnd.y-u._zoomStart.y)*u.zoomSpeed,void 0!==t&&t!==!0||(i._zoomFactor*=r),1!==r&&(f.multiplyScalar(r),u.staticMoving?u._zoomStart.copy(u._zoomEnd):u._zoomStart.y+=(u._zoomEnd.y-u._zoomStart.y)*this.dynamicDampingFactor)}},this.panCamera=function(e,t){var r=new THREE.Vector2,o=new THREE.Vector3,n=new THREE.Vector3;return function(e,t){void 0!==e?(r=e,void 0!==t&&t!==!0||i.mouseChange.add(e)):(r.copy(u._panEnd).sub(u._panStart),void 0!==t&&t!==!0||i.mouseChange.add(u._panEnd).sub(u._panStart)),r.lengthSq()&&(r.multiplyScalar(f.length()*u.panSpeed),n.copy(f).cross(u.object.up).setLength(r.x),n.add(o.copy(u.object.up).setLength(r.y)),u.object.position.add(n),u.target.add(n),u.staticMoving?u._panStart.copy(u._panEnd):u._panStart.add(r.subVectors(u._panEnd,u._panStart).multiplyScalar(u.dynamicDampingFactor)))}}(),this.checkDistances=function(){u.noZoom&&u.noPan||(f.lengthSq()>u.maxDistance*u.maxDistance&&u.object.position.addVectors(u.target,f.setLength(u.maxDistance)),f.lengthSq()<u.minDistance*u.minDistance&&u.object.position.addVectors(u.target,f.setLength(u.minDistance)))},this.update=function(e){f.subVectors(u.object.position,u.target),u.noRotate||(void 0!==e&&void 0!==e.quaternion?u.rotateCamera(e.quaternion,e.update):u.rotateCamera()),u.noZoom||(void 0!==e&&void 0!==e._zoomFactor?u.zoomCamera(e._zoomFactor,e.update):u.zoomCamera()),u.noPan||(void 0!==e&&void 0!==e.mouseChange?u.panCamera(e.mouseChange,e.update):u.panCamera()),u.object.position.addVectors(u.target,f),u.checkDistances(),u.object.lookAt(u.target),m.distanceToSquared(u.object.position)>p&&(u.dispatchEvent(b),m.copy(u.object.position))},this.reset=function(){u._state=u.STATE.NONE,v=u.STATE.NONE,u.target.copy(u.target0),u.object.position.copy(u.position0),u.object.up.copy(u.up0),f.subVectors(u.object.position,u.target),u.object.lookAt(u.target),u.dispatchEvent(b),m.copy(u.object.position)},this.domElement.addEventListener("contextmn",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",d,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",r,!1),window.addEventListener("keyup",o,!1),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls,THREE.OrthographicTrackballControls=function(e,t,i){function r(e){u.enabled!==!1&&(window.removeEventListener("keydown",r),g=u._state,u._state===p.NONE&&(e.keyCode!==u.keys[p.ROTATE]||u.noRotate?e.keyCode!==u.keys[p.ZOOM]||u.noZoom?e.keyCode!==u.keys[p.PAN]||u.noPan||(u._state=p.PAN):u._state=p.ZOOM:u._state=p.ROTATE))}function o(e){u.enabled!==!1&&(u._state=g,window.addEventListener("keydown",r,!1))}function n(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state===p.NONE&&(u._state=e.button),u._state!==p.ROTATE||u.noRotate?u._state!==p.ZOOM||u.noZoom?u._state!==p.PAN||u.noPan||(u._panStart.copy(A(e.pageX,e.pageY)),u._panEnd.copy(u._panStart)):(u._zoomStart.copy(A(e.pageX,e.pageY)),u._zoomEnd.copy(u._zoomStart)):(u._rotateStart.copy(S(e.pageX,e.pageY)),u._rotateEnd.copy(u._rotateStart)),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",a,!1),u.dispatchEvent(T))}function s(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state!==p.ROTATE||u.noRotate?u._state!==p.ZOOM||u.noZoom?u._state!==p.PAN||u.noPan||u._panEnd.copy(A(e.pageX,e.pageY)):u._zoomEnd.copy(A(e.pageX,e.pageY)):u._rotateEnd.copy(S(e.pageX,e.pageY)))}function a(e){u.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),u._state=p.NONE,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),u.dispatchEvent(R))}function c(e){if(u.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),u._zoomStart.y=.01*t,u.dispatchEvent(T),u.dispatchEvent(R)}}function d(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._state=p.TOUCH_ROTATE,u._rotateStart.copy(S(e.touches[0].pageX,e.touches[0].pageY)),u._rotateEnd.copy(u._rotateStart);break;case 2:u._state=p.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;C=E=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panStart.copy(A(r,o)),u._panEnd.copy(u._panStart);break;default:u._state=p.NONE}u.dispatchEvent(T)}}function l(e){if(u.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:u._rotateEnd.copy(S(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;C=Math.sqrt(t*t+i*i);var r=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(A(r,o));break;default:u._state=p.NONE}}function h(e){if(u.enabled!==!1){switch(e.touches.length){case 1:u._rotateEnd.copy(S(e.touches[0].pageX,e.touches[0].pageY)),u._rotateStart.copy(u._rotateEnd);break;case 2:E=C=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;u._panEnd.copy(A(t,i)),u._panStart.copy(u._panEnd)}u._state=p.NONE,u.dispatchEvent(R)}}var u=this,p={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=.5,this.zoomSpeed=1.2;var m=.01;this.zoomSpeed*=m,this.panSpeed=.03,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new THREE.Vector3;var v=1e-6,f=new THREE.Vector3;this._state=p.NONE;var g=p.NONE,y=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var b=1,E=0,C=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0=new THREE.Vector2((this.left0+this.right0)/2,(this.top0+this.bottom0)/2);var w={type:"change"},T={type:"start"},R={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0.set((this.left0+this.right0)/2,(this.top0+this.bottom0)/2)},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var A=function(){var e=new THREE.Vector2;return function(t,i){return e.set((t-u.screen.left)/u.screen.width,(i-u.screen.top)/u.screen.height),e}}(),S=function(){var e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,o){i.set((r-.5*u.screen.width-u.screen.left)/(.5*u.screen.width),(.5*u.screen.height+u.screen.top-o)/(.5*u.screen.height),0);var n=i.length();return u.noRoll?n<Math.SQRT1_2?i.z=Math.sqrt(1-n*n):i.z=.5/n:n>1?i.normalize():i.z=Math.sqrt(1-n*n),y.copy(u.object.position).sub(u.target),e.copy(u.object.up).setLength(i.y),e.add(t.copy(u.object.up).cross(y).setLength(i.x)),e.add(y.setLength(i.z)),e}}();this.rotateCamera=function(e,t){var r=new THREE.Vector3,o=new THREE.Quaternion;return function(e,t){var n;void 0===e&&(n=Math.acos(u._rotateStart.dot(u._rotateEnd)/u._rotateStart.length()/u._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(r.crossVectors(u._rotateStart,u._rotateEnd).normalize(),n*=u.rotateSpeed,o.setFromAxisAngle(r,-n)):o.copy(e),void 0!==t&&t!==!0||i.quaternion.multiplyQuaternions(o,i.quaternion),y.applyQuaternion(o),u.object.up.applyQuaternion(o),u._rotateEnd.applyQuaternion(o),u.staticMoving?u._rotateStart.copy(u._rotateEnd):(o.setFromAxisAngle(r,n*(u.dynamicDampingFactor-1)),u._rotateStart.applyQuaternion(o)))}}(),this.zoomCamera=function(e,t){var r;u._state===p.TOUCH_ZOOM_PAN?void 0!==e?r=e:(r=E/C,E=C):r=void 0!==e?e:1+(u._zoomEnd.y-u._zoomStart.y)*u.zoomSpeed/m,void 0!==t&&t!==!0||(i._zoomFactor*=r),1!==r&&(b=r,u.object.left=b*u.left0+(1-b)*u.center0.x,u.object.right=b*u.right0+(1-b)*u.center0.x,u.object.top=b*u.top0+(1-b)*u.center0.y,u.object.bottom=b*u.bottom0+(1-b)*u.center0.y,u.staticMoving?u._zoomStart.copy(u._zoomEnd):u._zoomStart.y+=(u._zoomEnd.y-u._zoomStart.y)*this.dynamicDampingFactor)},this.panCamera=function(e,t){var r=new THREE.Vector2,o=new THREE.Vector3,n=new THREE.Vector3;return function(e,t){void 0!==e?(r=e,void 0!==t&&t!==!0||i.mouseChange.add(e)):(r.copy(u._panEnd).sub(u._panStart),void 0!==t&&t!==!0||i.mouseChange.add(u._panEnd).sub(u._panStart)),r.lengthSq()&&(r.multiplyScalar(y.length()*u.panSpeed),n.copy(y).cross(u.object.up).setLength(r.x),n.add(o.copy(u.object.up).setLength(r.y)),u.object.position.add(n),u.target.add(n),u.staticMoving?u._panStart.copy(u._panEnd):u._panStart.add(r.subVectors(u._panEnd,u._panStart).multiplyScalar(u.dynamicDampingFactor)))}}(),this.update=function(e){y.subVectors(u.object.position,u.target),u.noRotate||(void 0!==e&&void 0!==e.quaternion?u.rotateCamera(e.quaternion,e.update):u.rotateCamera()),u.noZoom||(void 0!==e&&void 0!==e._zoomFactor?u.zoomCamera(e._zoomFactor,e.update):u.zoomCamera(),u.object.updateProjectionMatrix()),u.noPan||(void 0!==e&&void 0!==e.mouseChange?u.panCamera(e.mouseChange,e.update):u.panCamera()),u.object.position.addVectors(u.target,y),u.object.lookAt(u.target),f.distanceToSquared(u.object.position)>v&&(u.dispatchEvent(w),f.copy(u.object.position))},this.reset=function(){u._state=p.NONE,g=p.NONE,u.target.copy(u.target0),u.object.position.copy(u.position0),u.object.up.copy(u.up0),y.subVectors(u.object.position,u.target),u.object.left=u.left0,u.object.right=u.right0,u.object.top=u.top0,u.object.bottom=u.bottom0,u.object.lookAt(u.target),u.dispatchEvent(w),f.copy(u.object.position)},this.domElement.addEventListener("contextmn",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",d,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",r,!1),window.addEventListener("keyup",o,!1),this.handleResize(),this.update()},THREE.OrthographicTrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrthographicTrackballControls.prototype.constructor=THREE.OrthographicTrackballControls,THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){function e(){if(c===b){var e=new THREE.RenderableObject;return y.push(e),b++,c++,e}return y[c++]}function t(){if(l===C){var e=new THREE.RenderableVertex;return E.push(e),C++,l++,e}return E[l++]}function i(){if(u===T){var e=new THREE.RenderableFace;return w.push(e),T++,u++,e}return w[u++]}function r(){if(m===A){var e=new THREE.RenderableLine;return R.push(e),A++,m++,e}return R[m++]}function o(){if(f===x){var e=new THREE.RenderableSprite;return S.push(e),x++,f++,e}return S[f++]}function n(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function s(e,t){var i=0,r=1,o=e.z+e.w,n=t.z+t.w,s=-e.z+e.w,a=-t.z+t.w;return o>=0&&n>=0&&s>=0&&a>=0||!(o<0&&n<0||s<0&&a<0)&&(o<0?i=Math.max(i,o/(o-n)):n<0&&(r=Math.min(r,o/(o-n))),s<0?i=Math.max(i,s/(s-a)):a<0&&(r=Math.min(r,s/(s-a))),!(r<i)&&(e.lerp(t,i),t.lerp(e,1-r),!0))}var a,c,d,l,h,u,p,m,v,f,g,y=[],b=0,E=[],C=0,w=[],T=0,R=[],A=0,S=[],x=0,H={objects:[],lights:[],elements:[]},_=new THREE.Vector3,I=new THREE.Vector3,D=new THREE.Vector3,O=new THREE.Vector3,L=new THREE.Vector4,M=new THREE.Box3(new THREE.Vector3((-1),(-1),(-1)),new THREE.Vector3(1,1,1)),P=new THREE.Box3,k=new Array(3),N=(new Array(4),new THREE.Matrix4),z=new THREE.Matrix4,j=new THREE.Matrix4,F=new THREE.Matrix3,U=new THREE.Frustum,V=new THREE.Vector4,B=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pkRay=function(e,t){console.error("THREE.Projector: .pkRay() is now raycaster.setFromCamera().")};var G=function(){var e=[],o=[],n=null,s=null,a=new THREE.Matrix3,c=function(t){n=t,s=n.material,a.getNormalMatrix(n.matrixWorld),e.length=0,o.length=0},l=function(e){var t=e.position,i=e.positionWorld,r=e.positionScreen;i.copy(t).applyMatrix4(g),r.copy(i).applyMatrix4(z);var o=1/r.w;r.x*=o,r.y*=o,r.z*=o,e.visible=r.x>=-1&&r.x<=1&&r.y>=-1&&r.y<=1&&r.z>=-1&&r.z<=1},u=function(e,i,r){d=t(),d.position.set(e,i,r),l(d)},m=function(t,i,r){e.push(t,i,r)},v=function(e,t){o.push(e,t)},f=function(e,t,i){return e.visible===!0||t.visible===!0||i.visible===!0||(k[0]=e.positionScreen,k[1]=t.positionScreen,k[2]=i.positionScreen,M.isIntersectionBox(P.setFromPoints(k)))},y=function(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0},b=function(e,t){var i=E[e],o=E[t];p=r(),p.id=n.id,p.v1.copy(i),p.v2.copy(o),p.z=(i.positionScreen.z+o.positionScreen.z)/2,p.material=n.material,H.elements.push(p)},C=function(t,r,c){var d=E[t],l=E[r],u=E[c];if(f(d,l,u)!==!1&&(s.side===THREE.DoubleSide||y(d,l,u)===!0)){h=i(),h.id=n.id,h.v1.copy(d),h.v2.copy(l),h.v3.copy(u),h.z=(d.positionScreen.z+l.positionScreen.z+u.positionScreen.z)/3;for(var p=0;p<3;p++){var m=3*arguments[p],v=h.vertexNormalsModel[p];v.set(e[m],e[m+1],e[m+2]),v.applyMatrix3(a).normalize();var g=2*arguments[p],b=h.uvs[p];b.set(o[g],o[g+1])}h.vertexNormalsLength=3,h.material=n.material,H.elements.push(h)}};return{setObject:c,projectVertex:l,checkTriangleVisibility:f,checkBackfaceCulling:y,pushVertex:u,pushNormal:m,pushUv:v,pushLine:b,pushTriangle:C}},q=new G;this.projectScene=function(d,y,b,C){u=0,m=0,f=0,H.elements.length=0,d.autoUpdate===!0&&d.updateMatrixWorld(),void 0===y.parent&&y.updateMatrixWorld(),N.copy(y.matrixWorldInverse.getInverse(y.matrixWorld)),z.multiplyMatrices(y.projectionMatrix,N),U.setFromMatrix(z),c=0,H.objects.length=0,H.lights.length=0,d.traverseVisible(function(t){if(t instanceof THREE.Light)H.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Sprite){if(t.material.visible===!1)return;t.frustumCulled!==!1&&U.intersectsObject(t)!==!0||(a=e(),a.id=t.id,a.object=t,O.setFromMatrixPosition(t.matrixWorld),O.applyProjection(z),a.z=O.z,H.objects.push(a))}}),b===!0&&H.objects.sort(n);for(var w=0,T=H.objects.length;w<T;w++){var R=H.objects[w].object,A=R.geometry;if(q.setObject(R),g=R.matrixWorld,l=0,R instanceof THREE.Mesh){if(A instanceof THREE.BufferGeometry){var S=A.attributes,x=A.offsets;if(void 0===S.position)continue;for(var M=S.position.array,P=0,k=M.length;P<k;P+=3)q.pushVertex(M[P],M[P+1],M[P+2]);if(void 0!==S.normal)for(var G=S.normal.array,P=0,k=G.length;P<k;P+=3)q.pushNormal(G[P],G[P+1],G[P+2]);if(void 0!==S.uv)for(var W=S.uv.array,P=0,k=W.length;P<k;P+=2)q.pushUv(W[P],W[P+1]);if(void 0!==S.index){var $=S.index.array;if(x.length>0)for(var w=0;w<x.length;w++)for(var Y=x[w],X=Y.index,P=Y.start,k=Y.start+Y.count;P<k;P+=3)q.pushTriangle($[P]+X,$[P+1]+X,$[P+2]+X);else for(var P=0,k=$.length;P<k;P+=3)q.pushTriangle($[P],$[P+1],$[P+2])}else for(var P=0,k=M.length/3;P<k;P+=3)q.pushTriangle(P,P+1,P+2)}else if(A instanceof THREE.Geometry){var Q=A.vertices,Z=A.faces,K=A.faceVertexUvs[0];F.getNormalMatrix(g);for(var J=R.material instanceof THREE.MeshFaceMaterial,ee=J===!0?R.material:null,te=0,ie=Q.length;te<ie;te++){var re=Q[te];q.pushVertex(re.x,re.y,re.z)}for(var oe=0,ne=Z.length;oe<ne;oe++){var se=Z[oe],ae=J===!0?ee.materials[se.materialIndex]:R.material;if(void 0!==ae){var ce=ae.side,de=E[se.a],le=E[se.b],he=E[se.c];if(ae.morphTargets===!0){var ue=A.morphTargets,pe=R.morphTargetInfluences,me=de.position,ve=le.position,fe=he.position;_.set(0,0,0),I.set(0,0,0),D.set(0,0,0);for(var ge=0,ye=ue.length;ge<ye;ge++){var be=pe[ge];if(0!==be){var Ee=ue[ge].vertices;_.x+=(Ee[se.a].x-me.x)*be,_.y+=(Ee[se.a].y-me.y)*be,_.z+=(Ee[se.a].z-me.z)*be,I.x+=(Ee[se.b].x-ve.x)*be,I.y+=(Ee[se.b].y-ve.y)*be,I.z+=(Ee[se.b].z-ve.z)*be,D.x+=(Ee[se.c].x-fe.x)*be,D.y+=(Ee[se.c].y-fe.y)*be,D.z+=(Ee[se.c].z-fe.z)*be}}de.position.add(_),le.position.add(I),he.position.add(D),q.projectVertex(de),q.projectVertex(le),q.projectVertex(he)}if(q.checkTriangleVisibility(de,le,he)!==!1){var Ce=q.checkBackfaceCulling(de,le,he);if(ce!==THREE.DoubleSide){if(ce===THREE.FrontSide&&Ce===!1)continue;if(ce===THREE.BackSide&&Ce===!0)continue}h=i(),h.id=R.id,h.v1.copy(de),h.v2.copy(le),h.v3.copy(he),h.normalModel.copy(se.normal),Ce!==!1||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||h.normalModel.negate(),h.normalModel.applyMatrix3(F).normalize();for(var we=se.vertexNormals,Te=0,Re=Math.min(we.length,3);Te<Re;Te++){var Ae=h.vertexNormalsModel[Te];Ae.copy(we[Te]),Ce!==!1||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||Ae.negate(),Ae.applyMatrix3(F).normalize()}h.vertexNormalsLength=we.length;var Se=K[oe];if(void 0!==Se)for(var xe=0;xe<3;xe++)h.uvs[xe].copy(Se[xe]);h.color=se.color,h.material=ae,h.z=(de.positionScreen.z+le.positionScreen.z+he.positionScreen.z)/3,H.elements.push(h)}}}}}else if(R instanceof THREE.Line){if(A instanceof THREE.BufferGeometry){var S=A.attributes;if(void 0!==S.position){for(var M=S.position.array,P=0,k=M.length;P<k;P+=3)q.pushVertex(M[P],M[P+1],M[P+2]);if(void 0!==S.index)for(var $=S.index.array,P=0,k=$.length;P<k;P+=2)q.pushLine($[P],$[P+1]);else for(var He=R.mode===THREE.LinePieces?2:1,P=0,k=M.length/3-1;P<k;P+=He)q.pushLine(P,P+1)}}else if(A instanceof THREE.Geometry){j.multiplyMatrices(z,g);var Q=R.geometry.vertices;if(0===Q.length)continue;de=t(),de.positionScreen.copy(Q[0]).applyMatrix4(j);for(var He=R.mode===THREE.LinePieces?2:1,te=1,ie=Q.length;te<ie;te++)de=t(),de.positionScreen.copy(Q[te]).applyMatrix4(j),(te+1)%He>0||(le=E[l-2],V.copy(de.positionScreen),B.copy(le.positionScreen),s(V,B)===!0&&(V.multiplyScalar(1/V.w),B.multiplyScalar(1/B.w),p=r(),p.id=R.id,p.v1.positionScreen.copy(V),p.v2.positionScreen.copy(B),p.z=Math.max(V.z,B.z),p.material=R.material,R.material.vertexColors===THREE.VertexColors&&(p.vertexColors[0].copy(R.geometry.colors[te]),p.vertexColors[1].copy(R.geometry.colors[te-1])),H.elements.push(p)))}}else if(R instanceof THREE.Sprite){L.set(g.elements[12],g.elements[13],g.elements[14],1),L.applyMatrix4(z);var _e=1/L.w;L.z*=_e,L.z>=-1&&L.z<=1&&(v=o(),v.id=R.id,v.x=L.x*_e,v.y=L.y*_e,v.z=L.z,v.object=R,v.rotation=R.rotation,v.scale.x=R.scale.x*Math.abs(v.x-(L.x+y.projectionMatrix.elements[0])/(L.w+y.projectionMatrix.elements[12])),v.scale.y=R.scale.y*Math.abs(v.y-(L.y+y.projectionMatrix.elements[5])/(L.w+y.projectionMatrix.elements[13])),v.material=R.material,H.elements.push(v))}}return C===!0&&H.elements.sort(n),H}},!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.MMTF=e.MMTF||{})}(this,function(e){"use strict";function t(e,t,i){for(var r=(e.byteLength,0),o=i.length;o>r;r++){var n=i.charCodeAt(r);if(128>n)e.setUint8(t++,n>>>0&127|0);else if(2048>n)e.setUint8(t++,n>>>6&31|192),e.setUint8(t++,n>>>0&63|128);else if(65536>n)e.setUint8(t++,n>>>12&15|224),e.setUint8(t++,n>>>6&63|128),e.setUint8(t++,n>>>0&63|128);else{if(!(1114112>n))throw new Error("bad codepoint "+n);e.setUint8(t++,n>>>18&7|240),e.setUint8(t++,n>>>12&63|128),e.setUint8(t++,n>>>6&63|128),e.setUint8(t++,n>>>0&63|128)}}}function i(e){for(var t=0,i=0,r=e.length;r>i;i++){var o=e.charCodeAt(i);if(128>o)t+=1;else if(2048>o)t+=2;else if(65536>o)t+=3;else{if(!(1114112>o))throw new Error("bad codepoint "+o);t+=4}}return t}function r(e,o,n){var s=typeof e;if("string"===s){var a=i(e);if(32>a)return o.setUint8(n,160|a),t(o,n+1,e),1+a;if(256>a)return o.setUint8(n,217),o.setUint8(n+1,a),t(o,n+2,e),2+a;if(65536>a)return o.setUint8(n,218),o.setUint16(n+1,a),t(o,n+3,e),3+a;if(4294967296>a)return o.setUint8(n,219),o.setUint32(n+1,a),t(o,n+5,e),5+a}if(e instanceof Uint8Array){var a=e.byteLength,c=new Uint8Array(o.buffer);if(256>a)return o.setUint8(n,196),o.setUint8(n+1,a),c.set(e,n+2),2+a;if(65536>a)return o.setUint8(n,197),o.setUint16(n+1,a),c.set(e,n+3),3+a;if(4294967296>a)return o.setUint8(n,198),o.setUint32(n+1,a),c.set(e,n+5),5+a}if("number"===s){if(!isFinite(e))throw new Error("Number not finite: "+e);if(Math.floor(e)!==e)return o.setUint8(n,203),o.setFloat64(n+1,e),9;if(e>=0){if(128>e)return o.setUint8(n,e),1;if(256>e)return o.setUint8(n,204),o.setUint8(n+1,e),2;if(65536>e)return o.setUint8(n,205),o.setUint16(n+1,e),3;if(4294967296>e)return o.setUint8(n,206),o.setUint32(n+1,e),5;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return o.setInt8(n,e),1;if(e>=-128)return o.setUint8(n,208),o.setInt8(n+1,e),2;if(e>=-32768)return o.setUint8(n,209),o.setInt16(n+1,e),3;if(e>=-2147483648)return o.setUint8(n,210),o.setInt32(n+1,e),5;throw new Error("Number too small -0x"+(-e).toString(16).substr(1))}if(null===e)return o.setUint8(n,192),1;if("boolean"===s)return o.setUint8(n,e?195:194),1;if("object"===s){var a,d=0,l=Array.isArray(e);if(l)a=e.length;else{var h=Object.keys(e);a=h.length}var d;if(16>a?(o.setUint8(n,a|(l?144:128)),d=1):65536>a?(o.setUint8(n,l?220:222),o.setUint16(n+1,a),d=3):4294967296>a&&(o.setUint8(n,l?221:223),o.setUint32(n+1,a),d=5),l)for(var u=0;a>u;u++)d+=r(e[u],o,n+d);else for(var u=0;a>u;u++){var p=h[u];d+=r(p,o,n+d),d+=r(e[p],o,n+d)}return d}throw new Error("Unknown type "+s)}function o(e){var t=typeof e;if("string"===t){var r=i(e);if(32>r)return 1+r;if(256>r)return 2+r;if(65536>r)return 3+r;if(4294967296>r)return 5+r}if(e instanceof Uint8Array){var r=e.byteLength;if(256>r)return 2+r;if(65536>r)return 3+r;if(4294967296>r)return 5+r}if("number"===t){if(Math.floor(e)!==e)return 9;if(e>=0){if(128>e)return 1;if(256>e)return 2;if(65536>e)return 3;if(4294967296>e)return 5;throw new Error("Number too big 0x"+e.toString(16))}if(e>=-32)return 1;if(e>=-128)return 2;if(e>=-32768)return 3;if(e>=-2147483648)return 5;throw new Error("Number too small -0x"+e.toString(16).substr(1))}if("boolean"===t||null===e)return 1;if("object"===t){var r,n=0;if(Array.isArray(e)){r=e.length;for(var s=0;r>s;s++)n+=o(e[s])}else{var a=Object.keys(e);r=a.length;for(var s=0;r>s;s++){var c=a[s];n+=o(c)+o(e[c])}}if(16>r)return 1+n;if(65536>r)return 3+n;if(4294967296>r)return 5+n;throw new Error("Array or object too long 0x"+r.toString(16))}throw new Error("Unknown type "+t)}function n(e){var t=new ArrayBuffer(o(e)),i=new DataView(t);return r(e,i,0),new Uint8Array(t)}function s(e,t,i){return t?new e(t.buffer,t.byteOffset,t.byteLength/(i||1)):void 0}function a(e){return s(DataView,e)}function c(e){return s(Uint8Array,e)}function d(e){return s(Int8Array,e)}function l(e){return s(Int32Array,e,4)}function h(e){return s(Float32Array,e,4);
}function u(e,t){var i=e.length/2;t||(t=new Int16Array(i));for(var r=0,o=0;i>r;++r,o+=2)t[r]=e[o]<<8^e[o+1]<<0;return t}function p(e,t){var i=e.length;t||(t=new Uint8Array(2*i));for(var r=a(t),o=0;i>o;++o)r.setInt16(2*o,e[o]);return c(t)}function m(e,t){var i=e.length/4;t||(t=new Int32Array(i));for(var r=0,o=0;i>r;++r,o+=4)t[r]=e[o]<<24^e[o+1]<<16^e[o+2]<<8^e[o+3]<<0;return t}function v(e,t){var i=e.length;t||(t=new Uint8Array(4*i));for(var r=a(t),o=0;i>o;++o)r.setInt32(4*o,e[o]);return c(t)}function f(e,t){var i=e.length;t||(t=new Float32Array(i/4));for(var r=a(t),o=a(e),n=0,s=0,c=i/4;c>n;++n,s+=4)r.setFloat32(s,o.getFloat32(s),!0);return t}function g(e,t,i){var r=e.length,o=1/t;i||(i=new Float32Array(r));for(var n=0;r>n;++n)i[n]=e[n]*o;return i}function y(e,t,i){var r=e.length;i||(i=new Int32Array(r));for(var o=0;r>o;++o)i[o]=Math.round(e[o]*t);return i}function b(e,t){var i,r;if(!t){var o=0;for(i=0,r=e.length;r>i;i+=2)o+=e[i+1];t=new e.constructor(o)}var n=0;for(i=0,r=e.length;r>i;i+=2)for(var s=e[i],a=e[i+1],c=0;a>c;++c)t[n]=s,++n;return t}function E(e){if(0===e.length)return new Int32Array;var t,i,r=2;for(t=1,i=e.length;i>t;++t)e[t-1]!==e[t]&&(r+=2);var o=new Int32Array(r),n=0,s=1;for(t=1,i=e.length;i>t;++t)e[t-1]!==e[t]?(o[n]=e[t-1],o[n+1]=s,s=1,n+=2):++s;return o[n]=e[e.length-1],o[n+1]=s,o}function C(e,t){var i=e.length;t||(t=new e.constructor(i)),i&&(t[0]=e[0]);for(var r=1;i>r;++r)t[r]=e[r]+t[r-1];return t}function w(e,t){var i=e.length;t||(t=new e.constructor(i)),t[0]=e[0];for(var r=1;i>r;++r)t[r]=e[r]-e[r-1];return t}function T(e,t){var i,r,o=e instanceof Int8Array?127:32767,n=-o-1,s=e.length;if(!t){var a=0;for(i=0;s>i;++i)e[i]<o&&e[i]>n&&++a;t=new Int32Array(a)}for(i=0,r=0;s>i;){for(var c=0;e[i]===o||e[i]===n;)c+=e[i],++i;c+=e[i],++i,t[r]=c,++r}return t}function R(e,t){var i,r=t?127:32767,o=-r-1,n=e.length,s=0;for(i=0;n>i;++i){var a=e[i];0===a?++s:a>0?(s+=Math.ceil(a/r),a%r===0&&(s+=1)):(s+=Math.ceil(a/o),a%o===0&&(s+=1))}var c=t?new Int8Array(s):new Int16Array(s),d=0;for(i=0;n>i;++i){var a=e[i];if(a>=0)for(;a>=r;)c[d]=r,++d,a-=r;else for(;o>=a;)c[d]=o,++d,a-=o;c[d]=a,++d}return c}function A(e,t){return C(b(e),t)}function S(e){return E(w(e))}function x(e,t,i){return g(b(e,l(i)),t,i)}function H(e,t){return E(y(e,t))}function _(e,t,i){return g(C(e,l(i)),t,i)}function I(e,t,i){return w(y(e,t),i)}function D(e,t,i){return g(T(e,l(i)),t,i)}function O(e,t,i){var r=T(e,l(i));return _(r,t,h(r))}function L(e,t,i){return R(I(e,t),i)}function M(e){var t=a(e),i=t.getInt32(0),r=t.getInt32(4),o=e.subarray(8,12),e=e.subarray(12);return[i,e,r,o]}function P(e,t,i,r){var o=new ArrayBuffer(12+r.byteLength),n=new Uint8Array(o),s=new DataView(o);return s.setInt32(0,e),s.setInt32(4,t),i&&n.set(i,8),n.set(r,12),n}function k(e){var t=e.length,i=c(e);return P(2,t,void 0,i)}function N(e){var t=e.length,i=v(e);return P(4,t,void 0,i)}function z(e,t){var i=e.length/t,r=v([t]),o=c(e);return P(5,i,r,o)}function j(e){var t=e.length,i=v(E(e));return P(6,t,void 0,i)}function F(e){var t=e.length,i=v(S(e));return P(8,t,void 0,i)}function U(e,t){var i=e.length,r=v([t]),o=v(H(e,t));return P(9,i,r,o)}function V(e,t){var i=e.length,r=v([t]),o=p(L(e,t));return P(10,i,r,o)}function B(e){var t={};return ee.forEach(function(i){void 0!==e[i]&&(t[i]=e[i])}),e.bondAtomList&&(t.bondAtomList=N(e.bondAtomList)),e.bondOrderList&&(t.bondOrderList=k(e.bondOrderList)),t.xCoordList=V(e.xCoordList,1e3),t.yCoordList=V(e.yCoordList,1e3),t.zCoordList=V(e.zCoordList,1e3),e.bFactorList&&(t.bFactorList=V(e.bFactorList,100)),e.atomIdList&&(t.atomIdList=F(e.atomIdList)),e.altLocList&&(t.altLocList=j(e.altLocList)),e.occupancyList&&(t.occupancyList=U(e.occupancyList,100)),t.groupIdList=F(e.groupIdList),t.groupTypeList=N(e.groupTypeList),e.secStructList&&(t.secStructList=k(e.secStructList)),e.insCodeList&&(t.insCodeList=j(e.insCodeList)),e.sequenceIndexList&&(t.sequenceIndexList=F(e.sequenceIndexList)),t.chainIdList=z(e.chainIdList,4),e.chainNameList&&(t.chainNameList=z(e.chainNameList,4)),t}function G(e){function t(e){for(var t={},i=0;e>i;i++){var r=n();t[r]=n()}return t}function i(t){var i=e.subarray(s,s+t);return s+=t,i}function r(t){var i=e.subarray(s,s+t);s+=t;var r=65535;if(t>r){for(var o=[],n=0;n<i.length;n+=r)o.push(String.fromCharCode.apply(null,i.subarray(n,n+r)));return o.join("")}return String.fromCharCode.apply(null,i)}function o(e){for(var t=new Array(e),i=0;e>i;i++)t[i]=n();return t}function n(){var n,c,d=e[s];if(0===(128&d))return s++,d;if(128===(240&d))return c=15&d,s++,t(c);if(144===(240&d))return c=15&d,s++,o(c);if(160===(224&d))return c=31&d,s++,r(c);if(224===(224&d))return n=a.getInt8(s),s++,n;switch(d){case 192:return s++,null;case 194:return s++,!1;case 195:return s++,!0;case 196:return c=a.getUint8(s+1),s+=2,i(c);case 197:return c=a.getUint16(s+1),s+=3,i(c);case 198:return c=a.getUint32(s+1),s+=5,i(c);case 202:return n=a.getFloat32(s+1),s+=5,n;case 203:return n=a.getFloat64(s+1),s+=9,n;case 204:return n=e[s+1],s+=2,n;case 205:return n=a.getUint16(s+1),s+=3,n;case 206:return n=a.getUint32(s+1),s+=5,n;case 208:return n=a.getInt8(s+1),s+=2,n;case 209:return n=a.getInt16(s+1),s+=3,n;case 210:return n=a.getInt32(s+1),s+=5,n;case 217:return c=a.getUint8(s+1),s+=2,r(c);case 218:return c=a.getUint16(s+1),s+=3,r(c);case 219:return c=a.getUint32(s+1),s+=5,r(c);case 220:return c=a.getUint16(s+1),s+=3,o(c);case 221:return c=a.getUint32(s+1),s+=5,o(c);case 222:return c=a.getUint16(s+1),s+=3,t(c);case 223:return c=a.getUint32(s+1),s+=5,t(c)}throw new Error("Unknown type 0x"+d.toString(16))}var s=0,a=new DataView(e.buffer);return n()}function q(e,t,i,r){switch(e){case 1:return f(t);case 2:return d(t);case 3:return u(t);case 4:return m(t);case 5:return c(t);case 6:return b(m(t),new Uint8Array(i));case 7:return b(m(t));case 8:return A(m(t));case 9:return x(m(t),m(r)[0]);case 10:return O(u(t),m(r)[0]);case 11:return g(u(t),m(r)[0]);case 12:return D(u(t),m(r)[0]);case 13:return D(d(t),m(r)[0]);case 14:return T(u(t));case 15:return T(d(t))}}function W(e,t){t=t||{};var i=t.ignoreFields,r={};return ie.forEach(function(t){var o=!!i&&-1!==i.indexOf(t),n=e[t];o||void 0===n||(n instanceof Uint8Array?r[t]=q.apply(null,M(n)):r[t]=n)}),r}function $(e){return String.fromCharCode.apply(null,e).replace(/\0/g,"")}function Y(e,t,i){i=i||{};var r,o,n,s,a,c,d=i.firstModelOnly,l=t.onModel,h=t.onChain,u=t.onGroup,p=t.onAtom,m=t.onBond,v=0,f=0,g=0,y=0,b=0,E=-1,C=e.chainNameList,w=e.secStructList,T=e.insCodeList,R=e.sequenceIndexList,A=e.atomIdList,S=e.bFactorList,x=e.altLocList,H=e.occupancyList,_=e.bondAtomList,I=e.bondOrderList;for(r=0,o=e.chainsPerModel.length;o>r&&!(d&&v>0);++r){var D=e.chainsPerModel[v];for(l&&l({chainCount:D,modelIndex:v}),n=0;D>n;++n){var O=e.groupsPerChain[f];if(h){var L=$(e.chainIdList.subarray(4*f,4*f+4)),M=null;C&&(M=$(C.subarray(4*f,4*f+4))),h({groupCount:O,chainIndex:f,modelIndex:v,chainId:L,chainName:M})}for(s=0;O>s;++s){var P=e.groupList[e.groupTypeList[g]],k=P.atomNameList.length;if(u){var N=null;w&&(N=w[g]);var z=null;e.insCodeList&&(z=String.fromCharCode(T[g]));var j=null;R&&(j=R[g]),u({atomCount:k,groupIndex:g,chainIndex:f,modelIndex:v,groupId:e.groupIdList[g],groupType:e.groupTypeList[g],groupName:P.groupName,singleLetterCode:P.singleLetterCode,chemCompType:P.chemCompType,secStruct:N,insCode:z,sequenceIndex:j})}for(a=0;k>a;++a){if(p){var F=null;A&&(F=A[y]);var U=null;S&&(U=S[y]);var V=null;x&&(V=String.fromCharCode(x[y]));var B=null;H&&(B=H[y]),p({atomIndex:y,groupIndex:g,chainIndex:f,modelIndex:v,atomId:F,element:P.elementList[a],atomName:P.atomNameList[a],formalCharge:P.formalChargeList[a],xCoord:e.xCoordList[y],yCoord:e.yCoordList[y],zCoord:e.zCoordList[y],bFactor:U,altLoc:V,occupancy:B})}y+=1}if(m){var G=P.bondAtomList;for(a=0,c=P.bondOrderList.length;c>a;++a)m({atomIndex1:y-k+G[2*a],atomIndex2:y-k+G[2*a+1],bondOrder:P.bondOrderList[a]})}g+=1}f+=1}if(b=E+1,E=y-1,m&&_)for(a=0,c=_.length;c>a;a+=2){var q=_[a],W=_[a+1];(q>=b&&E>=q||W>=b&&E>=W)&&m({atomIndex1:q,atomIndex2:W,bondOrder:I?I[a/2]:null})}v+=1}}function X(e){return n(B(e))}function Q(e,t){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var i;return i=e instanceof Uint8Array?G(e):e,W(i,t)}function Z(e,t,i,r){function o(){try{var e=Q(n.response);i(e)}catch(t){r(t)}}var n=new XMLHttpRequest;n.addEventListener("load",o,!0),n.addEventListener("error",r,!0),n.responseType="arraybuffer",n.open("GET",t+e.toUpperCase()),n.send()}function K(e,t,i){Z(e,ne,t,i)}function J(e,t,i){Z(e,se,t,i)}var ee=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"],te=["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"],ie=ee.concat(te),re="v1.0.1",oe="//mmtf.rcsb.org/v1.0/",ne=oe+"full/",se=oe+"reduced/";e.encode=X,e.decode=Q,e.traverse=Y,e.fetch=K,e.fetchReduced=J,e.version=re,e.fetchUrl=ne,e.fetchReducedUrl=se,e.encodeMsgpack=n,e.encodeMmtf=B,e.decodeMsgpack=G,e.decodeMmtf=W});var $NGL_shaderTextHash={};if($NGL_shaderTextHash["SphereImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","bool flag2 = false;","bool interior = false;","vec3 cameraPos;","vec3 cameraNormal;","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","bool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){","","    vec3 cameraSpherePos = -vPointViewPosition;","    cameraSpherePos.z += vRadius;","","    vec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );","    vec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );","    vec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );","","    float B = dot( rayDirection, cameraSphereDir );","    float det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );","","    if( det < 0.0 ){","        discard;","        return false;","    }","        float sqrtDet = sqrt( det );","        float posT = mix( B + sqrtDet, B + sqrtDet, ortho );","        float negT = mix( B - sqrtDet, sqrtDet - B, ortho );","","        cameraPos = rayDirection * negT + rayOrigin;","","        #ifdef NEAR_CLIP","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else if( calcClip( cameraPos ) > 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    flag2 = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #else","if( calcDepth( cameraPos ) <= 0.0 ){","    cameraPos = rayDirection * posT + rayOrigin;","    interior = true;","    return false;","}else{","    cameraNormal = normalize( cameraPos - cameraSpherePos );","}","        #endif","","        cameraNormal = normalize( cameraPos - cameraSpherePos );","        cameraNormal *= float(!interior) * 2.0 - 1.0;","         return !interior;","","}","","void main(void){","","    bool flag = Impostor( cameraPos, cameraNormal );","","    #ifdef NEAR_CLIP","        if( calcClip( cameraPos ) > 0.0 )","            discard;","    #endif","","    // FIXME not compatible with custom clipping plane","    //Set the depth based on the new cameraPos.","    gl_FragDepthEXT = calcDepth( cameraPos );","    if( !flag ){","","        // clamp to near clipping plane and add a tiny value to","        // make spheres with a greater radius occlude smaller ones","        #ifdef NEAR_CLIP","if( flag2 ){","    gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","}else if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #else","if( gl_FragDepthEXT >= 0.0 ){","    gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","}","        #endif","","    }","","    // bugfix (mac only?)","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vNormal = cameraNormal;","        vec3 vViewPosition = -cameraPos;","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["SphereImpostor.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","varying float fogDepth;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transpose( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        position.x, position.y, position.z, 1.0","    );","","    mat4 R = transpose( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere();","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.frag"]=["#define STANDARD","#define IMPOSTOR","","// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - custom clipping","// - three.js lighting","","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform mat4 projectionMatrix;","uniform float ortho;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","","#ifdef PICKING","    uniform float objectId;","    varying vec3 vPickingColor;","#else","    varying vec3 vColor1;","    varying vec3 vColor2;","    #include common","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","bool interior = false;","","float distSq3( vec3 v3a, vec3 v3b ){","    return (","        ( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +","        ( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +","        ( v3a.z - v3b.z ) * ( v3a.z - v3b.z )","    );","}","","// Calculate depth based on the given camera position.","float calcDepth( in vec3 cameraPos ){","    vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;","    return 0.5 + 0.5 * clipZW.x / clipZW.y;","}","","float calcClip( vec3 cameraPos ){","    return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, nearClip - 0.5 ) );","}","","void main(){","","    vec3 point = w.xyz / w.w;","","    // unpacking","    vec3 base = base_radius.xyz;","    float vRadius = base_radius.w;","    vec3 end = end_b.xyz;","    float b = end_b.w;","","    vec3 end_cyl = end;","    vec3 surface_point = point;","","    vec3 ray_target = surface_point;","    vec3 ray_origin = vec3(0.0);","    vec3 ray_direction = mix(normalize(ray_origin - ray_target), vec3(0.0, 0.0, 1.0), ortho);","    mat3 basis = mat3( U, V, axis );","","    vec3 diff = ray_target - 0.5 * (base + end_cyl);","    vec3 P = diff * basis;","","    // angle (cos) between cylinder cylinder_axis and ray direction","    float dz = dot( axis, ray_direction );","","    float radius2 = vRadius*vRadius;","","    // calculate distance to the cylinder from ray origin","    vec3 D = vec3(dot(U, ray_direction),","                dot(V, ray_direction),","                dz);","    float a0 = P.x*P.x + P.y*P.y - radius2;","    float a1 = P.x*D.x + P.y*D.y;","    float a2 = D.x*D.x + D.y*D.y;","","    // calculate a dicriminant of the above quadratic equation","    float d = a1*a1 - a0*a2;","    if (d < 0.0)","        // outside of the cylinder","        discard;","","    float dist = (-a1 + sqrt(d)) / a2;","","    // point of intersection on cylinder surface","    vec3 new_point = ray_target + dist * ray_direction;","","    vec3 tmp_point = new_point - base;","    vec3 _normal = normalize( tmp_point - axis * dot(tmp_point, axis) );","","    ray_origin = mix( ray_origin, surface_point, ortho );","","    // test caps","    float front_cap_test = dot( tmp_point, axis );","    float end_cap_test = dot((new_point - end_cyl), axis);","","    // to calculate caps, simply check the angle between","    // the point of intersection - cylinder end vector","    // and a cap plane normal (which is the cylinder cylinder_axis)","    // if the angle < 0, the point is outside of cylinder","    // test front cap","","    #ifndef CAP","        vec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","        vec3 tmp_point2 = new_point2 - base;","    #endif","","    // flat","    if (front_cap_test < 0.0)","    {","        // ray-plane intersection","        float dNV = dot(-axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(-axis, (base)) / dNV;","        vec3 front_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if (dot(front_point - base, front_point-base) > radius2)","            discard;","","        #ifdef CAP","            new_point = front_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(axis, end_cyl) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - end_cyl, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    // test end cap","","","    // flat","    if( end_cap_test > 0.0 )","    {","        // ray-plane intersection","        float dNV = dot(axis, ray_direction);","        if (dNV < 0.0)","            discard;","        float near = dot(axis, end_cyl) / dNV;","        vec3 end_point = ray_direction * near + ray_origin;","        // within the cap radius?","        if( dot(end_point - end_cyl, end_point-base) > radius2 )","            discard;","","        #ifdef CAP","            new_point = end_point;","            _normal = axis;","        #else","            new_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;","            dNV = dot(-axis, ray_direction);","            near = dot(-axis, (base)) / dNV;","            new_point2 = ray_direction * near + ray_origin;","            if (dot(new_point2 - base, new_point2-base) < radius2)","                discard;","            interior = true;","        #endif","    }","","    gl_FragDepthEXT = calcDepth( new_point );","","    #ifdef NEAR_CLIP","        if( calcClip( new_point ) > 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            if( calcClip( new_point ) > 0.0 )","                discard;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( nearClip - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );","            }","        }else if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #else","        if( gl_FragDepthEXT <= 0.0 ){","            dist = (-a1 - sqrt(d)) / a2;","            new_point = ray_target + dist * ray_direction;","            interior = true;","            gl_FragDepthEXT = calcDepth( new_point );","            if( gl_FragDepthEXT >= 0.0 ){","                gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );","            }","        }","    #endif","","    // this is a workaround necessary for Mac","    // otherwise the modified fragment won't clip properly","    if (gl_FragDepthEXT < 0.0)","        discard;","    if (gl_FragDepthEXT > 1.0)","        discard;","","    #ifdef PICKING","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #else","","        vec3 vViewPosition = -new_point;","        vec3 vNormal = _normal;","        vec3 vColor;","","        if( distSq3( new_point, end_cyl ) < distSq3( new_point, base ) ){","            if( b < 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }else{","            if( b > 0.0 ){","                vColor = vColor1;","            }else{","                vColor = vColor2;","            }","        }","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","     //ifdef USE_COLOR","     //diffuseColor.r *= vColor[0];","     //diffuseColor.g *= vColor[1];","     //diffuseColor.b *= vColor[2];","     //endif","        #include roughnessmap_fragment","        #include metalnessmap_fragment","","        // don't use include normal_fragment","        vec3 normal = normalize( vNormal );","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","        //gl_FragColor = vec4( reflectedLight.directSpecular, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","    #endif","","}"].join("\n"),$NGL_shaderTextHash["CylinderImpostor.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","varying float fogDepth;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = position;","    vec3 center = ( position2 + position1 ) / 2.0;","    vec3 dir = normalize( position2 - position1 );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),
$NGL_shaderTextHash["SphereInstancing.frag"]=$NGL_shaderTextHash["SphereImpostor.frag"],$NGL_shaderTextHash["SphereInstancing.vert"]=["uniform mat4 projectionMatrixInverse;","uniform float nearClip;","","varying float vRadius;","varying float vRadiusSq;","varying vec3 vPoint;","varying vec3 vPointViewPosition;","varying float fogDepth;","","attribute vec2 mapping;","//attribute vec3 position;","attribute float radius;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    #include color_pars_vertex","#endif","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","const mat4 D = mat4(","    1.0, 0.0, 0.0, 0.0,","    0.0, 1.0, 0.0, 0.0,","    0.0, 0.0, 1.0, 0.0,","    0.0, 0.0, 0.0, -1.0",");","","mat4 transpose( in mat4 inMatrix ) {","    vec4 i0 = inMatrix[0];","    vec4 i1 = inMatrix[1];","    vec4 i2 = inMatrix[2];","    vec4 i3 = inMatrix[3];","","    mat4 outMatrix = mat4(","        vec4(i0.x, i1.x, i2.x, i3.x),","        vec4(i0.y, i1.y, i2.y, i3.y),","        vec4(i0.z, i1.z, i2.z, i3.z),","        vec4(i0.w, i1.w, i2.w, i3.w)","    );","    return outMatrix;","}","","//------------------------------------------------------------------------------","// Compute point size and center using the technique described in:","// 'GPU-Based Ray-Casting of Quadratic Surfaces'","// by Christian Sigg, Tim Weyrich, Mario Botsch, Markus Gross.","//","// Code based on","/*=========================================================================",""," Program:   Visualization Toolkit"," Module:    Quadrics_fs.glsl and Quadrics_vs.glsl",""," Copyright (c) Ken Martin, Will Schroeder, Bill Lorensen"," All rights reserved."," See Copyright.txt or http://www.kitware.com/Copyright.htm for details.",""," This software is distributed WITHOUT ANY WARRANTY; without even"," the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR"," PURPOSE.  See the above copyright notice for more information.",""," =========================================================================*/","","// .NAME Quadrics_fs.glsl and Quadrics_vs.glsl","// .SECTION Thanks","// <verbatim>","//","//  This file is part of the PointSprites plugin developed and contributed by","//","//  Copyright (c) CSCS - Swiss National Supercomputing Centre","//                EDF - Electricite de France","//","//  John Biddiscombe, Ugo Varetto (CSCS)","//  Stephane Ploix (EDF)","//","// </verbatim>","//","// Contributions by Alexander Rose","// - ported to WebGL","// - adapted to work with quads","void ComputePointSizeAndPositionInClipCoordSphere(vec4 updatePosition){","","    vec2 xbc;","    vec2 ybc;","","    mat4 T = mat4(","        radius, 0.0, 0.0, 0.0,","        0.0, radius, 0.0, 0.0,","        0.0, 0.0, radius, 0.0,","        updatePosition.x, updatePosition.y, updatePosition.z, 1.0","    );","","    mat4 R = transpose( projectionMatrix * modelViewMatrix * T );","    float A = dot( R[ 3 ], D * R[ 3 ] );","    float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );","    float C = dot( R[ 0 ], D * R[ 0 ] );","    xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;","","    A = dot( R[ 3 ], D * R[ 3 ] );","    B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );","    C = dot( R[ 1 ], D * R[ 1 ] );","    ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );","    float sy = abs( ybc[ 0 ] - ybc[ 1 ]  ) * 0.5;","","    gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );","    gl_Position.xy -= mapping * vec2( sx, sy );","    gl_Position.xy *= gl_Position.w;","","}","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(void){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        #include color_vertex","    #endif","","    vRadius = radius * matrixScale( modelViewMatrix );","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition = matrix * vec4(position, 1.0);","","//    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","    vec4 mvPosition = modelViewMatrix * vec4( updatePosition.xyz, 1.0 );","    // avoid clipping, added again in fragment shader","    mvPosition.z -= vRadius;","","//    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );","    ComputePointSizeAndPositionInClipCoordSphere(updatePosition);","","","    vRadiusSq = vRadius * vRadius;","    vec4 vPoint4 = projectionMatrixInverse * gl_Position;","    vPoint = vPoint4.xyz / vPoint4.w;","    vPointViewPosition = -mvPosition.xyz / mvPosition.w;","","}"].join("\n"),$NGL_shaderTextHash["CylinderInstancing.frag"]=$NGL_shaderTextHash["CylinderImpostor.frag"],$NGL_shaderTextHash["CylinderInstancing.vert"]=["// Open-Source PyMOL is Copyright (C) Schrodinger, LLC.","//","//  All Rights Reserved","//","//  Permission to use, copy, modify, distribute, and distribute modified","//  versions of this software and its built-in documentation for any","//  purpose and without fee is hereby granted, provided that the above","//  copyright notice appears in all copies and that both the copyright","//  notice and this permission notice appear in supporting documentation,","//  and that the name of Schrodinger, LLC not be used in advertising or","//  publicity pertaining to distribution of the software without specific,","//  written prior permission.","//","//  SCHRODINGER, LLC DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,","//  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN","//  NO EVENT SHALL SCHRODINGER, LLC BE LIABLE FOR ANY SPECIAL, INDIRECT OR","//  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS","//  OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE","//  OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE","//  USE OR PERFORMANCE OF THIS SOFTWARE.","","// Contributions by Alexander Rose","// - ported to WebGL","// - dual color","// - pk color","// - shift","","attribute vec3 mapping;","attribute vec3 position1;","attribute vec3 position2;","attribute float radius;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","","varying vec3 axis;","varying vec4 base_radius;","varying vec4 end_b;","varying vec3 U;","varying vec3 V;","varying vec4 w;","varying float fogDepth;","","#ifdef PICKING","    #include unpack_clr","    attribute float primitiveId;","    varying vec3 vPickingColor;","#else","    //attribute vec3 color;","    attribute vec3 color2;","    varying vec3 vColor1;","    varying vec3 vColor2;","#endif","","uniform mat4 modelViewMatrixInverse;","uniform float ortho;","","//include matrix_scale","float matrixScale( in mat4 m ){","    vec4 r = m[ 0 ];","    return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );","}","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(){","","    #ifdef PICKING","        vPickingColor = unpackColor( primitiveId );","    #else","        vColor1 = color;","        vColor2 = color2;","    #endif","","    // vRadius = radius;","    base_radius.w = radius * matrixScale( modelViewMatrix );","","    //vec3 center = ( position2 + position1 ) / 2.0;","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition1 = matrix * vec4(position1, 1.0);","    vec4 updatePosition2 = matrix * vec4(position2, 1.0);","    vec3 center = ( updatePosition2.xyz + updatePosition1.xyz ) / 2.0;","","    //vec3 dir = normalize( position2 - position1 );","    vec3 dir = normalize( updatePosition2.xyz - updatePosition1.xyz );","    float ext = length( position2 - position1 ) / 2.0;","","    // using cameraPosition fails on some machines, not sure why","    // vec3 cam_dir = normalize( cameraPosition - mix( center, vec3( 0.0 ), ortho ) );","    vec3 cam_dir;","    if( ortho == 0.0 ){","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;","    }else{","        cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;","    }","    cam_dir = normalize( cam_dir );","","    vec3 ldir;","","    float b = dot( cam_dir, dir );","    end_b.w = b;","    // direction vector looks away, so flip","    if( b < 0.0 )","        ldir = -ext * dir;","    // direction vector already looks in my direction","    else","        ldir = ext * dir;","","    vec3 left = normalize( cross( cam_dir, ldir ) );","    left = radius * left;","    vec3 up = radius * normalize( cross( left, ldir ) );","","    // transform to modelview coordinates","    axis = normalize( normalMatrix * ldir );","    U = normalize( normalMatrix * up );","    V = normalize( normalMatrix * left );","","    vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );","    base_radius.xyz = base4.xyz / base4.w;","","    vec4 top_position = modelViewMatrix * vec4( center + ldir, 1.0 );","    vec4 end4 = top_position;","    end_b.xyz = end4.xyz / end4.w;","","    w = modelViewMatrix * vec4(","        center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0","    );","","    gl_Position = projectionMatrix * w;","","    // avoid clipping (1.0 seems to induce flickering with some drivers)","    gl_Position.z = 0.99;","","}"].join("\n"),$NGL_shaderTextHash["Instancing.frag"]=["#define STANDARD","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float nearClip;","uniform float clipRadius;","uniform mat4 projectionMatrix;","uniform float ortho;","varying float bCylinder;","","#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","    varying vec3 vViewPosition;","#endif","","#if defined( RADIUS_CLIP )","    varying vec3 vClipCenter;","#endif","","#if defined( PICKING )","    uniform float objectId;","    varying vec3 vPickingColor;","#elif defined( NOLIGHT )","    varying vec3 vColor;","#else","    #ifndef FLAT_SHADED","        varying vec3 vNormal;","    #endif","    #include common","    #include color_pars_fragment","    #include fog_pars_fragment","    #include bsdfs","    #include lights_pars_begin","    #include lights_physical_pars_fragment","#endif","","void main(){","    #include nearclip_fragment","    #include radiusclip_fragment","","    #if defined( PICKING )","","        gl_FragColor = vec4( vPickingColor, objectId );","","    #elif defined( NOLIGHT )","","        gl_FragColor = vec4( vColor, opacity );","","    #else","","        vec4 diffuseColor = vec4( diffuse, opacity );","        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","        vec3 totalEmissiveLight = emissive;","","        #include color_fragment","        #include roughnessmap_fragment","        #include metalnessmap_fragment","        #include normal_flip","        #include normal_fragment_begin","","        //include dull_interior_fragment","","        #include lights_physical_fragment","        //include lights_template","        #include lights_fragment_begin","        #include lights_fragment_end","","        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;","","        #include interior_fragment","","        gl_FragColor = vec4( outgoingLight, diffuseColor.a );","","        #include premultiplied_alpha_fragment","        #include tonemapping_fragment","        #include encodings_fragment","        #include fog_fragment","","        #include opaque_back_fragment","","    #endif","","}"].join("\n"),$NGL_shaderTextHash["Instancing.vert"]=["#define STANDARD","","uniform mat4 projectionMatrixInverse;","uniform float nearClip;","uniform vec3 clipCenter;","attribute vec4 matrix1;","attribute vec4 matrix2;","attribute vec4 matrix3;","attribute vec4 matrix4;","attribute float cylinder;","varying float bCylinder;","","#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","    varying vec3 vViewPosition;","#endif","","#if defined( RADIUS_CLIP )","    varying vec3 vClipCenter;","#endif","","#if defined( PICKING )","    #include unpack_color","    attribute float primitiveId;","    varying vec3 vPickingColor;","#elif defined( NOLIGHT )","    varying vec3 vColor;","#else","    #include color_pars_vertex","    #ifndef FLAT_SHADED","        varying vec3 vNormal;","    #endif","#endif","","#include common","","  mat4 computeMat(vec4 v1, vec4 v2, vec4 v3, vec4 v4) {","    return mat4(","      v1.x, v1.y, v1.z, v1.w,","      v2.x, v2.y, v2.z, v2.w,","      v3.x, v3.y, v3.z, v3.w,","      v4.x, v4.y, v4.z, v4.w","    );","  }","","void main(){","    bCylinder = cylinder;","","    mat4 matrix = computeMat(matrix1, matrix2, matrix3, matrix4);","    vec4 updatePosition = matrix * vec4(position, 1.0);","","    #if defined( PICKING )","        vPickingColor = unpackColor( primitiveId );","    #elif defined( NOLIGHT )","        vColor = color;","    #else","        #include color_vertex","        //include beginnormal_vertex","        //vec3 objectNormal = vec3( normal );","        vec3 objectNormal = vec3(matrix * vec4(normal,0.0));","        #include defaultnormal_vertex","        // Normal computed with derivatives when FLAT_SHADED","        #ifndef FLAT_SHADED","            vNormal = normalize( transformedNormal );","        #endif","    #endif","","    //include begin_vertex","    vec3 transformed = updatePosition.xyz;","    //include project_vertex","    vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );","    gl_Position = projectionMatrix * mvPosition;","","    #if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )","        vViewPosition = -mvPosition.xyz;","    #endif","","    #if defined( RADIUS_CLIP )","        vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;","    #endif","","    #include nearclip_vertex","","}"].join("\n"),"undefined"==typeof jQuery)throw new Error("iCn3D requires jQuery");var iCn3D=function(e){this.id=e,this.container=$("#"+e),this.maxatomcnt=1e5,this.overdraw=0,this.bDrawn=!1,this.bSecondaryStructure=!1,this.bHighlight=1,this.renderOrderPicking=-1,this.ALTERNATE_STRUCTURE=-1,Detector.webgl?(this.renderer=new THREE.WebGLRenderer({canvas:this.container.get(0),antialias:!0,preserveDrawingBuffer:!0,sortObjects:!1,alpha:!0}),this.overdraw=0):alert("Currently your web browser has a problem on WebGL. If you are using Chrome, open a new tab for the same URL and WebGL may work again."),this.matShader=this.setOutlineColor("yellow"),this.frac=new THREE.Color(.1,.1,.1),this.scaleFactor=1.5,this.bImpo=!0,this.bExtFragDepth=this.renderer.extensions.get("EXT_frag_depth"),this.bExtFragDepth?console.log("EXT_frag_depth is supported. All spheres and cylinders are drawn using shaders."):(this.bImpo=!1,console.log("EXT_frag_depth is NOT supported. All spheres and cylinders are drawn using geometry.")),this.bInstanced=this.renderer.extensions.get("ANGLE_instanced_arrays"),this.bInstanced?console.log("ANGLE_instanced_arrays is supported. Assembly is drawn with one copy of the asymmetric unit using hardware instancing."):console.log("ANGLE_instanced_arrays is NOT supported. Assembly is drawn by making copies of the asymmetric unit."),this.posArray=new Array,this.colorArray=new Array,this.pos2Array=new Array,this.color2Array=new Array,this.radiusArray=new Array,this.posArraySphere=new Array,this.colorArraySphere=new Array,this.radiusArraySphere=new Array,this.WIDTH=this.container.width(),this.HEIGHT=this.container.height(),this.setWidthHeight(this.WIDTH,this.HEIGHT),this.axis=!1,this.pk=1,this.highlightlevel=1,this.pickpair=!1,this.pAtomNum=0,this.pAtom=void 0,this.pAtom2=void 0,this.bCtrl=!1,this.bShift=!1,this.bStopRotate=!1,this.bCalphaOnly=!1,this.bAllAtoms=!0,this.bConsiderNeighbors=!1,this.bShowCrossResidueBond=!1,this.effects={none:this.renderer},this.maxD=500,this.oriMaxD=this.maxD,this.cam_z=2*this.maxD,this.commands=[],this.optsHistory=[],this.logs=[],this.bRender=!0,this.hColor=new THREE.Color(16776960),this.sphereGeometry=new THREE.SphereGeometry(1,32,32),this.boxGeometry=new THREE.BoxGeometry(1,1,1),this.cylinderGeometry=new THREE.CylinderGeometry(1,1,1,32,1),this.cylinderGeometryOutline=new THREE.CylinderGeometry(1,1,1,32,1,(!0)),this.axisDIV=5,this.strandDIV=6,this.tubeDIV=8,this.nucleicAcidStrandDIV=6,this.linewidth=1,this.hlLineRadius=.1,this.lineRadius=.1,this.coilWidth=.3,this.cylinderRadius=.4,this.traceRadius=.4,this.dotSphereScale=.3,this.sphereRadius=1.5,this.cylinderHelixRadius=1.6,this.ribbonthickness=.2,this.helixSheetWidth=1.3,this.nucleicAcidWidth=.8,this.threshbox=180,this.maxAtoms3DMultiFile=4e4,this.LABELSIZE=30,this.opts={camera:"perspective",background:"transparent",color:"chain",sidec:"nothing",proteins:"ribbon",nucleotides:"nucleotide cartoon",surface:"nothing",wireframe:"no",map:"nothing",mapwireframe:"yes",emmap:"nothing",emmapwireframe:"yes",opacity:"1.0",chemicals:"stick",water:"nothing",ions:"sphere",hbonds:"no",ssbonds:"no",labels:"no",lines:"no",rotationcenter:"molecule center",axis:"no",fog:"no",slab:"no",pk:"residue",nucleotides:"nucleotide cartoon",chemicalbinding:"hide"},this._zoomFactor=1,this.mouseChange=new THREE.Vector2(0,0),this.quaternion=new THREE.Quaternion(0,0,0,1);var t=this;this.container.bind("contextmn",function(e){e.preventDefault()}),t.typetext=!1,$(document).bind("keyup",function(e){16===e.keyCode&&(t.bShift=!1),17!==e.keyCode&&224!==e.keyCode&&91!==e.keyCode||(t.bCtrl=!1)}),$("input[type=text], textarea").focus(function(){t.typetext=!0}),$("input[type=text], textarea").blur(function(){t.typetext=!1}),$(document).bind("keydown",function(e){if((e.shiftKey||16===e.keyCode)&&(t.bShift=!0),(e.ctrlKey||17===e.keyCode||224===e.keyCode||91===e.keyCode)&&(t.bCtrl=!0),t.controls&&(t.bStopRotate=!0,!t.typetext))if(90===e.keyCode){var i={};t.cam===t.perspectiveCamera?i._zoomFactor=.9:t.cam===t.orthographicCamera&&(t._zoomFactor<.1?t._zoomFactor=.1:t._zoomFactor>1&&(t._zoomFactor=1),i._zoomFactor=.8*t._zoomFactor,i._zoomFactor<.1&&(i._zoomFactor=.1)),i.update=!0,t.controls.update(i),t.render()}else if(88===e.keyCode){var i={};t.cam===t.perspectiveCamera?i._zoomFactor=1.03:t.cam===t.orthographicCamera&&(t._zoomFactor>10?t._zoomFactor=10:t._zoomFactor<1&&(t._zoomFactor=1),i._zoomFactor=1.01*t._zoomFactor,i._zoomFactor>10&&(i._zoomFactor=10)),i.update=!0,t.controls.update(i),t.render()}else if(76===e.keyCode){var r=new THREE.Vector3(0,1,0),o=-5/180*Math.PI;t.setRotation(r,o)}else if(74===e.keyCode){var r=new THREE.Vector3(0,1,0),o=5/180*Math.PI;t.setRotation(r,o)}else if(73===e.keyCode){var r=new THREE.Vector3(1,0,0),o=-5/180*Math.PI;t.setRotation(r,o)}else if(77===e.keyCode){var r=new THREE.Vector3(1,0,0),o=5/180*Math.PI;t.setRotation(r,o)}else 65===e.keyCode&&Object.keys(t.structures).length>1&&t.alternateStructures()}),this.container.bind("mouseup touchend",function(e){t.isDragging=!1}),this.container.bind("mousedown",function(e){if(e.preventDefault(),t.isDragging=!0,t.scene){if(t.bStopRotate=!0,t.pk&&(e.altKey||e.ctrlKey||e.shiftKey||18===e.keyCode||16===e.keyCode||17===e.keyCode||224===e.keyCode||91===e.keyCode)){t.highlightlevel=t.pk;var i=!0;t.rayCaster(e,i)}t.controls.handleResize(),t.controls.update(),t.render()}}),this.container.bind("touchstart",function(e){if(e.preventDefault(),t.isDragging=!0,t.scene){t.bStopRotate=!0,$("[id$=popup]").hide();var i=!0;t.rayCaster(e,i),t.controls.handleResize(),t.controls.update(),t.render()}}),this.container.bind("mousemove touchmove",function(e){if(e.preventDefault(),t.scene){$("[id$=popup]").hide();var i=!1;t.rayCaster(e,i),t.isDragging&&(t.controls.handleResize(),t.controls.update(),t.render())}}),this.container.bind("mousewheel",function(e){e.preventDefault(),t.scene&&(t.bStopRotate=!0,t.controls.handleResize(),t.controls.update(),t.render())}),this.container.bind("DOMMouseScroll",function(e){e.preventDefault(),t.scene&&(t.bStopRotate=!0,t.controls.handleResize(),t.controls.update(),t.render())})};iCn3D.prototype={constructor:iCn3D,rayCaster:function(e,t){var i=this,r=e.pageX,o=e.pageY;e.originalEvent.targetTouches&&e.originalEvent.targetTouches[0]&&(r=e.originalEvent.targetTouches[0].pageX,o=e.originalEvent.targetTouches[0].pageY);var n=r-i.container.offset().left,s=o-i.container.offset().top;i.mouse.x=(r-i.container.offset().left)/i.container.width()*2-1,i.mouse.y=2*-((o-i.container.offset().top)/i.container.height())+1;var a=new THREE.Vector3;a.x=i.mouse.x,a.y=i.mouse.y,this.cam_z>0?a.z=-1:a.z=1,i.cam===i.perspectiveCamera?(this.cam_z>0?a.z=-1:a.z=1,a.unproject(i.cam),i.raycaster.set(i.cam.position,a.sub(i.cam.position).normalize())):i.cam===i.orthographicCamera&&(this.cam_z>0?a.z=1:a.z=-1,a.unproject(i.cam),i.raycaster.set(a,new THREE.Vector3(0,0,(-1)).transformDirection(i.cam.matrixWorld)));var c=i.raycaster.intersectObjects(i.objects),d=!1,l=i.mdl.position;if(c.length>0){c[0].point.sub(l);for(var h=.5,u=i.getAtomsFromPosition(c[0].point,h);!u&&h<10;)h+=.5,u=i.getAtomsFromPosition(c[0].point,h);u?(d=!0,i.pickpair?t&&(i.pAtomNum%2===0?i.pAtom=u:i.pAtom2=u,++i.pAtomNum):i.pAtom=u,t?i.showPicking(u):i.showPicking(u,n,s)):console.log("No atoms were found in 10 andstrom range")}if(!d&&(c=i.raycaster.intersectObjects(i.objects_ghost),l=i.mdl_ghost.position,c.length>0)){c[0].point.sub(l);for(var h=.5,u=i.getAtomsFromPosition(c[0].point,h);!u&&h<10;)h+=.5,u=i.getAtomsFromPosition(c[0].point,h);u?(i.pickpair?t&&(i.pAtomNum%2===0?i.pAtom=u:i.pAtom2=u,++i.pAtomNum):i.pAtom=u,t?i.showPicking(u):i.showPicking(u,n,s)):console.log("No atoms were found in 10 andstrom range")}},setRotation:function(e,t){var i=this;e.applyQuaternion(i.cam.quaternion).normalize();var r=new THREE.Quaternion;r.setFromAxisAngle(e,-t);var o={};o.quaternion=r,o.update=!0,i.controls.update(o),i.render()},setOutlineColor:function(e){var t={outline:{vertex_shader:["uniform float offset;","void main() {","vec4 pos = modelViewMatrix * vec4( position + normal * offset, 1.0 );","gl_Position = projectionMatrix * pos;","}"].join("\n"),fragment_shader:["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}};"yellow"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"green"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 0.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"red"===e&&(t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}"].join("\n"));var i={offset:{type:"f",value:.5}},r=t.outline,o=new THREE.ShaderMaterial({uniforms:i,vertexShader:r.vertex_shader,fragmentShader:r.fragment_shader,depthTest:!1,depthWrite:!1,needsUpdate:!0});return o},setWidthHeight:function(e,t){this.renderer.setSize(e*this.scaleFactor,t*this.scaleFactor),this.renderer.domElement.style.width=e+"px",this.renderer.domElement.style.height=t+"px",this.renderer.domElement.width=e*this.scaleFactor,this.renderer.domElement.height=t*this.scaleFactor,this.container.widthInv=1/(this.scaleFactor*e),this.container.heightInv=1/(this.scaleFactor*t),this.container.whratio=e/t},nucleotidesArray:["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU"],ionsArray:["  K"," NA"," MG"," AL"," CA"," TI"," MN"," FE"," NI"," CU"," ZN"," AG"," BA","  F"," CL"," BR","  I"],vdwRadii:{H:1.08,HE:1.34,LI:1.75,BE:2.05,B:1.47,C:1.49,N:1.41,O:1.4,F:1.39,NE:1.68,NA:1.84,MG:2.05,AL:2.11,SI:2.07,P:1.92,S:1.82,CL:1.83,AR:1.93,K:2.05,CA:2.21,SC:2.16,TI:1.87,V:1.79,CR:1.89,MN:1.97,FE:1.94,CO:1.92,NI:1.84,CU:1.86,ZN:2.1,GA:2.08,GE:2.15,AS:2.06,SE:1.93,BR:1.98,KR:2.12,RB:2.16,SR:2.24,Y:2.19,ZR:1.86,NB:2.07,MO:2.09,TC:2.09,RU:2.07,RH:1.95,PD:2.02,AG:2.03,CD:2.3,IN:2.36,SN:2.33,SB:2.25,TE:2.23,I:2.23,XE:2.21,CS:2.22,BA:2.51,LA:2.4,CE:2.35,PR:2.39,ND:2.29,PM:2.36,SM:2.29,EU:2.33,GD:2.37,TB:2.21,DY:2.29,HO:2.16,ER:2.35,TM:2.27,YB:2.42,LU:2.21,HF:2.12,TA:2.17,W:2.1,RE:2.17,OS:2.16,IR:2.02,PT:2.09,AU:2.17,HG:2.09,TL:2.35,PB:2.32,BI:2.43,PO:2.29,AT:2.36,RN:2.43,FR:2.56,RA:2.43,AC:2.6,TH:2.37,PA:2.43,U:2.4,NP:2.21,PU:2.56,AM:2.56,CM:2.56,BK:2.56,CF:2.56,ES:2.56,FM:2.56},covalentRadii:{H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},atomColors:{H:new THREE.Color(16777215),He:new THREE.Color(16761035),HE:new THREE.Color(16761035),Li:new THREE.Color(11674146),LI:new THREE.Color(11674146),B:new THREE.Color(65280),C:new THREE.Color(13158600),N:new THREE.Color(9408511),O:new THREE.Color(15728640),F:new THREE.Color(14329120),Na:new THREE.Color(255),NA:new THREE.Color(255),Mg:new THREE.Color(2263842),MG:new THREE.Color(2263842),Al:new THREE.Color(8421520),AL:new THREE.Color(8421520),Si:new THREE.Color(14329120),SI:new THREE.Color(14329120),P:new THREE.Color(16753920),S:new THREE.Color(16762930),Cl:new THREE.Color(65280),CL:new THREE.Color(65280),Ca:new THREE.Color(8421520),CA:new THREE.Color(8421520),Ti:new THREE.Color(8421520),TI:new THREE.Color(8421520),Cr:new THREE.Color(8421520),CR:new THREE.Color(8421520),Mn:new THREE.Color(8421520),MN:new THREE.Color(8421520),Fe:new THREE.Color(16753920),FE:new THREE.Color(16753920),Ni:new THREE.Color(10824234),NI:new THREE.Color(10824234),Cu:new THREE.Color(10824234),CU:new THREE.Color(10824234),Zn:new THREE.Color(10824234),ZN:new THREE.Color(10824234),Br:new THREE.Color(10824234),BR:new THREE.Color(10824234),Ag:new THREE.Color(8421520),AG:new THREE.Color(8421520),I:new THREE.Color(10494192),Ba:new THREE.Color(16753920),BA:new THREE.Color(16753920),Au:new THREE.Color(14329120),AU:new THREE.Color(14329120)},defaultAtomColor:new THREE.Color(13421772),stdChainColors:[new THREE.Color(16711935),new THREE.Color(255),new THREE.Color(10053171),new THREE.Color(65433),new THREE.Color(16750848),new THREE.Color(16737894),new THREE.Color(3329330),new THREE.Color(2003199),new THREE.Color(16416882),new THREE.Color(16753920),new THREE.Color(52945),new THREE.Color(16738740),new THREE.Color(65280),new THREE.Color(255),new THREE.Color(16711680),new THREE.Color(16776960),new THREE.Color(65535),new THREE.Color(16711935),new THREE.Color(3978097),new THREE.Color(4620980),new THREE.Color(13458524),new THREE.Color(16770229),new THREE.Color(11529966),new THREE.Color(15631086),new THREE.Color(25600),new THREE.Color(139),new THREE.Color(9109504),new THREE.Color(13468991),new THREE.Color(35723),new THREE.Color(9699539)],backgroundColors:{black:new THREE.Color(0),grey:new THREE.Color(13421772),white:new THREE.Color(16777215),transparent:new THREE.Color(0)},residueColors:{ALA:new THREE.Color(13158600),ARG:new THREE.Color(1334015),ASN:new THREE.Color(56540),ASP:new THREE.Color(15075850),CYS:new THREE.Color(15132160),GLN:new THREE.Color(56540),GLU:new THREE.Color(15075850),GLY:new THREE.Color(15461355),HIS:new THREE.Color(8553170),ILE:new THREE.Color(1016335),LEU:new THREE.Color(1016335),LYS:new THREE.Color(1334015),MET:new THREE.Color(15132160),PHE:new THREE.Color(3289770),PRO:new THREE.Color(14456450),SER:new THREE.Color(16422400),THR:new THREE.Color(16422400),TRP:new THREE.Color(11819700),TYR:new THREE.Color(3289770),VAL:new THREE.Color(1016335),ASX:new THREE.Color(16738740),GLX:new THREE.Color(16738740),G:new THREE.Color(32768),A:new THREE.Color(6324479),T:new THREE.Color(16744448),C:new THREE.Color(16711680),U:new THREE.Color(16744448),DG:new THREE.Color(32768),DA:new THREE.Color(6324479),DT:new THREE.Color(16744448),DC:new THREE.Color(16711680),DU:new THREE.Color(16744448)},defaultResidueColor:new THREE.Color(12492910),chargeColors:{"  G":new THREE.Color(16711680),"  A":new THREE.Color(16711680),"  T":new THREE.Color(16711680),"  C":new THREE.Color(16711680),"  U":new THREE.Color(16711680)," DG":new THREE.Color(16711680)," DA":new THREE.Color(16711680)," DT":new THREE.Color(16711680)," DC":new THREE.Color(16711680)," DU":new THREE.Color(16711680),G:new THREE.Color(16711680),A:new THREE.Color(16711680),T:new THREE.Color(16711680),C:new THREE.Color(16711680),U:new THREE.Color(16711680),DG:new THREE.Color(16711680),DA:new THREE.Color(16711680),DT:new THREE.Color(16711680),DC:new THREE.Color(16711680),DU:new THREE.Color(16711680),ARG:new THREE.Color(255),LYS:new THREE.Color(255),ASP:new THREE.Color(16711680),GLU:new THREE.Color(16711680),GLY:new THREE.Color(8947848),PRO:new THREE.Color(8947848),ALA:new THREE.Color(8947848),VAL:new THREE.Color(8947848),LEU:new THREE.Color(8947848),ILE:new THREE.Color(8947848),PHE:new THREE.Color(8947848),HIS:new THREE.Color(8947848),SER:new THREE.Color(8947848),THR:new THREE.Color(8947848),ASN:new THREE.Color(8947848),GLN:new THREE.Color(8947848),TYR:new THREE.Color(8947848),MET:new THREE.Color(8947848),CYS:new THREE.Color(8947848),TRP:new THREE.Color(8947848)},hydrophobicColors:{"  G":new THREE.Color(8947848),"  A":new THREE.Color(8947848),"  T":new THREE.Color(8947848),"  C":new THREE.Color(8947848),"  U":new THREE.Color(8947848)," DG":new THREE.Color(8947848)," DA":new THREE.Color(8947848)," DT":new THREE.Color(8947848)," DC":new THREE.Color(8947848)," DU":new THREE.Color(8947848),G:new THREE.Color(8947848),A:new THREE.Color(8947848),T:new THREE.Color(8947848),C:new THREE.Color(8947848),U:new THREE.Color(8947848),DG:new THREE.Color(8947848),DA:new THREE.Color(8947848),DT:new THREE.Color(8947848),DC:new THREE.Color(8947848),DU:new THREE.Color(8947848),ARG:new THREE.Color(8947848),LYS:new THREE.Color(8947848),ASP:new THREE.Color(8947848),GLU:new THREE.Color(8947848),GLY:new THREE.Color(65280),PRO:new THREE.Color(65280),ALA:new THREE.Color(65280),VAL:new THREE.Color(65280),LEU:new THREE.Color(65280),ILE:new THREE.Color(65280),PHE:new THREE.Color(65280),HIS:new THREE.Color(8947848),SER:new THREE.Color(8947848),THR:new THREE.Color(8947848),ASN:new THREE.Color(8947848),GLN:new THREE.Color(8947848),TYR:new THREE.Color(8947848),MET:new THREE.Color(8947848),CYS:new THREE.Color(8947848),TRP:new THREE.Color(8947848)},sheetcolor:"green",ssColors:{helix:new THREE.Color(16711680),sheet:new THREE.Color(32768),coil:new THREE.Color(6324479)},ssColors2:{helix:new THREE.Color(16711680),sheet:new THREE.Color(16762880),coil:new THREE.Color(6324479)},defaultBondColor:new THREE.Color(12303291),surfaces:{1:void 0,2:void 0,3:void 0,4:void 0},mapData:{},hasCovalentBond:function(e,t){var i=this.covalentRadii[e.elem]+this.covalentRadii[t.elem];return e.coord.distanceToSquared(t.coord)<1.3*i*i},init_base:function(){this.structures={},this.chains={},this.residues={},this.secondaries={},this.alnChains={},this.chainsSeq={},this.chainsColor={},this.chainsGene={},this.chainsAn={},this.chainsAnTitle={},this.alnChainsSeq={},this.alnChainsAnno={},
this.alnChainsAnTtl={},this.dAtoms={},this.hAtoms={},this.pickedAtomList={},this.prevHighlightObjects=[],this.prevHighlightObjects_ghost=[],this.prevSurfaces=[],this.prevMaps=[],this.prevEmmaps=[],this.defNames2Residues={},this.defNames2Atoms={},this.defNames2Descr={},this.defNames2Command={},this.residueId2Name={},this.atoms={},this.dAtoms={},this.hAtoms={},this.proteins={},this.sidec={},this.nucleotides={},this.nucleotidesO3={},this.chemicals={},this.ions={},this.water={},this.calphas={},this.hbondpnts=[],this.stabilizerpnts=[],this.doublebonds={},this.triplebonds={},this.aromaticbonds={},this.atomPrevColors={},this.style2atoms={},this.labels={},this.lines={},this.rotateCount=0,this.rotateCountMax=20},init:function(){this.init_base(),this.molTitle="",this.ssbondpnts={},this.inputid={idtype:void 0,id:void 0},this.biomtMatrices=[],this.bAssembly=!0,this.bDrawn=!1,this.bSecondaryStructure=!1,this.bHighlight=1},reinitAfterLoad:function(){this.dAtoms=this.cloneHash(this.atoms),this.hAtoms=this.cloneHash(this.atoms),this.prevHighlightObjects=[],this.prevHighlightObjects_ghost=[],this.prevSurfaces=[],this.prevMaps=[],this.prevEmmaps=[],this.labels={},this.lines={},this.bAssembly=!0}},iCn3D.prototype.loadPDB=function(e){var t=[],i=[],r=e.split("\n"),o={},n={};this.init();var s,a,c,d=[],l=[],h=[],u=[],p=[],m=[],v=0,f=1,g="",y="",b="",E=0,C="",w=!1,T={},R={},A="stru",S=0,x="";for(var H in r){var _=r[H],I=_.substr(0,6);if("HEADER"===I)A=_.substr(62,4),this.molTitle="";else if("TITLE "===I){var D=_.substr(10);this.molTitle+=D.trim()+" "}else if("HELIX "===I){this.bSecondaryStructure=!0;for(var O,L=_.substr(19,1),M=parseInt(_.substr(21,4)),P=parseInt(_.substr(33,4)),k=M;k<=P;++k)O=L+"_"+k,u.push(O),k===M&&p.push(O),k===P&&m.push(O);t.push({chain:L,initialResidue:M,initialInscode:_.substr(25,1),terminalResidue:P,terminalInscode:_.substr(37,1)})}else if("SHEET "===I){this.bSecondaryStructure=!0;for(var L=_.substr(21,1),M=parseInt(_.substr(22,4)),P=parseInt(_.substr(33,4)),k=M;k<=P;++k){var O=L+"_"+k;d.push(O),k===M&&l.push(O),k===P&&h.push(O)}i.push({chain:L,initialResidue:M,initialInscode:_.substr(26,1),terminalResidue:P,terminalInscode:_.substr(37,1)})}else if("HBOND "===I);else if("SSBOND"===I){var N=_.substr(15,1),z=_.substr(17,4).replace(/ /g,""),j=A+"_"+N+"_"+z,F=_.substr(29,1),U=_.substr(31,4).replace(/ /g,""),V=A+"_"+F+"_"+U;void 0===this.ssbondpnts[A]&&(this.ssbondpnts[A]=[]),this.ssbondpnts[A].push(j),this.ssbondpnts[A].push(V)}else if("REMARK"===I){var B=parseInt(_.substr(7,3));if(350==B&&"BIOMT"==_.substr(13,5)){var G=parseInt(_[18])-1,q=parseInt(_.substr(21,2))-1;void 0==this.biomtMatrices[q]&&(this.biomtMatrices[q]=(new THREE.Matrix4).identity()),this.biomtMatrices[q].elements[G]=parseFloat(_.substr(24,9)),this.biomtMatrices[q].elements[G+4]=parseFloat(_.substr(34,9)),this.biomtMatrices[q].elements[G+8]=parseFloat(_.substr(44,9)),this.biomtMatrices[q].elements[G+12]=parseFloat(_.substr(54,10))}else if(465==B&&" "==_.substr(18,1)&&" "==_.substr(20,1)&&"S"!=_.substr(21,1)){var W=_.substr(15,3),Y=_.substr(19,1),X=parseInt(_.substr(21,5)),s=A+"_"+Y;void 0===R[s]&&(R[s]=[]);var Q={};Q.resi=X,Q.name=this.residueName2Abbr(W).toLowerCase(),Y!=x&&(S=0),!isNaN(X)&&(""==x||Y!=x||Y==x&&X>S)&&(R[s].push(Q),S=X,x=Y)}else 900==B&&void 0===this.emd&&"RELATED DB: EMDB"==_.substr(34).trim()&&(this.emd=_.substr(23,11).trim())}else if("ENDMDL"===I)++f;else if("JRNL  "===I)"PMID"===_.substr(12,4)&&(this.pmid=_.substr(19).trim());else if("ATOM  "===I||"HETATM"===I){var Z=1===f?A:A+f.toString(),K=_.substr(16,1);++v;var J=parseInt(_.substr(6,5));T[J]=v;var ee=_.substr(76,2).replace(/ /g,"");""===ee&&(ee=_.substr(12,2).replace(/ /g,""));var Y=_.substr(21,1);""===Y&&(Y=1),s=Z+"_"+Y,s!==g&&(E=0,w=!1);var te=_.substr(22,5).trim();c=s+"_"+te;var X=parseInt(te);(te!=X||w)&&(w=!0),a=s+"_"+X;var ie=_.substr(12,4).replace(/ /g,""),O=Y+"_"+X,re=parseFloat(_.substr(30,8)),oe=parseFloat(_.substr(38,8)),ne=parseFloat(_.substr(46,8)),W=_.substr(17,3),se=new THREE.Vector3(re,oe,ne),ae={het:"H"===I[0],serial:v,name:ie,alt:K,resn:W,structure:Z,chain:Y,resi:X,coord:se,b:parseFloat(_.substr(60,8)),elem:ee,bonds:[],ss:"coil",ssbegin:!1,ssend:!1};this.atoms[v]=ae,this.dAtoms[v]=1,this.hAtoms[v]=1,$.inArray(O,d)!==-1?(this.atoms[v].ss="sheet",$.inArray(O,l)!==-1&&(this.atoms[v].ssbegin=!0),$.inArray(O,h)!==-1&&(this.atoms[v].ssend=!0)):$.inArray(O,u)!==-1&&(this.atoms[v].ss="helix",$.inArray(O,p)!==-1&&(this.atoms[v].ssbegin=!0),$.inArray(O,m)!==-1&&(this.atoms[v].ssend=!0));var ce="-";if(ce="helix"===this.atoms[v].ss?"H":"sheet"===this.atoms[v].ss?"E":!this.atoms[v].het&&this.residueColors.hasOwnProperty(this.atoms[v].resn.toUpperCase())?"c":"o",this.secondaries[a]=ce,c!==b){var de=this.residueName2Abbr(W);if(this.residueId2Name[a]=de,1!==v&&(this.residues[y]=n),a!==y&&(n={}),s!==g){1!==v&&(this.chains[g]=this.unionHash(this.chains[g],o)),o={},void 0===this.structures[Z.toString()]&&(this.structures[Z.toString()]=[]),this.structures[Z.toString()].push(s),void 0===this.chainsSeq[s]&&(this.chainsSeq[s]=[]);var Q={};Q.resi=X,Q.name=de,this.chainsSeq[s].push(Q)}else{var Q={};Q.resi=X,Q.name=de,this.chainsSeq[s].push(Q)}}o[v]=1,n[v]=1,C=I,g=s,y=a,b=c}else if("CONECT"===I)for(var le=parseInt(_.substr(6,5)),k=0;k<4;++k){var he=parseInt(_.substr([11,16,21,26][k],5));isNaN(he)||void 0!==this.atoms[T[le]]&&this.atoms[T[le]].bonds.push(T[he])}else"TER"===I.substr(0,3)&&++v}for(var ue=Object.keys(this.structures),pe=0,me=ue.length;pe<me;++pe){var Z=ue[pe];if(Z!=A&&(void 0===this.ssbondpnts[Z]&&(this.ssbondpnts[Z]=[]),void 0!==this.ssbondpnts[A]))for(var k=0,ve=this.ssbondpnts[A].length;k<ve;++k){var fe=this.ssbondpnts[A][k],ge=fe.indexOf("_"),ye=Z+fe.substr(ge);this.ssbondpnts[Z].push(ye)}}this.adjustSeq(R),r=null,this.residues[a]=n,this.chains[s]=this.unionHash2Atoms(this.chains[s],o);var be,Ee,Ce=[],we=this,Te=function(e){for(var t=Ce.length,i=0;i<t;++i){for(var r=Ce[i],o=i+1;o<t;++o){var n=Ce[o];r.alt===n.alt&&we.hasCovalentBond(r,n)&&(r.bonds.push(n.serial),n.bonds.push(r.serial))}e&&e(r)}},Re=new THREE.Vector3(9999,9999,9999),Ae=new THREE.Vector3((-9999),(-9999),(-9999)),Se=new THREE.Vector3,xe=0,He={};for(var H in this.atoms){var ie=this.atoms[H],se=ie.coord;Se.add(se),Re.min(se),Ae.max(se),++xe,ie.het?ie.het&&("HOH"===ie.resn||"WAT"===ie.resn||"SOL"===ie.resn?this.water[ie.serial]=1:$.inArray(ie.resn,this.ionsArray)!==-1||ie.elem.trim()===ie.resn.trim()?this.ions[ie.serial]=1:this.chemicals[ie.serial]=1):$.inArray(ie.resn,this.nucleotidesArray)!==-1?(this.nucleotides[ie.serial]=1,"O3'"!==ie.name&&"O3*"!==ie.name||(this.nucleotidesO3[ie.serial]=1,this.secondaries[ie.structure+"_"+ie.chain+"_"+ie.resi]="o")):("P"===ie.elem&&(He[ie.structure+"_"+ie.chain+"_"+ie.resi]=1),this.proteins[ie.serial]=1,"CA"===ie.name&&(this.calphas[ie.serial]=1),"N"!==ie.name&&"CA"!==ie.name&&"C"!==ie.name&&"O"!==ie.name&&(this.sidec[ie.serial]=1)),be===ie.chain&&Ee===ie.resi||(Te(function(e){("C"===e.name&&"N"===ie.name||"O3'"===e.name&&"P"===ie.name)&&we.hasCovalentBond(e,ie)&&(e.bonds.push(ie.serial),ie.bonds.push(e.serial))}),be=ie.chain,Ee=ie.resi,Ce.length=0),Ce.push(ie)}for(ye in He){var _e=this.residues[ye];for(v in _e){var ie=this.atoms[v];ie.het=!0,this.chemicals[ie.serial]=1,this.secondaries[ye]="o",delete this.proteins[ie.serial],"CA"===ie.name&&delete this.calphas[ie.serial],"N"!==ie.name&&"CA"!==ie.name&&"C"!==ie.name&&"O"!==ie.name&&delete this.sidec[ie.serial]}}Te(),this.pmin=Re,this.pmax=Ae,this.cnt=xe,this.maxD=this.pmax.distanceTo(this.pmin),this.center=Se.multiplyScalar(1/this.cnt),this.maxD<5&&(this.maxD=5),this.oriMaxD=this.maxD,this.oriCenter=this.center.clone()},iCn3D.prototype.adjustSeq=function(e){for(var t in this.chainsSeq)if(void 0!==e[t]){var i,r,o,n=this.chainsSeq[t],s=e[t],a=n.length,c=s.length,d=new Array(a+c);for(i=0,r=0,o=0;i<a&&r<c;)n[i].resi<=s[r].resi?(d[o]=n[i],i++):(d[o]=s[r],r++),o++;if(i<a)for(var l=i;l<a;l++)d[o]=n[l],o++;else for(var l=r;l<c;l++)d[o]=s[l],o++;this.chainsSeq[t]=d}},iCn3D.prototype.createSphere=function(e,t,i,r,o){var n;void 0===t&&(t=.8),void 0===i&&(i=!1),void 0===r&&(r=1);var s=this.vdwRadii[e.elem]||t;if(2===o){r*=1.5;var a=this.hColor;n=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:this.frac,shininess:30,emissive:0,color:a})),n.scale.x=n.scale.y=n.scale.z=i?t:s*(r?r:1),n.position.copy(e.coord),this.mdl.add(n)}else if(1===o)n=new THREE.Mesh(this.sphereGeometry,this.matShader),n.scale.x=n.scale.y=n.scale.z=i?t:s*(r?r:1),n.position.copy(e.coord),n.renderOrder=this.renderOrderPicking,this.mdl.add(n);else{void 0===e.color&&(e.color=this.defaultAtomColor);var a=e.color;if(n=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({specular:this.frac,shininess:30,emissive:0,color:a})),n.scale.x=n.scale.y=n.scale.z=i?t:s*(r?r:1),n.position.copy(e.coord),this.bImpo){this.posArraySphere.push(e.coord.x),this.posArraySphere.push(e.coord.y),this.posArraySphere.push(e.coord.z),this.colorArraySphere.push(e.color.r),this.colorArraySphere.push(e.color.g),this.colorArraySphere.push(e.color.b);var c=i?t:s*(r?r:1);this.radiusArraySphere.push(c),this.cnt<=this.maxatomcnt&&this.mdl_ghost.add(n)}else this.mdl.add(n)}1===o||2===o?this.bImpo?this.cnt<=this.maxatomcnt&&this.prevHighlightObjects_ghost.push(n):this.prevHighlightObjects.push(n):this.bImpo?this.cnt<=this.maxatomcnt&&this.objects_ghost.push(n):this.objects.push(n)},iCn3D.prototype.createCylinder=function(e,t,i,r,o,n,s){var a;1===o?(a=new THREE.Mesh(this.cylinderGeometryOutline,this.matShader),a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(t.clone().sub(e)),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(i,i,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),a.renderOrder=this.renderOrderPicking,this.mdl.add(a),this.prevHighlightObjects.push(a)):(2===o?(a=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:this.frac,shininess:30,emissive:0,color:r})),i*=1.5):a=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({specular:this.frac,shininess:30,emissive:0,color:r})),a.position.copy(e).add(t).multiplyScalar(.5),a.matrixAutoUpdate=!1,a.lookAt(t.clone().sub(e)),a.updateMatrix(),a.matrix.multiply((new THREE.Matrix4).makeScale(i,i,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),this.bImpo?(this.posArray.push(e.x),this.posArray.push(e.y),this.posArray.push(e.z),this.colorArray.push(r.r),this.colorArray.push(r.g),this.colorArray.push(r.b),this.pos2Array.push(t.x),this.pos2Array.push(t.y),this.pos2Array.push(t.z),void 0!==n?(this.color2Array.push(n.r),this.color2Array.push(n.g),this.color2Array.push(n.b)):(this.color2Array.push(r.r),this.color2Array.push(r.g),this.color2Array.push(r.b)),this.radiusArray.push(i),this.cnt<=this.maxatomcnt&&this.mdl_ghost.add(a)):this.mdl.add(a),2===o?this.bImpo?this.cnt<=this.maxatomcnt&&this.prevHighlightObjects_ghost.push(a):this.prevHighlightObjects.push(a):this.bImpo?this.cnt<=this.maxatomcnt&&this.objects_ghost.push(a):(void 0===s||s)&&this.objects.push(a))},iCn3D.prototype.createRepresentationSub=function(e,t,i){var r=this,o=[];for(var n in e){var s=e[n];t&&t(s);for(var a in s.bonds){var c=this.atoms[s.bonds[a]];void 0===c||c.serial<s.serial||(c.chain===s.chain&&(c.resi===s.resi||"C"===s.name&&"N"===c.name||"O3'"===s.name&&"P"===c.name||"O3*"===s.name&&"P"===c.name||"SG"===s.name&&"SG"===c.name)?i&&i(s,c):o.push([s.coord,c.coord]))}}if(o.length>0&&this.bShowCrossResidueBond)for(var d=new THREE.Color(65280),n=0,l=o.length;n<l;++n)r.createCylinder(o[n][0],o[n][1],this.cylinderRadius,d,0)},iCn3D.prototype.createSphereRepresentation=function(e,t,i,r,o){var n=this;this.createRepresentationSub(e,function(e){n.createSphere(e,t,i,r,o)})},iCn3D.prototype.createBoxRepresentation_P_CA=function(e,t,i){var r=this;this.createRepresentationSub(e,function(e){"CA"!==e.name&&"O3'"!==e.name&&"O3*"!==e.name||r.createBox(e,void 0,void 0,t,void 0,i)})},iCn3D.prototype.createStickRepresentation=function(e,t,i,r,o,n){var s=this,a=void 0!==n&&n?t/s.cylinderRadius:1;this.createRepresentationSub(e,function(e){s.createSphere(e,t,!r,r,o)},function(e,t){var r=e.coord.clone().add(t.coord).multiplyScalar(.5),n=e.serial+"_"+t.serial;if(s.doublebonds.hasOwnProperty(n)){var c,d,l,h,u=new THREE.Vector3(Math.random(),Math.random(),Math.random());if(1==e.bonds.length&&1==t.bonds.length){h=t.coord.clone(),h.sub(e.coord);var p=u.clone();h.cross(p).normalize().multiplyScalar(.2*a)}else{if(e.bonds.length>=t.bonds.length&&e.bonds.length>1)c=e.serial,d=e.bonds[0],l=e.bonds[1];else{if(!(t.bonds.length>=e.bonds.length&&t.bonds.length>1))return void console.log("Double bond was not drawn due to the undefined cross plane");c=t.serial,d=t.bonds[0],l=t.bonds[1]}var m=s.atoms[c].coord.clone();m.sub(s.atoms[d].coord);var v=s.atoms[c].coord.clone();v.sub(s.atoms[l].coord),m.cross(v),0==parseInt(1e4*m.length())&&(m=new THREE.Vector3(.2,.3,.5)),h=t.coord.clone(),h.sub(e.coord),h.cross(m).normalize().multiplyScalar(.2*a),0==parseInt(1e4*h.length())&&(m=new THREE.Vector3(.5,.3,.2),h.cross(m).normalize().multiplyScalar(.2*a))}e.color===t.color?(s.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),s.cylinderRadius*a*.3,e.color,o),s.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),s.cylinderRadius*a*.3,e.color,o)):s.bImpo?(s.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),s.cylinderRadius*a*.3,e.color,o,t.color),s.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),s.cylinderRadius*a*.3,e.color,o,t.color)):(s.createCylinder(e.coord.clone().add(h),r.clone().add(h),s.cylinderRadius*a*.3,e.color,o),s.createCylinder(t.coord.clone().add(h),r.clone().add(h),s.cylinderRadius*a*.3,t.color,o),s.createCylinder(e.coord.clone().sub(h),r.clone().sub(h),s.cylinderRadius*a*.3,e.color,o),s.createCylinder(t.coord.clone().sub(h),r.clone().sub(h),s.cylinderRadius*a*.3,t.color,o))}else if(s.aromaticbonds.hasOwnProperty(n)){var c,d,l;if(e.bonds.length>t.bonds.length&&e.bonds.length>1)c=e.serial,d=e.bonds[0],l=e.bonds[1];else{if(!(t.bonds.length>1))return;c=t.serial,d=t.bonds[0],l=t.bonds[1]}var m=s.atoms[c].coord.clone();m.sub(s.atoms[d].coord);var v=s.atoms[c].coord.clone();v.sub(s.atoms[l].coord),m.cross(v);var h=t.coord.clone();h.sub(e.coord),h.cross(m).normalize().multiplyScalar(.2*a);for(var f=0,g=0,y=e.bondOrder.length;g<y;++g)"1.5"===e.bondOrder[g]&&e.bonds[g]!==t.serial&&(f=e.bonds[g]);var b="add";if(0===f)b="add";else{var E=e.coord.clone().add(h),C=e.coord.clone().sub(h),w=t.coord.clone().sub(E).normalize(),T=s.atoms[f].coord.clone().sub(E).normalize(),R=t.coord.clone().sub(C).normalize(),A=s.atoms[f].coord.clone().sub(C).normalize(),S=Math.acos(w.dot(T)),x=Math.acos(R.dot(A));b=S<x?"sub":"add"}if(e.color===t.color){var H,_;"add"===b?(s.createCylinder(e.coord.clone().sub(h),t.coord.clone().sub(h),s.cylinderRadius*a*.3,e.color,o),H=e.coord.clone().add(h),_=t.coord.clone().add(h).sub(H).multiplyScalar(1/11)):(s.createCylinder(e.coord.clone().add(h),t.coord.clone().add(h),s.cylinderRadius*a*.3,e.color,o),H=e.coord.clone().sub(h),_=t.coord.clone().sub(h).sub(H).multiplyScalar(1/11));for(var g=0;g<=10;++g)if(g%2==0){var I=H.clone().add(_.clone().multiplyScalar(g)),D=H.clone().add(_.clone().multiplyScalar(g+1));s.createCylinder(I,D,s.cylinderRadius*a*.3,e.color,o)}}else{var H,_;"add"===b?(s.createCylinder(e.coord.clone().sub(h),r.clone().sub(h),s.cylinderRadius*a*.3,e.color,o),s.createCylinder(t.coord.clone().sub(h),r.clone().sub(h),s.cylinderRadius*a*.3,t.color,o),H=e.coord.clone().add(h),_=t.coord.clone().add(h).sub(H).multiplyScalar(1/11)):(s.createCylinder(e.coord.clone().add(h),r.clone().add(h),s.cylinderRadius*a*.3,e.color,o),s.createCylinder(t.coord.clone().add(h),r.clone().add(h),s.cylinderRadius*a*.3,t.color,o),H=e.coord.clone().sub(h),_=t.coord.clone().sub(h).sub(H).multiplyScalar(1/11));for(var g=0;g<=10;++g)if(g%2==0){var I=H.clone().add(_.clone().multiplyScalar(g)),D=H.clone().add(_.clone().multiplyScalar(g+1));g<5?s.createCylinder(I,D,s.cylinderRadius*a*.3,e.color,o):s.createCylinder(I,D,s.cylinderRadius*a*.3,t.color,o)}}}else if(s.triplebonds.hasOwnProperty(n)){var u=new THREE.Vector3(Math.random(),Math.random(),Math.random()),p=t.coord.clone();p.sub(e.coord);var R=u.clone();R.cross(p).normalize().multiplyScalar(.3*a),e.color===t.color?(s.createCylinder(e.coord,t.coord,s.cylinderRadius*a*.2,e.color,o),s.createCylinder(e.coord.clone().add(R),t.coord.clone().add(R),s.cylinderRadius*a*.2,e.color,o),s.createCylinder(e.coord.clone().sub(R),t.coord.clone().sub(R),s.cylinderRadius*a*.2,e.color,o)):s.bImpo?(s.createCylinder(e.coord,t.coord,s.cylinderRadius*a*.2,e.color,o,t.color),s.createCylinder(e.coord.clone().add(R),t.coord.clone().add(R),s.cylinderRadius*a*.2,e.color,o,t.color),s.createCylinder(e.coord.clone().sub(R),t.coord.clone().sub(R),s.cylinderRadius*a*.2,e.color,o,t.color)):(s.createCylinder(e.coord,r,s.cylinderRadius*a*.2,e.color,o),s.createCylinder(t.coord,r,s.cylinderRadius*a*.2,t.color,o),s.createCylinder(e.coord.clone().add(R),r.clone().add(R),s.cylinderRadius*a*.2,e.color,o),s.createCylinder(t.coord.clone().add(R),r.clone().add(R),s.cylinderRadius*a*.2,t.color,o),s.createCylinder(e.coord.clone().sub(R),r.clone().sub(R),s.cylinderRadius*a*.2,e.color,o),s.createCylinder(t.coord.clone().sub(R),r.clone().sub(R),s.cylinderRadius*a*.2,t.color,o))}else e.color===t.color?s.createCylinder(e.coord,t.coord,i,e.color,o):s.bImpo?s.createCylinder(e.coord,t.coord,i,e.color,o,t.color):(s.createCylinder(e.coord,r,i,e.color,o),s.createCylinder(t.coord,r,i,t.color,o))})},iCn3D.prototype.createLineRepresentation=function(e,t){var i=new THREE.Geometry;if(this.createRepresentationSub(e,void 0,function(e,t){if(e.color===t.color)i.vertices.push(e.coord),i.vertices.push(t.coord),i.colors.push(e.color),i.colors.push(t.color);else{var r=e.coord.clone().add(t.coord).multiplyScalar(.5);i.vertices.push(e.coord),i.vertices.push(r),i.vertices.push(t.coord),i.vertices.push(r),i.colors.push(e.color),i.colors.push(e.color),i.colors.push(t.color),i.colors.push(t.color)}}),2!==t){var r;1===t||(r=new THREE.LineSegments(i,new THREE.LineBasicMaterial({linewidth:this.linewidth,vertexColors:!0})),this.mdl.add(r)),1===t?this.prevHighlightObjects.push(r):this.objects.push(r)}else 2===t&&this.createBoxRepresentation_P_CA(e,.8,t)},iCn3D.prototype.getKnot=function(e,t,i,r){return i.distanceTo(r)+t},iCn3D.prototype.getValueFromKnot=function(e,t,i,r,o,n,s,a,c){var d,l,h=9999,u=(s-n)/(i-t),p=(a-s)/(r-i),m=(c-a)/(o-r),v=p*(e-i)+s,f=(i+r)*(i+r)-4*(t*i+r*o-t*o);0==f?(d=h,l=h):(d=6*(3*p*i+2*u*o+m*i-2*u*i-2*p*o-p*r-m*i)/f,l=6*(3*p*r+2*m*t+u*i-2*p*t-2*m*r-u*r-p*i)/f);var g=(2*d+l)/6/(i-r),y=(2*l+d)/6/(r-i),b=g*(e-i)*(e-r)*(e-r)+y*(e-i)*(e-i)*(e-r),E=v+b;return E},iCn3D.prototype.subdivide=function(e,t,i,r,o,n,s,a){var c=[],d=[],l=[],h=new Array,u=void 0!==n?n.length:0,p=void 0!==s?s.length:0;u>0&&h.push(n[0]),h.push(e[0]);for(var m=1,v=e.length-1;m<v;++m){var f=e[m],g=e[m+1];h.push(f.smoothen?f.clone().add(g).multiplyScalar(.5):f)}h.push(e[e.length-1]),p>0&&h.push(s[0]),p>1&&h.push(s[1]);var y=[],b=[],E=[],C=p;a&&(C=p>0?p-1:0);for(var w=1,m=-1,T=h.length,R=1/i;m<=T-3;++m){var A=m-u,f=h[m===-1?0:m],g=h[m+1],S=h[m+2],x=h[m===T-3?T-1:m+3],H=0,_=this.getKnot(w,H,f,g),I=this.getKnot(w,_,g,S),D=this.getKnot(w,I,S,x);_-H<1e-4&&(_=H+1),I-_<1e-4&&(I=_+1),D-I<1e-4&&(D=I+1),m>-1&&(void 0===r||r[A+1])&&m>=-1+u&&m<=T-3-C+1&&(c=c.concat(y),d=d.concat(b),l=l.concat(E)),y=[],b=[],E=[];for(var O=(I-_)*R,L=0;L<i;++L){var M=_+O*L,P=this.getValueFromKnot(M,H,_,I,D,f.x,g.x,S.x,x.x),k=this.getValueFromKnot(M,H,_,I,D,f.y,g.y,S.y,x.y),N=this.getValueFromKnot(M,H,_,I,D,f.z,g.z,S.z,x.z);r?(m>=-1+u&&m<=T-3-C&&r[A+1]&&L<=parseInt(i/2)&&(c.push(new THREE.Vector3(P,k,N)),d.push(r[A+1]),l.push(t[A+1])),m>=-1+u&&m<=T-3-C+1&&r[A+2]&&L>parseInt(i/2)&&(y.push(new THREE.Vector3(P,k,N)),b.push(r[A+2]),E.push(t[A+2]))):m>=-1+u&&m<=T-3-C&&(c.push(new THREE.Vector3(P,k,N)),d.push(A+1),l.push(t[A+1]))}}r&&!r[A+1]||(c=c.concat(y),d=d.concat(b),l=l.concat(E),c.push(h[h.length-1-C]),d.push(h.length-1-C),l.push(t[h.length-1-C])),y=[],b=[],E=[],h=[];var z=[];return z.push(c),z.push(d),z.push(l),z},iCn3D.prototype.createCurveSubArrow=function(e,t,i,r,o,n,s,a,c,d,l,h,u,p,m){var v=[],f=[];v.push(e),f.push(a),this.prepareStrand(v,f,t,i,r,void 0,o,n,s,c,d,!1,l,h,u,p,m),v=[],f=[]},iCn3D.prototype.setCalphaDrawnCoord=function(e,t,i){var r=0;if(void 0!==i)for(var o=0,n=e.length;o<n;o+=t){var s=i[r];this.atoms.hasOwnProperty(s)&&(this.atoms[s].coord2=e[o].clone()),++r}},iCn3D.prototype.createCurveSub=function(e,t,i,r,o,n,s,a,c,d,l,h){if(0!==e.length){r=r||5;var u;if(s)u=e;else{var p=!0,m=this.subdivide(e,i,r,a,o,l,h,p);u=m[0],i=m[2]}if(0!==u.length){if(this.setCalphaDrawnCoord(u,r,c),1===o){var v=this.coilWidth/2,f=4,g=!1;if(u.length>1)if(void 0!==d){for(var y,b,E=[],C=0,w=u.length;C<w;++C){if(y=d[C],y!==b&&y!==b+1&&void 0!==b||C===w-1){var T=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(E),E.length,v,f,g);mesh=new THREE.Mesh(T,this.matShader),mesh.renderOrder=this.renderOrderPicking,this.mdl.add(mesh),this.prevHighlightObjects.push(mesh),T=null,E=[]}E.push(u[C]),b=y}E=[]}else{var T=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(u),u.length,v,f,g);mesh=new THREE.Mesh(T,this.matShader),mesh.renderOrder=this.renderOrderPicking,this.mdl.add(mesh),this.prevHighlightObjects.push(mesh),T=null}}else{var R=new THREE.Geometry;if(2===o&&n)for(var C=0;C<u.length;++C)u[C].addScalar(.6),R.vertices.push(u[C]),R.colors.push(new THREE.Color(i[C]));else for(var C=0;C<u.length;++C)R.vertices.push(u[C]),R.colors.push(new THREE.Color(i[C]));var A=new THREE.Line(R,new THREE.LineBasicMaterial({linewidth:t,vertexColors:!0}));this.mdl.add(A),2===o?this.prevHighlightObjects.push(A):this.objects.push(A)}u=null}}},iCn3D.prototype.createCylinderCurve=function(e,t,i,r,o){var n,s,a,c=null,d=8;for(a in e){var l=e[a];if(!l.het&&t.indexOf(l.name)!=-1){if(null!==c&&n===l.chain&&s+1===l.resi&&Math.abs(c.coord.x-l.coord.x)<d&&Math.abs(c.coord.y-l.coord.y)<d&&Math.abs(c.coord.z-l.coord.z)<d){var h=c.coord.clone().add(l.coord).multiplyScalar(.5);if(o)1===o&&(this.createCylinder(c.coord,h,i,c.color,o),this.createCylinder(h,l.coord,i,l.color,o),this.createSphere(l,i,!0,1,o));else if(r){var u=this.createSingleLine(c.coord,h,c.color,!1);this.mdl.add(u),this.objects.push(u),u=this.createSingleLine(h,l.coord,l.color,!1),this.mdl.add(u),this.objects.push(u)}else this.createCylinder(c.coord,h,i,c.color),this.createCylinder(h,l.coord,i,l.color),this.createSphere(l,i,!0,1,o)}c=l,n=l.chain,s=l.resi,2===o&&this.createBox(l,void 0,void 0,void 0,void 0,o)}}if(null!==c&&n===l.chain&&s+1===l.resi&&Math.abs(c.coord.x-l.coord.x)<d&&Math.abs(c.coord.y-l.coord.y)<d&&Math.abs(c.coord.z-l.coord.z)<d){var h=c.coord.add(l.coord).multiplyScalar(.5);if(o)1===o&&(this.createCylinder(c.coord,h,i,c.color,o),this.createCylinder(h,l.coord,i,l.color,o),this.createSphere(l,i,!0,1,o));else if(r){var u=this.createSingleLine(c.coord,h,c.color,!1);this.mdl.add(u),this.objects.push(u),u=this.createSingleLine(h,l.coord,l.color,!1),this.mdl.add(u),this.objects.push(u)}else this.createCylinder(c.coord,h,i,c.color),this.createCylinder(h,l.coord,i,l.color)}},iCn3D.prototype.prepareStrand=function(e,t,i,r,o,n,s,a,c,d,l,h,u,p,m,v,f){if(1!==d.length){var g=[];g.push(r[r.length-2]),g.push(r[r.length-1]),o=o||this.axisDIV;for(var y,b,E,C,w=2/(c-1),T={},R=[],A=0,S=t.length;A<S;++A)T[A]=[];var x=this.subdivide(d,r,o,void 0,void 0,v,f),H=x[0];if(1!==H.length){for(var R=[],_=void 0===m||m?d.length-2:d.length,A=0,S=_;A<S;++A){for(var I=0,D=t.length;I<D;++I)T[I].push(e[I][A]);R.push(r[A])}if(R.push(r[A]),void 0===m||m)for(var A=0,S=t.length;A<S;++A)y=-1+w*t[A],b=H.length-1-o,E=d.length-2,C=new THREE.Vector3(H[b].x+l[E].x*y,H[b].y+l[E].y*y,H[b].z+l[E].z*y),T[A].push(C);for(var O,L=[],A=0,S=t.length;A<S;++A)O=this.subdivide(T[A],R,o,u,s),T[A]=O[0],r=O[2],0===A&&(L=O[1]);if(h?this.createStrip(T[0],T[1],r,o,n,s,!0,void 0,p,L,v,f):this.createCurveSub(T[0],i,r,o,s,a,!0,void 0,p,L,v,f),void 0===m||m){R=[],L=[];for(var I=0,D=t.length;I<D;++I){T[I]=[];for(var A=o*(d.length-2),S=o*(d.length-1);u[parseInt(A/o)]&&A<S;A+=o)for(var M=parseInt(A/o),P=0;P<o;++P){var y=-1+w*t[I],k=1.8;y=y*k*(o-P)/o;var N=parseInt(A/o),C=new THREE.Vector3(H[A+P].x+l[N].x*y,H[A+P].y+l[N].y*y,H[A+P].z+l[N].z*y);C.smoothen=!0,T[I].push(C),R.push(g[0]),0===I&&L.push(M)}var y=0,b=H.length-1,E=d.length-1,C=new THREE.Vector3(H[b].x+l[E].x*y,H[b].y+l[E].y*y,H[b].z+l[E].z*y);C.smoothen=!0,T[I].push(C),R.push(g[1]),0===I&&L.push(b)}H=[],h?this.createStrip(T[0],T[1],R,o,n,s,!0,void 0,void 0,L,v,f):this.createCurveSub(T[0],i,R,o,s,a,!0,void 0,void 0,L,v,f)}for(var A in T){for(var P=0,z=T[A].length;P<z;++P)T[A][P]=null;T[A]=[]}T={}}}},iCn3D.prototype.createStripArrow=function(e,t,i,r,o,n,s,a,c,d,l,h,u,p,m,v){var f=[],g=[];f.push(e),f.push(t),g.push(a),g.push(c),this.prepareStrand(f,g,void 0,i,r,o,n,void 0,s,d,l,!0,h,u,p,m,v),f=[],g=[]},iCn3D.prototype.createStrip=function(e,t,i,r,o,n,s,a,c,d,l,h){if(!(e.length<2)){if(r=r||this.axisDIV,!s){var u=!0,p=this.subdivide(e,i,r,a,n,l,h,u),m=this.subdivide(t,i,r,a,n,l,h,u);e=p[0],t=m[0],i=p[2]}if(!(e.length<2)){if(this.setCalphaDrawnCoord(e,r,c),1===n){var v=this.coilWidth/2,f=4,g=!1;if(void 0!==d){for(var y,b,E=[],C=[],w=0,T=e.length;w<T;++w){if(y=d[w],y!==b&&y!==b+1&&void 0!==b||w===T-1){var R=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(E),E.length,v,f,g);F=new THREE.Mesh(R,this.matShader),F.renderOrder=this.renderOrderPicking,this.mdl.add(F),this.prevHighlightObjects.push(F),R=null;var A=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(C),C.length,v,f,g);F=new THREE.Mesh(A,this.matShader),F.renderOrder=this.renderOrderPicking,this.mdl.add(F),this.prevHighlightObjects.push(F),A=null,E=[],C=[]}E.push(e[w]),C.push(t[w]),b=y}E=[],C=[]}else{var R=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(e),e.length,v,f,g);F=new THREE.Mesh(R,this.matShader),F.renderOrder=this.renderOrderPicking,this.mdl.add(F),this.prevHighlightObjects.push(F),R=null;var A=new THREE.TubeGeometry(new THREE.CatmullRomCurve3(t),t.length,v,f,g);F=new THREE.Mesh(A,this.matShader),F.renderOrder=this.renderOrderPicking,this.mdl.add(F),this.prevHighlightObjects.push(F),A=null}}else{for(var S,x,H,_,I,D=new THREE.Geometry,O=D.vertices,L=D.faces,w=0,M=e.length;w<M;++w)O.push(x=e[w]),O.push(x),O.push(H=t[w]),O.push(H),w<M-1&&(S=t[w].clone().sub(e[w]).cross(e[w+1].clone().sub(e[w])).normalize().multiplyScalar(o)),O.push(_=e[w].clone().add(S)),O.push(_),O.push(I=t[w].clone().add(S)),O.push(I);for(var P=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]],w=1,M=e.length;w<M;++w)for(var k=8*w,N=new THREE.Color(i[w-1]),z=0;z<4;++z)L.push(new THREE.Face3(k+P[z][0],k+P[z][1],k+P[z][2],(void 0),N)),L.push(new THREE.Face3(k+P[z][3],k+P[z][0],k+P[z][2],(void 0),N));for(var j=O.length-8,w=0;w<4;++w)O.push(O[2*w]),O.push(O[j+2*w]);j+=8,L.push(new THREE.Face3(j,j+2,j+6,(void 0),L[0].color)),L.push(new THREE.Face3(j+4,j,j+6,(void 0),L[0].color)),L.push(new THREE.Face3(j+1,j+5,j+7,(void 0),L[L.length-3].color)),L.push(new THREE.Face3(j+3,j+1,j+7,(void 0),L[L.length-3].color)),D.computeFaceNormals(),D.computeVertexNormals(!1);var F;2===n?(F=new THREE.Mesh(D,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(F),this.prevHighlightObjects.push(F)):(F=new THREE.Mesh(D,new THREE.MeshPhongMaterial({specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(F),this.objects.push(F))}e=null,t=null}}},iCn3D.prototype.createStrand=function(e,t,i,r,o,n,s,a,c){var d=!!r,l={};if(this.bAllAtoms)l=e;else{var h,u,p,m,v,f,g,y,b=0,E=Object.keys(e).length;l=this.cloneHash(e);for(var C in e){if(h=e[C].structure+"_"+e[C].chain,u=parseInt(e[C].resi),p=e[C],void 0===m&&(g=e[C]),h!==m&&void 0!==m||u!==v&&u!==v+1&&void 0!==v||b===E-1){h!==m&&void 0!==m||u!==v&&u!==v+1&&void 0!==v?y=f:b===E-1&&(y=p);var w=g.resi;if("coil"!==g.ss&&!g.ssbegin){for(var T=g.resi-1;T>0;--T){var R=g.structure+"_"+g.chain+"_"+T;if(!this.residues.hasOwnProperty(R))break;var A=this.getFirstCalphaAtomObj(this.residues[R]);if(A.ss===g.ss&&A.ssbegin){w=A.resi;break}}for(var T=w;T<g.resi;++T){var R=g.structure+"_"+g.chain+"_"+T;l=this.unionHash(l,this.hash2Atoms(this.residues[R]))}}if(3===this.pk&&1===c&&"coil"===g.ss){var R=g.structure+"_"+g.chain+"_"+(g.resi-1);this.residues.hasOwnProperty(R)&&(l=this.unionHash(l,this.hash2Atoms(this.residues[R])),e=this.unionHash(e,this.hash2Atoms(this.residues[R])))}var S=y.resi;if("coil"!==y.ss&&!y.ssend&&!y.notshow){for(var x=this.getLastAtomObj(this.chains[y.structure+"_"+y.chain]).resi,T=y.resi+1;T<=x;++T){var R=y.structure+"_"+y.chain+"_"+T;if(!this.residues.hasOwnProperty(R))break;var A=this.getFirstCalphaAtomObj(this.residues[R]);if(A.ss===y.ss&&A.ssend){S=A.resi;break}}for(var T=y.resi+1;T<=S;++T){var R=y.structure+"_"+y.chain+"_"+T;l=this.unionHash(l,this.hash2Atoms(this.residues[R]))}}if(3===this.pk&&1===c&&"coil"===y.ss){var R=y.structure+"_"+y.chain+"_"+(y.resi+1);this.residues.hasOwnProperty(R)&&(l=this.unionHash(l,this.hash2Atoms(this.residues[R])),e=this.unionHash(e,this.hash2Atoms(this.residues[R])))}y.notshow&&(y.notshow=void 0),g=p}m=h,v=u,f=p,++b}}2===c&&(r?(r=!1,t=null,i=null,o=null,n=null,a=void 0):(r=!0,t=2,i=void 0,o=void 0,n=void 0,a=this.ribbonthickness)),t=t||this.strandDIV,i=i||this.axisDIV,o=o||this.coilWidth,s=s||!1,n=n||this.helixSheetWidth;for(var H={},_=0;_<t;++_)H[_]=[];var I,D,O,A,L=[],M=[],P=[],k=[],N=[],z=null,j=null,F=null,U=null,V=null,B=null,G=null,q=null,W=!1,$=null,Y=null,v=null,X=null,Q=null,Z=!1,K=!1,J={};this.bCalphaOnly=this.isCalphaPhosOnly(l);var ee={};for(var T in l){var A=l[T];R=A.structure+"_"+A.chain+"_"+A.resi,ee[R]=1}var te=Object.keys(ee).length,ie=0,re=0,oe=Object.keys(this.hAtoms).length==Object.keys(this.atoms).length,ne=[];for(var T in l){A=l[T];if(("O"===A.name||"CA"===A.name)&&!A.het&&("CA"===A.name&&(e.hasOwnProperty(T)&&("helix"!==A.ss&&"sheet"!==A.ss||A.ssend||A.ssbegin)&&(J[T]=A),z=A.coord,F=A.color,X=A.serial,ne.push(A.serial)),"O"===A.name||this.bCalphaOnly&&"CA"===A.name)){null!==z&&void 0!==z||(z=A.coord,F=A.color,X=A.serial),"O"===A.name&&(j=A.coord);var se=!0;if(I!==A.chain&&(se=!1),A.ssend&&"sheet"===A.ss?Z=!0:A.ssend&&"helix"===A.ss&&(K=!0),V){1===c||2===c?N.push(this.hColor):N.push(B),O="coil"!==q&&"coil"===A.ss?o:W&&A.ssbegin?o:"coil"===q?o:n;var ae,ce,de=4;"O"===A.name?(ae=V.clone(),null!==U&&void 0!==U?ae.sub(U):(U=V.clone(),ne.length>de+1?(ae=U.clone(),ce=this.atoms[ne[ne.length-1-de-1]].coord.clone(),ae.sub(ce)):ae=new THREE.Vector3(Math.random(),Math.random(),Math.random()))):this.bCalphaOnly&&"CA"===A.name&&(ne.length>de+1?(ae=U.clone(),ce=this.atoms[ne[ne.length-1-de-1]].coord.clone(),ae.sub(ce)):ae=new THREE.Vector3(Math.random(),Math.random(),Math.random())),ae.normalize(),ae.multiplyScalar(O),null!==G&&ae.dot(G)<0&&ae.negate(),G=ae;for(var le=0,he=2/(t-1);le<t;++le){var ue=-1+he*le,pe=new THREE.Vector3(U.x+G.x*ue,U.y+G.y*ue,U.z+G.z*ue);s||"sheet"!==q||(pe.smoothen=!0),H[le].push(pe)}L.push(U),M.push(G),e.hasOwnProperty(Y)?(P.push(v),k.push(Q),++re):(P.push(0),k.push(0)),++ie}if((A.ssbegin||A.ssend||ie===te-1)&&H[0].length>0&&se){var me="CA",ve=[],fe=[],ge=this.atoms[Y].structure+"_"+this.atoms[Y].chain+"_"+(this.atoms[Y].resi-1).toString(),ye=this.getAtomCoordFromResi(ge,me);ve=void 0!==ye?[ye]:[];var be=this.atoms[Y].structure+"_"+this.atoms[Y].chain+"_"+(this.atoms[Y].resi+1).toString(),Ee=this.getAtomCoordFromResi(be,me);void 0!==Ee&&fe.push(Ee);var Ce=this.atoms[Y].structure+"_"+this.atoms[Y].chain+"_"+(this.atoms[Y].resi+2).toString(),we=this.getAtomCoordFromResi(Ce,me);void 0!==we&&fe.push(we),1===c||2===c?N.push(this.hColor):N.push(B),O=A.ssend&&"sheet"===A.ss?0:"coil"===q&&A.ssbegin?o:W&&A.ssbegin?o:"coil"===A.ss?o:n;var ae,ce,de=4;"O"===A.name?(ae=j.clone(),
ae.sub(z)):this.bCalphaOnly&&"CA"===A.name&&(ne.length>de?(ae=z.clone(),ce=this.atoms[ne[ne.length-1-de]].coord.clone(),ae.sub(ce)):ae=new THREE.Vector3(Math.random(),Math.random(),Math.random())),ae.normalize(),ae.multiplyScalar(O),null!==G&&ae.dot(G)<0&&ae.negate(),G=ae;for(var le=0,he=2/(t-1);le<t;++le){var ue=-1+he*le,pe=new THREE.Vector3(z.x+G.x*ue,z.y+G.y*ue,z.z+G.z*ue);s||"sheet"!==q||(pe.smoothen=!0),H[le].push(pe)}$=A.serial,L.push(z),M.push(G),e.hasOwnProperty($)?(P.push(A.resi),k.push(X)):(P.push(0),k.push(0));for(var le=0;!r&&le<t;++le)Z?this.createCurveSubArrow(H[le],1,N,i,c,d,t,le,L,M,P,k,!0,ve,fe):K&&(oe?this.createCurveSub(H[le],1,N,i,c,d,!1,P,k,void 0,ve,fe):this.createCurveSubArrow(H[le],1,N,i,c,d,t,le,L,M,P,k,!1,ve,fe));if(r)if(Z){var Te=0,Re=t-1;this.createStripArrow(H[0],H[t-1],N,i,a,c,t,Te,Re,L,M,P,k,!0,ve,fe)}else if(K)if(oe)this.createStrip(H[0],H[t-1],N,i,a,c,!1,P,k,void 0,ve,fe);else{var Te=0,Re=t-1;this.createStripArrow(H[0],H[t-1],N,i,a,c,t,Te,Re,L,M,P,k,!0,ve,fe)}else 2===c&&this.createStrip(H[0],H[t-1],N,i,a,c,!1,P,k,void 0,ve,fe);for(var _=0;_<t;++_)H[_]=[];N=[],L=[],M=[],P=[],k=[],Z=!1,K=!1}if(I!==A.chain&&H[0].length>0){for(var me="CA",ge=this.atoms[Y].structure+"_"+this.atoms[Y].chain+"_"+(this.atoms[Y].resi-1).toString(),ye=this.getAtomCoordFromResi(ge,me),ve=void 0!==ye?[ye]:[],fe=[],le=0;!r&&le<t;++le)Z?this.createCurveSubArrow(H[le],1,N,i,c,d,t,le,L,M,P,k,!0,ve,fe):K&&(oe?this.createCurveSub(H[le],1,N,i,c,d,!1,P,k,void 0,ve,fe):this.createCurveSubArrow(H[le],1,N,i,c,d,t,le,L,M,P,k,!1,ve,fe));if(r)if(Z){var Te=0,Re=t-1;this.createStripArrow(H[0],H[t-1],N,i,a,c,t,Te,Re,L,M,P,k,!0,ve,fe)}else if(K)if(oe)this.createStrip(H[0],H[t-1],N,i,a,c,!1,P,k,void 0,ve,fe);else{var Te=0,Re=t-1;this.createStripArrow(H[0],H[t-1],N,i,a,c,t,Te,Re,L,M,P,k,!1,ve,fe)}for(var _=0;_<t;++_)H[_]=[];N=[],L=[],M=[],P=[],k=[],Z=!1,K=!1}I=A.chain,D=A.resi,q=A.ss,W=A.ssend,Y=A.serial,v=A.resi,Q=X,U=z,V=A.coord,B=F}}ne=[],this.createTube(J,"CA",o,c),J={},H={}},iCn3D.prototype.createTubeSub=function(e,t,i,r,o,n){if(!(e.length<2)){var s=this.tubeDIV,a=this.axisDIV,c=1/s,d=1/a,l=new THREE.Geometry,h=this.subdivide(e,t,a,void 0,void 0,o,n),u=h[0];t=h[2];for(var p,m=new THREE.Vector3,v=0,f=u.length;v<f;++v){var g,y=(v-1)*d;if(0===v)g=i[0];else if(y%1===0)g=i[y];else{var b=Math.floor(y),E=y-b;g=i[b]*E+i[b+1]*(1-E)}var C,w,T;v<f-1?(C=u[v].clone().sub(u[v+1]),w=new THREE.Vector3(0,(-C.z),C.y).normalize().multiplyScalar(g),T=C.clone().cross(w).normalize().multiplyScalar(g),m.dot(w)<0&&(w.negate(),T.negate()),m=w,p=T):(w=m,T=p);for(var R=0;R<s;++R){var A=2*Math.PI*c*R;l.vertices.push(u[v].clone().add(w.clone().multiplyScalar(Math.cos(A))).add(T.clone().multiplyScalar(Math.sin(A))))}}for(var S=0,v=0,f=u.length-1;v<f;++v){var x=new THREE.Color(t[v]),H=0,_=l.vertices[S].clone().sub(l.vertices[S+s]).lengthSq(),I=l.vertices[S].clone().sub(l.vertices[S+s+1]).lengthSq();_>I&&(_=I,H=1);for(var R=0;R<s;++R)l.faces.push(new THREE.Face3(S+R,S+(R+H)%s+s,S+(R+1)%s,(void 0),x)),l.faces.push(new THREE.Face3(S+(R+1)%s,S+(R+H)%s+s,S+(R+H+1)%s+s,(void 0),x));S+=s}l.computeFaceNormals(),l.computeVertexNormals(!1);var D;2===r?(D=new THREE.Mesh(l,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(D)):1===r?(D=new THREE.Mesh(l,this.matShader),D.renderOrder=this.renderOrderPicking,this.mdl.add(D)):(D=new THREE.Mesh(l,new THREE.MeshPhongMaterial({specular:this.frac,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(D)),1===r||2===r?this.prevHighlightObjects.push(D):this.objects.push(D)}},iCn3D.prototype.getAtomCoordFromResi=function(e,t){if(this.residues.hasOwnProperty(e))for(var i in this.residues[e])if(this.atoms[i].name===t&&!this.atoms[i].het){var r=void 0!==this.atoms[i].coord2?this.atoms[i].coord2:this.atoms[i].coord;return r}},iCn3D.prototype.createTube=function(e,t,i,r){var o,n,s,a,c,d=[],l=[],h=[],u=[],p=[],m=0,v=6,f=3,g=[];for(var y in e)if(c=e[y],c.name===t&&!c.het){if(0==m&&(a=c),m>0&&(o!==c.chain||Math.abs(c.coord.x-s.coord.x)>v||Math.abs(c.coord.y-s.coord.y)>v||Math.abs(c.coord.z-s.coord.z)>v||n+1!==c.resi&&(Math.abs(c.coord.x-s.coord.x)>f||Math.abs(c.coord.y-s.coord.y)>f||Math.abs(c.coord.z-s.coord.z)>f))){if(2!==r){var b=a.structure+"_"+a.chain+"_"+(a.resi-1).toString(),E=this.getAtomCoordFromResi(b,t);u=void 0!==E?[E]:[];var C=s.structure+"_"+s.chain+"_"+(s.resi+1).toString(),w=this.getAtomCoordFromResi(C,t);void 0!==w&&p.push(w);var T=s.structure+"_"+s.chain+"_"+(s.resi+2).toString(),R=this.getAtomCoordFromResi(T,t);void 0!==R&&p.push(R),g.push({pnts:d,colors:l,radii:h,prevone:u,nexttwo:p})}d=[],l=[],h=[],u=[],p=[],a=c,m=0}d.push(c.coord);var A=i;A=i?i:c.b>0&&c.b<=100?.01*c.b:c.b>100?1:this.coilWidth,h.push(A),l.push(c.color),1===m&&(l[l.length-2]=c.color),o=c.chain,n=c.resi;var S=1.2;2!==r||c.ssbegin||this.createBox(c,void 0,void 0,S,void 0,r),++m,s=c}if(2!==r){if(u=[],void 0!==a){var b=a.structure+"_"+a.chain+"_"+(a.resi-1).toString(),E=this.getAtomCoordFromResi(b,t);u=void 0!==E?[E]:[]}if(p=[],void 0!==c){var C=c.structure+"_"+c.chain+"_"+(c.resi+1).toString(),w=this.getAtomCoordFromResi(C,t);void 0!==w&&p.push(w);var T=c.structure+"_"+c.chain+"_"+(c.resi+2).toString(),R=this.getAtomCoordFromResi(T,t);void 0!==R&&p.push(R)}g.push({pnts:d,colors:l,radii:h,prevone:u,nexttwo:p})}for(var y=0,x=g.length;y<x;++y){var d=g[y].pnts,l=g[y].colors,h=g[y].radii,u=g[y].prevone,p=g[y].nexttwo;this.createTubeSub(d,l,h,r,u,p)}g=[]},iCn3D.prototype.createCylinderHelix=function(e,t,i){var r,o,n,s=null,a={},c={};for(n in e){var d=e[n];d.het||(("helix"!==d.ss&&"sheet"!==d.ss||d.ssend||d.ssbegin)&&(a[d.serial]=d),"sheet"===d.ss&&(c[d.serial]=d),"CA"===d.name&&("helix"===d.ss&&d.ssend&&(null!==s&&r===d.chain&&o<d.resi&&(1===i||2===i?this.createCylinder(s.coord,d.coord,t,this.hColor,i):this.createCylinder(s.coord,d.coord,t,d.color)),s=null),null===s&&"helix"===d.ss&&d.ssbegin&&(s=d,r=d.chain,o=d.resi)))}1===i||2===i?(Object.keys(a).length>0&&this.createTube(a,"CA",this.coilWidth,i),Object.keys(c).length>0&&this.createStrand(c,void 0,void 0,!0,0,this.helixSheetWidth,!1,2*this.ribbonthickness,i)):(Object.keys(a).length>0&&this.createTube(a,"CA",this.coilWidth),Object.keys(c).length>0&&this.createStrand(c,void 0,void 0,!0,0,this.helixSheetWidth,!1,2*this.ribbonthickness))},iCn3D.prototype.drawNucleicAcidStick=function(e,t){var i,r,o,n=null,s=null;for(o in e){var a=e[o];void 0===a||a.het||(a.resi===r&&a.chain===i||(null!==n&&null!==s&&this.createCylinder(new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z),new THREE.Vector3(s.coord.x,s.coord.y,s.coord.z),this.cylinderRadius,n.color,t),n=null,s=null),"O3'"!==a.name&&"O3*"!==a.name||(n=a),"  A"===a.resn||"  G"===a.resn||" DA"===a.resn||" DG"===a.resn?"N1"===a.name&&(s=a):"N3"===a.name&&(s=a),r=a.resi,i=a.chain)}null!==n&&null!==s&&this.createCylinder(new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z),new THREE.Vector3(s.coord.x,s.coord.y,s.coord.z),this.cylinderRadius,n.color,t)},iCn3D.prototype.isCalphaPhosOnly=function(e){var t=!1,i=0,r=50,o=0;for(var n in e){if(!(i<r))break;"CA"!==e[n].name&&"P"!==e[n].name&&"O3'"!==e[n].name&&"O3*"!==e[n].name&&++o,++i}return o<.5*i&&(t=!0),t},iCn3D.prototype.drawCartoonNucleicAcid=function(e,t,i,r){this.drawStrandNucleicAcid(e,2,t,!0,void 0,i,r)},iCn3D.prototype.drawStrandNucleicAcid=function(e,t,i,r,o,n,s){2===s&&(t=void 0,n=void 0),o=o||this.nucleicAcidWidth,i=i||this.axisDIV,t=t||this.nucleicAcidStrandDIV;var a,c,d,l=[];for(d=0;d<t;d++)l[d]=[];var h,u,p,m=[],v=null;for(a in e){var f=e[a];if(void 0!==f&&("O3'"===f.name||"OP2"===f.name||"O3*"===f.name||"O2P"===f.name)&&!f.het)if("O3'"===f.name||"O3*"===f.name){if(h!==f.chain||u+1!==f.resi){if(p&&v)for(c=0;c<t;c++){var g=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(p.x+v.x*g,p.y+v.y*g,p.z+v.z*g))}for(r&&this.createStrip(l[0],l[1],m,i,n,s),c=0;!n&&c<t;c++)this.createCurveSub(l[c],1,m,i,s);var l=[];for(d=0;d<t;d++)l[d]=[];m=[],v=null}p=new THREE.Vector3(f.coord.x,f.coord.y,f.coord.z),h=f.chain,u=f.resi,1===s||2===s?m.push(this.hColor):m.push(f.color)}else if("OP2"===f.name||"O2P"===f.name){if(!p){v=null;continue}var y=new THREE.Vector3(f.coord.x,f.coord.y,f.coord.z);for(y.sub(p),y.normalize().multiplyScalar(o),null!==v&&y.dot(v)<0&&y.negate(),v=y,c=0;c<t;c++){var g=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(p.x+v.x*g,p.y+v.y*g,p.z+v.z*g))}p=null}}if(p&&v)for(c=0;c<t;c++){var g=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(p.x+v.x*g,p.y+v.y*g,p.z+v.z*g))}for(r&&this.createStrip(l[0],l[1],m,i,n,s),c=0;!n&&c<t;c++)this.createCurveSub(l[c],1,m,i,s)},iCn3D.prototype.createSingleLine=function(e,t,i,r,o){var n,s=new THREE.Geometry;n=r?new THREE.LineDashedMaterial({linewidth:1,color:i,dashSize:o,gapSize:.5*o}):new THREE.LineBasicMaterial({linewidth:1,color:i}),s.vertices.push(e),s.vertices.push(t),r&&s.computeLineDistances();var a=new THREE.LineSegments(s,n);return a},iCn3D.prototype.createBox=function(e,t,i,r,o,n){var s;void 0===t&&(t=.8),void 0===i&&(i=!1),void 0===r&&(r=.8),n?(void 0===o&&(o=this.hColor),s=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,specular:this.frac,shininess:30,emissive:0,color:o}))):(void 0===o&&(o=e.color),s=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({specular:this.frac,shininess:30,emissive:0,color:o}))),s.scale.x=s.scale.y=s.scale.z=i?t:(this.vdwRadii[e.elem]||t)*(r?r:1),s.position.copy(e.coord),this.mdl.add(s),n?this.prevHighlightObjects.push(s):this.objects.push(s)},iCn3D.prototype.makeTextSprite=function(e,t){void 0===t&&(t={});var i=t.hasOwnProperty("fontface")?t.fontface:"Arial",r=t.hasOwnProperty("fontsize")?t.fontsize:18,o=t.hasOwnProperty("alpha")?t.alpha:1,n=!0,s=!1;t.hasOwnProperty("bSchematic")&&t.bSchematic&&(s=!0,r=40);var a,c,d;t.hasOwnProperty("backgroundColor")&&void 0!==t.backgroundColor?(a=this.hexToRgb(t.backgroundColor,o),c=t.hasOwnProperty("borderColor")?this.hexToRgb(t.borderColor,o):{r:0,g:0,b:0,a:1},d=t.hasOwnProperty("borderThickness")?t.borderThickness:4):(n=!1,a=void 0,c=void 0,d=0);var l=1,h=t.hasOwnProperty("textColor")&&void 0!==t.textColor?this.hexToRgb(t.textColor,l):{r:255,g:255,b:0,a:1},u=document.createElement("canvas"),p=u.getContext("2d");p.font="Bold "+r+"px "+i;var m=p.measureText(e),v=m.width,f=v+2*d,g=r+2*d;s&&(f>g?g=f:f=g);var y=s?3*this.maxD/100:3*this.maxD/100,b=.8*v/g;if(u.width=f,u.height=g,p.clearRect(0,0,f,g),n)if(p.fillStyle="rgba("+a.r+","+a.g+","+a.b+","+a.a+")",p.strokeStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")",p.lineWidth=d,s){var E=.35*f;this.circle(p,0,0,f,g,E)}else{var E=0;this.roundRect(p,0,0,f,g,E)}p.font="Bold "+r+"px "+i,p.textAlign="center",p.textBaseline="middle",p.fillStyle="rgba("+h.r+", "+h.g+", "+h.b+", 1.0)",p.strokeStyle="rgba("+h.r+", "+h.g+", "+h.b+", 1.0)",p.fillText(e,.5*f,.5*g);var C=new THREE.Texture(u);C.needsUpdate=!0;var w=!0,T=new THREE.SpriteMaterial({map:C,depthTest:!w,depthWrite:!w});T.map.minFilter=THREE.LinearFilter;var R=new THREE.Sprite(T);return s?R.scale.set(y,y,1):R.scale.set(b*y,y,1),R},iCn3D.prototype.roundRect=function(e,t,i,r,o,n){e.beginPath(),e.moveTo(t+n,i),e.lineTo(t+r-n,i),e.quadraticCurveTo(t+r,i,t+r,i+n),e.lineTo(t+r,i+o-n),e.quadraticCurveTo(t+r,i+o,t+r-n,i+o),e.lineTo(t+n,i+o),e.quadraticCurveTo(t,i+o,t,i+o-n),e.lineTo(t,i+n),e.quadraticCurveTo(t,i,t+n,i),e.closePath(),e.fill(),e.stroke()},iCn3D.prototype.circle=function(e,t,i,r,o,n){e.beginPath(),e.arc(t+r/2,i+o/2,n,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke()},iCn3D.prototype.createLabelRepresentation=function(e){this.maxD;for(var t in e)for(var i=void 0!==e[t]?e[t]:[],r=0,o=i.length;r<o;++r){var n=i[r];0==n.size&&(n.size=void 0),0==n.color&&(n.color=void 0),0==n.background&&(n.background=void 0);var s=void 0!==n.size?n.size:this.LABELSIZE,a=void 0!==n.color?n.color:"#ffff00",c=void 0!==n.background?n.background:"#cccccc",d=void 0!==n.alpha?n.alpha:1;c=n.background,void 0!==a&&void 0!==c&&a.toLowerCase()===c.toLowerCase()&&(a="#888888");var l=!1,h=!1;if(Object.keys(this.proteins).length+Object.keys(this.nucleotides).length>0){var u=this.getFirstAtomObj(this.hAtoms);void 0!==u&&((this.chemicals.hasOwnProperty(u.serial)||"c alpha trace"==u.style||"o3 trace"==u.style)&&(l=!0),"stick"!=u.style&&"ball and stick"!=u.style||(h=!0))}var p;p=void 0!==n.bSchematic&&n.bSchematic?this.makeTextSprite(n.text,{fontsize:parseInt(s),textColor:a,borderColor:c,backgroundColor:c,alpha:d,bSchematic:1}):1===n.text.length?this.makeTextSprite(n.text,{fontsize:parseInt(s),textColor:a,borderColor:c,backgroundColor:c,alpha:d,bSchematic:1}):this.makeTextSprite(n.text,{fontsize:parseInt(s),textColor:a,borderColor:c,backgroundColor:c,alpha:d,bSchematic:0}),p.position.set(n.position.x,n.position.y,n.position.z),this.mdl.add(p)}},iCn3D.prototype.setAtmClr=function(e,t){for(var i in e){var r=this.atoms[i];r.color=(new THREE.Color).setHex(t),this.atomPrevColors[i]=r.color}},iCn3D.prototype.updateChainsColor=function(e){var t=e.structure+"_"+e.chain;void 0!==this.chainsColor[t]&&(this.chainsColor[t]=e.color)},iCn3D.prototype.setMmdbChainColor=function(e){var t=void 0===e?this.hAtoms:e;this.applyOriginalColor(this.hash2Atoms(t));var i=this.unionHash(this.chemicals,this.ions);for(var r in i){var o=this.atoms[r];o.color=this.atomColors[o.elem]||this.defaultAtomColor,this.atomPrevColors[r]=o.color}},iCn3D.prototype.setConservationColor=function(e,t){this.setMmdbChainColor(e);for(var i in this.alnChainsSeq)for(var r=this.alnChainsSeq[i],o=0,n=r.length;o<n;++o){var s=i+"_"+r[o].resi;for(var a in this.residues[s])if(e.hasOwnProperty(a)){var c=t?new THREE.Color(r[o].color):new THREE.Color(r[o].color2);this.atoms[a].color=c,this.atomPrevColors[a]=c}}},iCn3D.prototype.setColorByOptions=function(e,t,i){if(void 0!==e)if(void 0!==i&&i)for(var r in t){var o=this.atoms[r];this.atomPrevColors[r]=o.color}else if(0===e.color.indexOf("#"))for(var r in t){var o=this.atoms[r];o.color=(new THREE.Color).setStyle(e.color.toLowerCase()),this.atomPrevColors[r]=o.color}else switch(e.color.toLowerCase()){case"spectrum":var n=0,a=0;for(var r in t){var o=this.atoms[r];o.het||++a}var c=1/a;for(var r in t){var o=this.atoms[r];o.color=o.het?this.atomColors[o.elem]||this.defaultAtomColor:(new THREE.Color).setHSL(2/3*(1-n++*c),1,.45),this.atomPrevColors[r]=o.color}break;case"chain":if(void 0!==this.chainsColor&&Object.keys(this.chainsColor).length>0)this.setMmdbChainColor();else{var d=-1,l="",h=this.stdChainColors.length;for(var r in t){var o=this.atoms[r];o.chain!=l&&(++d,d%=h),o.color=this.stdChainColors[d],Object.keys(this.chainsColor).length>0&&this.updateChainsColor(o),this.atomPrevColors[r]=o.color,l=o.chain}}break;case"secondary structure":this.sheetcolor="green";for(var r in t){var o=this.atoms[r];o.color=o.het?this.atomColors[o.elem]||this.defaultAtomColor:this.ssColors[o.ss]||new THREE.Color(16711935),this.atomPrevColors[r]=o.color}break;case"secondary structure yellow":this.sheetcolor="yellow";for(var r in t){var o=this.atoms[r];o.color=o.het?this.atomColors[o.elem]||this.defaultAtomColor:this.ssColors2[o.ss]||new THREE.Color(16711935),this.atomPrevColors[r]=o.color}break;case"residue":for(var r in t){var o=this.atoms[r];o.color=o.het?this.atomColors[o.elem]||this.defaultAtomColor:this.residueColors[o.resn]||this.defaultResidueColor,this.atomPrevColors[r]=o.color}break;case"charge":for(var r in t){var o=this.atoms[r];o.color=o.het?this.defaultAtomColor:this.chargeColors[o.resn]||this.defaultResidueColor,this.atomPrevColors[r]=o.color}break;case"hydrophobic":for(var r in t){var o=this.atoms[r];o.color=o.het?this.defaultAtomColor:this.hydrophobicColors[o.resn]||this.defaultResidueColor,this.atomPrevColors[r]=o.color}break;case"atom":for(var r in t){var o=this.atoms[r];o.color=this.atomColors[o.elem]||this.defaultAtomColor,this.atomPrevColors[r]=o.color}break;case"b factor":this.middB=50,this.spanBinv1=.02,this.spanBinv2=.02;for(var r in t){var o=this.atoms[r];if(void 0===o.b||0==parseInt(1e3*o.b))o.color=(new THREE.Color).setRGB(0,1,0);else{var u=o.b;u>100&&(u=100),o.color=u<this.middB?(new THREE.Color).setRGB(1-(s=(this.middB-u)*this.spanBinv1),1-s,1):(new THREE.Color).setRGB(1,1-(s=(u-this.middB)*this.spanBinv2),1-s)}this.atomPrevColors[r]=o.color}break;case"b factor percentile":var p=1e3,m=-1e3;if(!this.bfactorArray){this.bfactorArray=[];for(var r in this.atoms){var o=this.atoms[r];p>o.b&&(p=o.b),m<o.b&&(m=o.b),this.bfactorArray.push(o.b)}this.bfactorArray.sort(function(e,t){return e-t})}var v=this.bfactorArray.length;for(var r in t){var o=this.atoms[r];if(void 0===o.b||0==parseInt(1e3*o.b)||0==this.bfactorArray.length)o.color=(new THREE.Color).setRGB(0,1,0);else{var f=this.bfactorArray.indexOf(o.b)/v;o.color=f<.5?(new THREE.Color).setRGB(2*f,2*f,1):(new THREE.Color).setRGB(1,2*(1-f),2*(1-f))}this.atomPrevColors[r]=o.color}break;case"identity":this.setConservationColor(t,!0);break;case"conserved":this.setConservationColor(t,!0);break;case"conservation":this.setConservationColor(t,!1);break;case"white":this.setAtmClr(t,16777215);break;case"grey":this.setAtmClr(t,8947848);break;case"red":this.setAtmClr(t,16711680);break;case"green":this.setAtmClr(t,65280);break;case"blue":this.setAtmClr(t,255);break;case"magenta":this.setAtmClr(t,16711935);break;case"yellow":this.setAtmClr(t,16776960);break;case"cyan":this.setAtmClr(t,65535);break;case"custom":break;default:for(var r in t){var o=this.atoms[r];o.color=(new THREE.Color).setStyle("#"+e.color.toLowerCase()),this.atomPrevColors[r]=o.color}}},iCn3D.prototype.applyDisplayOptions=function(e,t,i){var r=this;void 0===e&&(e=this.opts);var o,n={},s={},a={};if(1===i&&Object.keys(t).length<Object.keys(this.atoms).length){a=this.hash2Atoms(t),n=r.getResiduesFromAtoms(t);for(var c in n){o=c;var d=c.lastIndexOf("_"),l=c.substr(0,d+1),h=parseInt(c.substr(d+1)),u=l+(h-1).toString(),p=l+(h+1).toString();n.hasOwnProperty(u)||n.hasOwnProperty(u)||(s[c]=1)}if(1===Object.keys(a).length&&Object.keys(this.residues[o]).length>1&&"sphere"!==a[Object.keys(a)[0]].style&&"dot"!==a[Object.keys(a)[0]].style){if(void 0===this.bCid||!this.bCid)for(var c in a){var m=a[c],v=1;this.createBox(m,void 0,void 0,v,void 0,i)}}else for(var o in s){var f=this.getFirstCalphaAtomObj(this.residues[o]),m=f,u=m.structure+"_"+m.chain+"_"+parseInt(m.resi-1),p=m.structure+"_"+m.chain+"_"+parseInt(m.resi+1);if("cylinder and plate"===m.style&&"helix"===m.ss)for(var c in this.residues[o]){var m=this.atoms[c],v=1;this.createBox(m,void 0,void 0,v,void 0,i)}else if("ribbon"===m.style&&"coil"===m.ss||"strand"===m.style&&"coil"===m.ss||"o3 trace"===m.style||"schematic"===m.style||"c alpha trace"===m.style||"b factor tube"===m.style||"cylinder and plate"===m.style&&"helix"!==m.ss){if(void 0!==f&&void 0!==f.style2&&"nothing"!==f.style2)continue;var g=!1;if(!g&&this.residues.hasOwnProperty(p)){var y=Object.keys(this.residues[p])[0],b=this.hash2Atoms(this.residues[p])[y];if(m.style===b.style&&!b.ssbegin||b.ssbegin){var E=this.residues[p];if(t=this.unionHash(t,E),g=!0,b.ssbegin)for(var c in E)this.atoms[c].notshow=!0}}if(!g&&this.residues.hasOwnProperty(u)){var y=Object.keys(this.residues[u])[0],b=this.hash2Atoms(this.residues[u])[y];m.style===b.style&&(t=this.unionHash(t,this.residues[u]),g=!0)}}else if("ribbon"===m.style&&"coil"!==m.ss&&m.ssend||"strand"===m.style&&"coil"!==m.ss&&m.ssend){if(void 0!==f&&void 0!==f.style2&&"nothing"!==f.style2)continue;var g=!1;if(!g&&this.residues.hasOwnProperty(p)){var y=Object.keys(this.residues[p])[0],b=this.hash2Atoms(this.residues[p])[y];t=this.unionHash(t,this.residues[p]),g=!0}}}a={}}this.setStyle2Atoms(t),this.bAllAtoms=!1,t&&void 0!==t&&(this.bAllAtoms=Object.keys(t).length===Object.keys(this.atoms).length);var C=.5*this.cylinderRadius;void 0!==this.labels&&delete this.labels.schematic;var w=!1;if(i){var T=this.getResiduesFromCalphaAtoms(this.hAtoms),R=this.intHash(this.hAtoms,this.proteins),n=this.getResiduesFromAtoms(R);Object.keys(n)>Object.keys(T)&&(w=!0)}for(var A in this.style2atoms){var S=this.style2atoms[A],x=this.isCalphaPhosOnly(this.hash2Atoms(S));if("ribbon"!==A||i&&(!i||w))if("strand"!==A||i&&(!i||w))if("cylinder and plate"!==A||i&&(!i||w))if("nucleotide cartoon"===A)x?this.createCylinderCurve(this.hash2Atoms(S),["P"],this.traceRadius,!1,i):(this.drawCartoonNucleicAcid(this.hash2Atoms(S),null,this.ribbonthickness,i),2!==i&&this.drawNucleicAcidStick(this.hash2Atoms(S),i));else if("o3 trace"===A)x?this.createCylinderCurve(this.hash2Atoms(S),["P"],this.traceRadius,!1,i):this.createCylinderCurve(this.hash2Atoms(S),["O3'","O3*"],this.traceRadius,!1,i);else if("schematic"===A){var H=this.getFirstAtomObj(S);this.chemicals.hasOwnProperty(H.serial)?(this.addNonCarbonAtomLabels(this.hash2Atoms(S)),bSchematic=!0,this.createStickRepresentation(this.hash2Atoms(S),C,C,void 0,i,bSchematic)):(this.addResiudeLabels(this.hash2Atoms(S),!0),x?this.createCylinderCurve(this.hash2Atoms(S),["P"],this.traceRadius,!1,i):this.createCylinderCurve(this.hash2Atoms(S),["O3'","O3*"],this.traceRadius,!1,i),this.createCylinderCurve(this.hash2Atoms(S),["CA"],this.traceRadius,!1,i))}else"c alpha trace"===A?this.createCylinderCurve(this.hash2Atoms(S),["CA"],this.traceRadius,!1,i):"b factor tube"===A?this.createTube(this.hash2Atoms(S),"CA",null,i):"lines"===A?1===i?this.createStickRepresentation(this.hash2Atoms(S),this.hlLineRadius,this.hlLineRadius,void 0,i):this.createLineRepresentation(this.hash2Atoms(S),i):"stick"===A?this.createStickRepresentation(this.hash2Atoms(S),this.cylinderRadius,this.cylinderRadius,void 0,i):"ball and stick"===A?this.createStickRepresentation(this.hash2Atoms(S),this.cylinderRadius,.5*this.cylinderRadius,this.dotSphereScale,i):"sphere"===A?this.createSphereRepresentation(this.hash2Atoms(S),this.sphereRadius,void 0,void 0,i):"dot"===A&&this.createSphereRepresentation(this.hash2Atoms(S),this.sphereRadius,!1,this.dotSphereScale,i);else this.createCylinderHelix(this.hash2Atoms(S),this.cylinderHelixRadius,i);else this.createStrand(this.hash2Atoms(S),null,null,null,null,null,!1,void 0,i);else this.createStrand(this.hash2Atoms(S),2,void 0,!0,void 0,void 0,!1,this.ribbonthickness,i)}this.cnt>this.maxmaxatomcnt&&this.init_base(),void 0!==this.labels&&Object.keys(this.labels).length>0&&(this.hideLabels(),this.createLabelRepresentation(this.labels))},iCn3D.prototype.hideLabels=function(){if(void 0!==this.mdl)for(var e=0,t=this.mdl.children.length;e<t;++e){var i=this.mdl.children[e];void 0!==i&&"Sprite"===i.type&&this.mdl.remove(i)}},iCn3D.prototype.setStyle2Atoms=function(e){this.style2atoms={};for(var t in e)void 0===this.style2atoms[this.atoms[t].style]&&(this.style2atoms[this.atoms[t].style]={}),this.style2atoms[this.atoms[t].style][t]=1,void 0!==this.atoms[t].style2&&"nothing"!==this.atoms[t].style2&&(void 0===this.style2atoms[this.atoms[t].style2]&&(this.style2atoms[this.atoms[t].style2]={}),this.style2atoms[this.atoms[t].style2][t]=1)},iCn3D.prototype.setAtomStyleByOptions=function(e){void 0===e&&(e=this.opts);var t;if(void 0!==e.proteins){t=this.intHash(this.hAtoms,this.proteins);for(var i in t)this.atoms[i].style=e.proteins.toLowerCase()}if(void 0!==e.sidec&&"nothing"!==e.sidec){t=this.intHash(this.hAtoms,this.sidec);for(var i in t)this.atoms[i].style2=e.sidec.toLowerCase()}if(void 0!==e.chemicals){t=this.intHash(this.hAtoms,this.chemicals);for(var i in t)this.atoms[i].style=e.chemicals.toLowerCase()}if(void 0!==e.ions){t=this.intHash(this.hAtoms,this.ions);for(var i in t)this.atoms[i].style=e.ions.toLowerCase()}if(void 0!==e.water){t=this.intHash(this.hAtoms,this.water);for(var i in t)this.atoms[i].style=e.water.toLowerCase()}if(void 0!==e.nucleotides){t=this.intHash(this.hAtoms,this.nucleotides);for(var i in t)this.atoms[i].style=e.nucleotides.toLowerCase()}},iCn3D.prototype.rebuildSceneBase=function(e){var t=this;if(jQuery.extend(t.opts,e),this.cam_z=2*this.maxD,void 0!==this.scene)for(var i=this.scene.children.length-1;i>=0;i--){var r=this.scene.children[i];this.scene.remove(r)}else this.scene=new THREE.Scene;if(void 0!==this.scene_ghost)for(var i=this.scene_ghost.children.length-1;i>=0;i--){var r=this.scene_ghost.children[i];this.scene_ghost.remove(r)}else this.scene_ghost=new THREE.Scene;this.directionalLight=new THREE.DirectionalLight(16777215,1),this.cam_z>0?this.directionalLight.position.set(0,0,1):this.directionalLight.position.set(0,0,-1);var o=new THREE.AmbientLight(4210752);this.scene.add(this.directionalLight),this.scene.add(o),this.mdl=new THREE.Object3D,this.mdlImpostor=new THREE.Object3D,this.scene.add(this.mdl),this.scene.add(this.mdlImpostor),this.mdl_ghost=new THREE.Object3D,this.scene_ghost.add(this.mdl_ghost),this.objects=[],this.objects_ghost=[],this.raycaster=new THREE.Raycaster,this.projector=new THREE.Projector,this.mouse=new THREE.Vector2;var n=this.backgroundColors[this.opts.background.toLowerCase()];"transparent"===this.opts.background.toLowerCase()?this.renderer.setClearColor(n,0):this.renderer.setClearColor(n,1),this.perspectiveCamera=new THREE.PerspectiveCamera(20,this.container.whratio,.1,1e4),this.perspectiveCamera.position.set(0,0,this.cam_z),this.perspectiveCamera.lookAt(new THREE.Vector3(0,0,0)),this.orthographicCamera=new THREE.OrthographicCamera,this.orthographicCamera.position.set(0,0,this.cam_z),this.orthographicCamera.lookAt(new THREE.Vector3(0,0,0)),this.cams={perspective:this.perspectiveCamera,orthographic:this.orthographicCamera}},iCn3D.prototype.setCamera=function(){if(this.cam=this.cams[this.opts.camera.toLowerCase()],this.cam===this.perspectiveCamera){var e=void 0!==this.biomtMatrices&&this.biomtMatrices.length*this.cnt>10*this.maxatomcnt?1:2;this.cam_z>0?this.cam.position.z=this.maxD*e:this.cam.position.z=-this.maxD*e,"yes"===this.opts.slab?this.cam.near=2*this.maxD:this.cam.near=.1,this.cam.far=1e4,this.controls=new THREE.TrackballControls(this.cam,document.getElementById(this.id),this)}else this.cam===this.orthographicCamera&&(void 0!==this.biomtMatrices&&this.biomtMatrices.length*this.cnt>10*this.maxatomcnt?this.cam.right=this.maxD/2*1.5:this.cam.right=this.maxD/2*2.5,this.cam.left=-this.cam.right,this.cam.top=this.cam.right/this.container.whratio,this.cam.bottom=-this.cam.right/this.container.whratio,"yes"===this.opts.slab?this.cam.near=2*this.maxD:this.cam.near=0,this.cam.far=1e4,this.controls=new THREE.OrthographicTrackballControls(this.cam,document.getElementById(this.id),this));this.cam.updateProjectionMatrix()},iCn3D.prototype.render=function(){this.directionalLight.position.copy(this.cam.position),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.render(this.scene,this.cam)},iCn3D.prototype.clearImpostors=function(){this.posArray=[],this.colorArray=[],this.pos2Array=[],this.color2Array=[],this.radiusArray=[],this.posArraySphere=[],this.colorArraySphere=[],this.radiusArraySphere=[]},iCn3D.prototype.applyTransformation=function(e,t,i){var r={};r.update=!1,r._zoomFactor=e,r.mouseChange=new THREE.Vector2,r.mouseChange.copy(t),r.quaternion=new THREE.Quaternion,r.quaternion.copy(i),this.controls.update(r)},iCn3D.prototype.applyCenterOptions=function(e){switch(void 0===e&&(e=this.opts),e.rotationcenter.toLowerCase()){case"molecule center":void 0!==this.center&&this.setRotationCenter(this.center);break;case"pick center":void 0!==this.pAtom&&this.setRotationCenter(this.pAtom.coord);break;case"display center":var t=this.centerAtoms(this.dAtoms).center;this.setRotationCenter(t);break;case"highlight center":var t=this.centerAtoms(this.hAtoms).center;this.setRotationCenter(t)}},iCn3D.prototype.setRotationCenter=function(e){this.mdl.position.set(0,0,0),this.mdlImpostor.position.set(0,0,0),this.mdl_ghost.position.set(0,0,0),this.mdl.position.sub(e),this.mdlImpostor.position.sub(e),this.mdl_ghost.position.sub(e)},iCn3D.prototype.applyOriginalColor=function(e){void 0===e&&(e=this.atoms);for(var t in e){var i=e[t],r=i.structure+"_"+i.chain;this.chainsColor.hasOwnProperty(r)?i.color=this.chainsColor[r]:i.color=this.atomColors[i.elem],this.atomPrevColors[t]=i.color}},iCn3D.prototype.onBeforeRender=function(e,t,i,r,o){var n=o.uniforms,s=[];if(n.objectId&&(n.objectId.value=SupportsReadPixelsFloat?this.id:this.id/255,s.push("objectId")),(n.modelViewMatrixInverse||n.modelViewMatrixInverseTranspose||n.modelViewProjectionMatrix||n.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,this.matrixWorld),n.modelViewMatrixInverse&&(n.modelViewMatrixInverse.value.getInverse(this.modelViewMatrix),s.push("modelViewMatrixInverse")),n.modelViewMatrixInverseTranspose&&(n.modelViewMatrixInverse?n.modelViewMatrixInverseTranspose.value.copy(n.modelViewMatrixInverse.value).transpose():n.modelViewMatrixInverseTranspose.value.getInverse(this.modelViewMatrix).transpose(),s.push("modelViewMatrixInverseTranspose")),n.modelViewProjectionMatrix&&(i.updateProjectionMatrix(),n.modelViewProjectionMatrix.value.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),s.push("modelViewProjectionMatrix")),n.modelViewProjectionMatrixInverse){var a=new THREE.Matrix4;n.modelViewProjectionMatrix?(a.copy(n.modelViewProjectionMatrix.value),n.modelViewProjectionMatrixInverse.value.getInverse(a)):(i.updateProjectionMatrix(),a.multiplyMatrices(i.projectionMatrix,this.modelViewMatrix),n.modelViewProjectionMatrixInverse.value.getInverse(a)),s.push("modelViewProjectionMatrixInverse")}if(n.projectionMatrix&&(i.updateProjectionMatrix(),n.projectionMatrix.value.copy(i.projectionMatrix),s.push("projectionMatrix")),n.projectionMatrixInverse&&(i.updateProjectionMatrix(),n.projectionMatrixInverse.value.getInverse(i.projectionMatrix),s.push("projectionMatrixInverse")),s.length){var c=e.properties.get(o);if(c.program){var d=e.getContext(),l=c.program;d.useProgram(l.program);var h=l.getUniforms();s.forEach(function(e){h.setValue(d,e,n[e].value)})}}},iCn3D.prototype.setParametersForShader=function(e){var t=this.backgroundColors[this.opts.background.toLowerCase()],i=1.5*this.maxD,r=3*this.maxD,o=void 0!==e?e:1;this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,{modelViewMatrix:{value:new THREE.Matrix4},modelViewMatrixInverse:{value:new THREE.Matrix4},modelViewMatrixInverseTranspose:{value:new THREE.Matrix4},modelViewProjectionMatrix:{value:new THREE.Matrix4},modelViewProjectionMatrixInverse:{value:new THREE.Matrix4},projectionMatrix:{value:new THREE.Matrix4},projectionMatrixInverse:{value:new THREE.Matrix4},diffuse:{type:"v3",value:[1,1,1]},emissive:{type:"v3",value:[0,0,0]},roughness:{type:"f",value:.5},metalness:{type:"f",value:.3},opacity:{type:"f",value:o},nearClip:{type:"f",value:.1},ortho:{type:"f",value:0},shrink:{type:"f",value:.13},fogColor:{type:"v3",value:[t.r,t.g,t.b]},fogNear:{type:"f",value:i},fogFar:{type:"f",value:r},fogDensity:{type:"f",value:2}},THREE.UniformsLib.ambient,THREE.UniformsLib.lights]),this.defines={USE_COLOR:1,NEAR_CLIP:1,CAP:1},"yes"===this.opts.fog&&(this.defines.USE_FOG=1,"orthographic"===this.opts.camera&&(this.defines.FOG_EXP2=1)),this.bExtFragDepth&&(this.defines.USE_LOGDEPTHBUF_EXT=1)},iCn3D.prototype.drawImpostorShader=function(){this.setParametersForShader(),this.createImpostorShaderSphere("SphereImpostor"),this.createImpostorShaderCylinder("CylinderImpostor")},iCn3D.prototype.getShader=function(e){var t=$NGL_shaderTextHash[e],i=/#include\s+(\S+)/gim;return t=t.replace(i,function(e,t){var i;return THREE.ShaderChunk.hasOwnProperty(t)&&(i=THREE.ShaderChunk[t]),i?i:""})},iCn3D.prototype.createImpostorShaderBase=function(e,t,i,r,o,n,s,a,c){var d=this,l=new THREE.ShaderMaterial({defines:d.defines,uniforms:d.uniforms,vertexShader:d.getShader(e+".vert"),fragmentShader:d.getShader(e+".frag"),depthTest:!0,depthWrite:!0,needsUpdate:!0,lights:!0});l.extensions.fragDepth=!0,"CylinderImpostor"==e?this.CylinderImpostorMaterial=l:"SphereImpostor"==e&&(this.SphereImpostorMaterial=l);for(var h,u,p=n*s,m=n*a,v=p>65535?Uint32Array:Uint16Array,f=new v(m),g=0;g<n;g++){h=g*a,u=g*s,f.set(i,h);for(var y=0;y<a;++y)f[h+y]+=u;
}var b=new THREE.BufferGeometry,E=!0;f&&(b.setIndex(new THREE.BufferAttribute(f,1)),b.getIndex().setDynamic(E));var C={f:1,v2:2,v3:3,c:3};for(var w in o){var T,R=o[w];T=new Float32Array(p*C[R.type]),b.addAttribute(w,new THREE.BufferAttribute(T,C[R.type]).setDynamic(E))}var R,A,S,x,H,_,I=b.attributes;for(var w in r){A=r[w],R=I[w],S=R.itemSize,x=R.array;for(var D=0;D<n;++D){m=D*S,H=m*s;for(var O=0;O<s;++O){_=H+S*O;for(var L=0;L<S;++L)x[_+L]=A[m+L]}}R.needsUpdate=!0}for(var M=b.attributes.mapping.array,g=0;g<n;g++)M.set(t,g*c*s);var P=new THREE.Mesh(b,l);P.frustumCulled=!1,P.scale.x=P.scale.y=P.scale.z=1,"CylinderImpostor"==e?P.type="Cylinder":"SphereImpostor"==e&&(P.type="Sphere"),P.onBeforeRender=this.onBeforeRender,this.mdlImpostor.add(P)},iCn3D.prototype.createImpostorShaderCylinder=function(e){var t=this,i=new Float32Array(t.posArray),r=new Float32Array(t.colorArray),o=new Float32Array(t.pos2Array),n=new Float32Array(t.color2Array),s=new Float32Array(t.radiusArray),a=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),c=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]),d=12,l="v3",h=6,u=3,p=i.length/3,m={position1:i,color:r,position2:o,color2:n,radius:s},v={position1:{type:"v3",value:null},color:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:l,value:null}};this.createImpostorShaderBase(e,a,c,m,v,p,h,d,u),m=null,i=null,r=null,o=null,n=null,s=null,t.posArray=null,t.colorArray=null,t.pos2Array=null,t.color2Array=null,t.radiusArray=null},iCn3D.prototype.createImpostorShaderSphere=function(e){var t=this,i=new Float32Array(t.posArraySphere),r=new Float32Array(t.colorArraySphere),o=new Float32Array(t.radiusArraySphere),n=new Float32Array([-1,1,-1,-1,1,1,1,-1]),s=new Uint16Array([0,1,2,1,3,2]),a=6,c="v2",d=4,l=2,h=i.length/3,u={position:i,color:r,radius:o},p={position:{type:"v3",value:null},color:{type:"v3",value:null},radius:{type:"f",value:null},mapping:{type:c,value:null}};this.createImpostorShaderBase(e,n,s,u,p,h,d,a,l),u=null,i=null,r=null,o=null,t.posArraySphere=null,t.colorArraySphere=null,t.radiusArraySphere=null},iCn3D.prototype.positionFromGeometry=function(e){for(var t,i,r=e.geometry,o=r.vertices,n=e.position,s=e.scale,a=e.matrix,c=o.length,d=[],l=0;l<c;l++)t=3*l,i="SphereGeometry"==r.type||"BoxGeometry"==r.type?o[l].clone().multiply(s).add(n):"CylinderGeometry"==r.type?o[l].clone().applyMatrix4(a):o[l],d[t+0]=i.x,d[t+1]=i.y,d[t+2]=i.z;return d},iCn3D.prototype.colorFromGeometry=function(e){var t=e.geometry,i=new THREE.Color(1,1,1);"SphereGeometry"!=t.type&&"BoxGeometry"!=t.type&&"CylinderGeometry"!=t.type||void 0!==e.material&&(i=e.material.color);for(var r,o,n,s,a,c=t.faces,d=(t.vertices.length,"Surface"==t.type,c.length),l=[],h=0;h<d;h++)o=c[h],"Surface"==t.type?(n=o.vertexColors[0],s=o.vertexColors[1],a=o.vertexColors[2]):"SphereGeometry"==t.type||"BoxGeometry"==t.type||"CylinderGeometry"==t.type?(n=i,s=i,a=i):(n=o.color,s=o.color,a=o.color),r=3*o.a,l[r+0]=n.r,l[r+1]=n.g,l[r+2]=n.b,r=3*o.b,l[r+0]=s.r,l[r+1]=s.g,l[r+2]=s.b,r=3*o.c,l[r+0]=a.r,l[r+1]=a.g,l[r+2]=a.b;return l},iCn3D.prototype.indexFromGeometry=function(e){for(var t,i,r=e.geometry,o=r.faces,n=o.length,s=[],a=0;a<n;a++)t=3*a,i=o[a],s[t+0]=i.a,s[t+1]=i.b,s[t+2]=i.c;return s},iCn3D.prototype.normalFromGeometry=function(e){for(var t,i,r,o,n,s,a=e.geometry,c=a.faces,d=(a.vertices.length,c.length),l=[],h=0;h<d;h++)i=c[h],r=i.vertexNormals,o=r[0],n=r[1],s=r[2],t=3*i.a,l[t+0]=o.x,l[t+1]=o.y,l[t+2]=o.z,t=3*i.b,l[t+0]=n.x,l[t+1]=n.y,l[t+2]=n.z,t=3*i.c,l[t+0]=s.x,l[t+1]=s.y,l[t+2]=s.z;return l},iCn3D.prototype.hashvalue2array=function(e){var t=[];for(var i in e)t.push(e[i]);return t},iCn3D.prototype.drawSymmetryMates=function(){this.bInstanced&&Object.keys(this.atoms).length*this.biomtMatrices.length>this.maxatomcnt?this.drawSymmetryMatesInstancing():this.drawSymmetryMatesNoInstancing()},iCn3D.prototype.drawSymmetryMatesNoInstancing=function(){if(void 0!==this.biomtMatrices&&0!=this.biomtMatrices.length){var e=1,t=this.center.clone(),i=new THREE.Matrix4;i.identity();for(var r=0;r<this.biomtMatrices.length;r++){var o=this.biomtMatrices[r];if(void 0!==o&&!o.equals(i)){var n=this.mdl.clone();n.applyMatrix(o),this.mdl.add(n),n=this.mdlImpostor.clone(),n.applyMatrix(o);for(var s=n.children.length-1;s>=0;s--){var a=n.children[s];a.onBeforeRender=this.onBeforeRender}this.mdlImpostor.add(n),n=this.mdl_ghost.clone(),n.applyMatrix(o),this.mdl_ghost.add(n);var c=this.center.clone();c.applyMatrix4(o),t.add(c),++e}}void 0!==this.bSetInstancing&&this.bSetInstancing?(this.maxD=this.maxDAssembly,this.center=this.centerAssembly.clone(),this.setCenter(this.center),this.setCamera()):(this.maxD*=Math.sqrt(e),this.center=t.multiplyScalar(1/e),this.maxDAssembly=this.maxD,this.centerAssembly=this.center.clone(),this.setCenter(this.center),this.setCamera()),this.bSetInstancing=!0}},iCn3D.prototype.createInstancedGeometry=function(e){var t=e.geometry,i=new THREE.InstancedBufferGeometry,r=[],o=[],n=[],s=[],a=[],c=[],d=[],l=[];if(t.vertices&&t.faces){this.instancedMaterial=this.getInstancedMaterial("Instancing");var h=this.positionFromGeometry(e),u=this.normalFromGeometry(e),p=this.colorFromGeometry(e),m=this.indexFromGeometry(e);r=r.concat(h),o=o.concat(u),n=n.concat(p),s=s.concat(m);for(var v=[],f="CylinderGeometry"==t.type?1:0,g=0,y=r.length/3;g<y;++g)v.push(f);i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(r),3)),i.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(o),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(n),3)),i.addAttribute("cylinder",new THREE.BufferAttribute(new Float32Array(v),1)),i.setIndex(new THREE.BufferAttribute(new Uint32Array(s),1)),h=null,u=null,p=null,m=null}else if(this.bImpo&&void 0!==t.attributes.color2){this.instancedMaterial=this.getInstancedMaterial("CylinderInstancing");var h=this.hashvalue2array(t.attributes.position1.array),p=this.hashvalue2array(t.attributes.color.array),b=this.hashvalue2array(t.attributes.position2.array),E=this.hashvalue2array(t.attributes.color2.array),m=this.hashvalue2array(t.index.array),C=this.hashvalue2array(t.attributes.radius.array),w=this.hashvalue2array(t.attributes.mapping.array);r=r.concat(h),n=n.concat(p),d=d.concat(b),l=l.concat(E),s=s.concat(m),a=a.concat(C),c=c.concat(w),i.addAttribute("position1",new THREE.BufferAttribute(new Float32Array(r),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(n),3)),i.addAttribute("position2",new THREE.BufferAttribute(new Float32Array(d),3)),i.addAttribute("color2",new THREE.BufferAttribute(new Float32Array(l),3)),i.addAttribute("radius",new THREE.BufferAttribute(new Float32Array(a),1)),i.addAttribute("mapping",new THREE.BufferAttribute(new Float32Array(c),3)),i.setIndex(new THREE.BufferAttribute(new Uint32Array(s),1)),h=null,p=null,b=null,E=null,m=null,C=null,w=null}else if(this.bImpo&&void 0!==t.attributes.color){this.instancedMaterial=this.getInstancedMaterial("SphereInstancing");var h=this.hashvalue2array(t.attributes.position.array),p=this.hashvalue2array(t.attributes.color.array),m=this.hashvalue2array(t.index.array),C=this.hashvalue2array(t.attributes.radius.array),w=this.hashvalue2array(t.attributes.mapping.array);r=r.concat(h),n=n.concat(p),s=s.concat(m),a=a.concat(C),c=c.concat(w),i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(r),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(n),3)),i.addAttribute("radius",new THREE.BufferAttribute(new Float32Array(a),1)),i.addAttribute("mapping",new THREE.BufferAttribute(new Float32Array(c),2)),i.setIndex(new THREE.BufferAttribute(new Uint32Array(s),1)),h=null,p=null,m=null,C=null,w=null}r=null,o=null,n=null,s=null,a=null,c=null,d=null,l=null;var T=new THREE.InstancedBufferAttribute(new Float32Array(this.matricesElements1),4),R=new THREE.InstancedBufferAttribute(new Float32Array(this.matricesElements2),4),A=new THREE.InstancedBufferAttribute(new Float32Array(this.matricesElements3),4),S=new THREE.InstancedBufferAttribute(new Float32Array(this.matricesElements4),4);return i.addAttribute("matrix1",T),i.addAttribute("matrix2",R),i.addAttribute("matrix3",A),i.addAttribute("matrix4",S),i},iCn3D.prototype.getInstancedMaterial=function(e){var t=new THREE.ShaderMaterial({defines:this.defines,uniforms:this.uniforms,vertexShader:this.getShader(e+".vert"),fragmentShader:this.getShader(e+".frag"),depthTest:!0,depthWrite:!0,needsUpdate:!0,lights:!0});return t.extensions.fragDepth=!0,t.extensions.derivatives="#extension GL_OES_standard_derivatives : enable",t},iCn3D.prototype.drawSymmetryMatesInstancing=function(){if(void 0!==this.biomtMatrices&&0!=this.biomtMatrices.length){var e=1,t=this.center.clone();if(this.setParametersForShader(),void 0===this.bSetInstancing||!this.bSetInstancing){this.matricesElements1=[],this.matricesElements2=[],this.matricesElements3=[],this.matricesElements4=[];var i=new THREE.Matrix4;i.identity();for(var r=0;r<this.biomtMatrices.length;r++){var o=this.biomtMatrices[r];if(void 0!==o){var n=o.toArray();if(!o.equals(i)){this.matricesElements1.push(n[0],n[1],n[2],n[3]),this.matricesElements2.push(n[4],n[5],n[6],n[7]),this.matricesElements3.push(n[8],n[9],n[10],n[11]),this.matricesElements4.push(n[12],n[13],n[14],n[15]);var s=this.center.clone();s.applyMatrix4(o),t.add(s),++e}}}}for(var r=0,a=this.mdl.children.length;r<a;++r){var c=this.mdl.children[r];if("Sprite"!==c.type){var d=this.createInstancedGeometry(c),l=new THREE.Mesh(d,this.instancedMaterial);l.onBeforeRender=this.onBeforeRender,l.frustumCulled=!1,d=void 0,this.mdl.add(l)}}for(var r=0,a=this.mdlImpostor.children.length;r<a;++r){var c=this.mdlImpostor.children[r],d=this.createInstancedGeometry(c),l=new THREE.Mesh(d,this.instancedMaterial);l.onBeforeRender=this.onBeforeRender,l.frustumCulled=!1,d=null,this.mdlImpostor.add(l)}void 0!==this.bSetInstancing&&this.bSetInstancing?(this.maxD=this.maxDAssembly,this.center=this.centerAssembly.clone(),this.setCenter(this.center),this.setCamera()):(this.maxD*=Math.sqrt(e),this.center=t.multiplyScalar(1/e),this.maxDAssembly=this.maxD,this.centerAssembly=this.center.clone(),this.setCenter(this.center),this.setCamera()),this.bSetInstancing=!0}},iCn3D.prototype.cloneHash=function(e){var t={};for(var i in e)t[i]=e[i];return t},iCn3D.prototype.residueName2Abbr=function(e){switch(void 0!==e&&" "!==e.charAt(0)&&" "===e.charAt(1)&&(e=e.charAt(0)),e){case"  A":return"A";case"  C":return"C";case"  G":return"G";case"  T":return"T";case"  U":return"U";case"  I":return"I";case" DA":return"A";case" DC":return"C";case" DG":return"G";case" DT":return"T";case" DU":return"U";case" DI":return"I";case"ALA":return"A";case"ARG":return"R";case"ASN":return"N";case"ASP":return"D";case"CYS":return"C";case"GLU":return"E";case"GLN":return"Q";case"GLY":return"G";case"HIS":return"H";case"ILE":return"I";case"LEU":return"L";case"LYS":return"K";case"MET":return"M";case"PHE":return"F";case"PRO":return"P";case"SER":return"S";case"THR":return"T";case"TRP":return"W";case"TYR":return"Y";case"VAL":return"V";case"SEC":return"U";case"HOH":return"O";case"WAT":return"O";default:return e}},iCn3D.prototype.intHash=function(e,t){var i={};if(Object.keys(e).length<Object.keys(t).length)for(var r in e)void 0!==t&&t[r]&&(i[r]=e[r]);else for(var r in t)void 0!==e&&e[r]&&(i[r]=t[r]);return e={},t={},i},iCn3D.prototype.exclHash=function(e,t){var i={};for(var r in e)r in t||(i[r]=e[r]);return e={},t={},i},iCn3D.prototype.unionHash=function(e,t){return this.unionHashNotInPlace(e,t)},iCn3D.prototype.unionHashNotInPlace=function(e,t){var i=jQuery.extend({},e,t);return e={},t={},i},iCn3D.prototype.intHash2Atoms=function(e,t){return this.hash2Atoms(this.intHash(e,t))},iCn3D.prototype.exclHash2Atoms=function(e,t){return this.hash2Atoms(this.exclHash(e,t))},iCn3D.prototype.unionHash2Atoms=function(e,t){return this.hash2Atoms(this.unionHash(e,t))},iCn3D.prototype.hash2Atoms=function(e){var t={};for(var i in e)t[i]=this.atoms[i];return e={},t},iCn3D.prototype.exportCanvas=function(){this.render(),window.open(this.renderer.domElement.toDataURL("image/png"))},iCn3D.prototype.zoomIn=function(e){var t={};t._zoomFactor=1-e,t.update=!0,this.controls.update(t),this.render()},iCn3D.prototype.zoomOut=function(e){var t={};t._zoomFactor=1+e,t.update=!0,this.controls.update(t),this.render()},iCn3D.prototype.rotateLeft=function(e){var t=new THREE.Vector3(0,1,0),i=-e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var r=new THREE.Quaternion;r.setFromAxisAngle(t,-i);var o={};o.quaternion=r,o.update=!0,this.controls.update(o),this.render()},iCn3D.prototype.rotateRight=function(e){var t=new THREE.Vector3(0,1,0),i=e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var r=new THREE.Quaternion;r.setFromAxisAngle(t,-i);var o={};o.quaternion=r,o.update=!0,this.controls.update(o),this.render()},iCn3D.prototype.rotateUp=function(e){var t=new THREE.Vector3(1,0,0),i=-e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var r=new THREE.Quaternion;r.setFromAxisAngle(t,-i);var o={};o.quaternion=r,o.update=!0,this.controls.update(o),this.render()},iCn3D.prototype.rotateDown=function(e){var t=new THREE.Vector3(1,0,0),i=e/180*Math.PI;t.applyQuaternion(this.cam.quaternion).normalize();var r=new THREE.Quaternion;r.setFromAxisAngle(t,-i);var o={};o.quaternion=r,o.update=!0,this.controls.update(o),this.render()},iCn3D.prototype.translateLeft=function(e){var t=new THREE.Vector2(0,0);t.x-=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.translateRight=function(e){var t=new THREE.Vector2(0,0);t.x+=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.translateUp=function(e){var t=new THREE.Vector2(0,0);t.y-=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.translateDown=function(e){var t=new THREE.Vector2(0,0);t.y+=e/100;var i={};i.mouseChange=t,i.update=!0,this.controls.update(i),this.render()},iCn3D.prototype.showPickingHilight=function(e){if(this.bShift||this.bCtrl||this.removeHlObjects(),this.pickedAtomList={},1===this.pk)this.pickedAtomList[e.serial]=1;else if(2===this.pk){var t=e.structure+"_"+e.chain+"_"+e.resi;this.pickedAtomList=this.residues[t]}else if(3===this.pk)this.pickedAtomList=this.selectStrandHelixFromAtom(e);else if(4===this.pk){var i=e.structure+"_"+e.chain;this.pickedAtomList=this.chains[i]}0===this.pk?this.bShowHighlight=!1:this.bShowHighlight=!0;var r=Object.keys(this.hAtoms).length==Object.keys(this.atoms).length?{}:this.intHash(this.hAtoms,this.pickedAtomList),o=Object.keys(r).length;if(this.bShift||this.bCtrl)if(this.bShift){if(void 0===this.prevPickedAtomList)this.hAtoms=this.unionHash(this.hAtoms,this.pickedAtomList);else{var n=this.getFirstAtomObj(this.prevPickedAtomList),s=this.getFirstAtomObj(this.pickedAtomList),a=n.structure+"_"+n.chain,c=s.structure+"_"+s.chain;if(a!=c)this.hAtoms=this.unionHash(this.hAtoms,this.pickedAtomList);else for(var d=this.unionHash(this.prevPickedAtomList,this.pickedAtomList),l=this.getFirstAtomObj(d),h=this.getLastAtomObj(d),u=l.serial;u<=h.serial;++u)this.hAtoms[u]=1}this.prevPickedAtomList=this.cloneHash(this.pickedAtomList)}else this.bCtrl&&(o>0?this.hAtoms=this.exclHash(this.hAtoms,this.pickedAtomList):this.hAtoms=this.unionHash(this.hAtoms,this.pickedAtomList));else this.hAtoms=this.cloneHash(this.pickedAtomList);this.removeHlObjects(),this.addHlObjects()},iCn3D.prototype.showPicking=function(e,t,i){this.showPickingBase(e,t,i)},iCn3D.prototype.showPickingBase=function(e,t,i){void 0===t&&void 0===i&&this.showPickingHilight(e)},iCn3D.prototype.removeHlObjects=function(){for(var e in this.prevHighlightObjects)this.mdl.remove(this.prevHighlightObjects[e]);this.prevHighlightObjects=[];for(var e in this.prevHighlightObjects_ghost)this.mdl.remove(this.prevHighlightObjects_ghost[e]);this.prevHighlightObjects_ghost=[]},iCn3D.prototype.addHlObjects=function(e,t,i){void 0===e&&(e=this.hColor),void 0===i&&(i=this.hAtoms),this.applyDisplayOptions(this.opts,this.intHash(i,this.dAtoms),this.bHighlight),(void 0===t||t)&&this.render()},iCn3D.prototype.resetOrientation=function(){var e=!1;if(this.commands.length>0){var t=this.commands[0].split("|||");if(2==t.length){var i=JSON.parse(t[1]);this._zoomFactor=i.factor,this.mouseChange.x=i.mouseChange.x,this.mouseChange.y=i.mouseChange.y,this.quaternion._x=i.quaternion._x,this.quaternion._y=i.quaternion._y,this.quaternion._z=i.quaternion._z,this.quaternion._w=i.quaternion._w,e=!0}}e||(this._zoomFactor=1,this.mouseChange=new THREE.Vector2(0,0),this.quaternion=new THREE.Quaternion(0,0,0,1)),this.maxD=this.oriMaxD,this.center=this.oriCenter.clone(),"show"==this.ori_chemicalbinding?this.bSkipChemicalbinding=!1:"hide"==this.ori_chemicalbinding&&(this.bSkipChemicalbinding=!0)},iCn3D.prototype.getAtomsFromPosition=function(e,t){var i,r;void 0!==t&&null!==t||(t=1);for(i in this.atoms){var r=this.atoms[i];if(this.ions.hasOwnProperty(i)&&"sphere"===this.opts.ions){var o=this.vdwRadii[r.elem];if(Math.abs(r.coord.x-e.x)-o>t)continue;if(Math.abs(r.coord.y-e.y)-o>t)continue;if(Math.abs(r.coord.z-e.z)-o>t)continue}else{if(r.coord.x<e.x-t||r.coord.x>e.x+t)continue;if(r.coord.y<e.y-t||r.coord.y>e.y+t)continue;if(r.coord.z<e.z-t||r.coord.z>e.z+t)continue}return r}return null},iCn3D.prototype.getFirstAtomObj=function(e){if(void 0==e)return this.atoms[0];var t=Object.keys(e),i=t[0];return this.atoms[i]},iCn3D.prototype.getFirstCalphaAtomObj=function(e){if(void 0==e)return this.atoms[0];var t;for(var i in e)if("CA"==this.atoms[i].name){t=i;break}return void 0!==t?this.atoms[t]:this.getFirstAtomObj(e)},iCn3D.prototype.getLastAtomObj=function(e){var t=Object.keys(e),i=t[t.length-1];return this.atoms[i]},iCn3D.prototype.hexToRgb=function(e,t){var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16),a:t}:null},iCn3D.prototype.selectStrandHelixFromAtom=function(e){var t=e,i=e,r={},o=t.resi;if(!t.ssbegin){for(var n=t.resi-1;n>0;--n){var s=t.structure+"_"+t.chain+"_"+n;if(!this.residues.hasOwnProperty(s))break;var e=this.getFirstCalphaAtomObj(this.residues[s]);if(o=e.resi,"coil"!==t.ss&&e.ss===t.ss&&e.ssbegin||"coil"===t.ss&&e.ss!==t.ss){"coil"===t.ss&&e.ss!==t.ss&&(o=e.resi+1);break}}for(var n=o;n<=t.resi;++n){var s=t.structure+"_"+t.chain+"_"+n;r=this.unionHash(r,this.hash2Atoms(this.residues[s]))}}for(var a=i.resi,c=this.getLastAtomObj(this.chains[i.structure+"_"+i.chain]).resi,n=i.resi+1;n<=c;++n){var s=i.structure+"_"+i.chain+"_"+n;if(!this.residues.hasOwnProperty(s))break;var e=this.getFirstCalphaAtomObj(this.residues[s]);if(a=e.resi,"coil"!==i.ss&&e.ss===i.ss&&e.ssend||"coil"===i.ss&&e.ss!==i.ss){"coil"===i.ss&&e.ss!==i.ss&&(a=e.resi-1);break}}for(var n=i.resi+1;n<=a;++n){var s=i.structure+"_"+i.chain+"_"+n;r=this.unionHash(r,this.hash2Atoms(this.residues[s]))}return r},iCn3D.prototype.addNonCarbonAtomLabels=function(e){var t=18,i="#FFFFFF",r=this.intHash(this.hAtoms,e);void 0===this.labels.schematic&&(this.labels.schematic=[]);for(var o in r){var n=this.atoms[o];if(this.residues.hasOwnProperty(n.structure+"_"+n.chain+"_"+n.resi)&&"C"!==n.elem){var s={};s.position=n.coord,s.bSchematic=1,s.text=n.elem,s.size=t,s.color="#"+n.color.getHexString(),s.background=i,this.labels.schematic.push(s)}}this.removeHlObjects()},iCn3D.prototype.addResiudeLabels=function(e,t,i){var r=18,o="#CCCCCC";void 0===i&&(i=1);var n=this.intHash(this.hAtoms,e);t?void 0===this.labels.schematic&&(this.labels.schematic=[]):void 0===this.labels.residue&&(this.labels.residue=[]);var s="";for(var a in n){var c=this.atoms[a],d={},l=c.structure+"_"+c.chain+"_"+c.resi;if(!c.het&&("CA"===c.name||"O3'"===c.name||"O3*"===c.name)||this.water.hasOwnProperty(c.serial)||this.ions.hasOwnProperty(c.serial)||this.chemicals.hasOwnProperty(c.serial)&&l!==s){d.position=c.coord,d.bSchematic=0,t&&(d.bSchematic=1),d.text=this.residueName2Abbr(c.resn),d.size=r;var h=c.color.getHexString().toUpperCase();d.color="CCCCCC"===h||"C8C8C8"===h?"#888888":"#"+h,d.background=o,t?this.labels.schematic.push(d):this.labels.residue.push(d)}s=l}this.removeHlObjects()},iCn3D.prototype.setCenter=function(e){this.mdl.position.set(0,0,0),this.mdlImpostor.position.set(0,0,0),this.mdl_ghost.position.set(0,0,0),this.mdl.position.sub(e),this.mdlImpostor.position.sub(e),this.mdl_ghost.position.sub(e)},iCn3D.prototype.getResiduesFromAtoms=function(e){var t={};for(var i in e){var r=this.atoms[i].structure+"_"+this.atoms[i].chain+"_"+this.atoms[i].resi;t[r]=1}return t},iCn3D.prototype.getResiduesFromCalphaAtoms=function(e){var t={};for(var i in e)if("CA"==this.atoms[i].name&&this.proteins.hasOwnProperty(i)||!this.proteins.hasOwnProperty(i)){var r=this.atoms[i].structure+"_"+this.atoms[i].chain+"_"+this.atoms[i].resi;t[r]=1}return t},function(e){"use strict";var t=e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype,i=e.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),r=i&&e.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),o=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder,n=/^data:((.*?)(;charset=.*?)?)(;base64)?,/,s=(i||o)&&e.atob&&e.ArrayBuffer&&e.Uint8Array&&function(e){var t,s,a,c,d,l,h,u,p;if(t=e.match(n),!t)throw new Error("invalid data URI");for(s=t[2]?t[1]:"text/plain"+(t[3]||";charset=US-ASCII"),a=!!t[4],c=e.slice(t[0].length),d=a?atob(c):decodeURIComponent(c),l=new ArrayBuffer(d.length),h=new Uint8Array(l),u=0;u<d.length;u+=1)h[u]=d.charCodeAt(u);return i?new Blob([r?h:l],{type:s}):(p=new o,p.append(l),p.getBlob(s))};e.HTMLCanvasElement&&!t.toBlob&&(t.mozGetAsFile?t.toBlob=function(e,i,r){var o=this;setTimeout(function(){e(r&&t.toDataURL&&s?s(o.toDataURL(i,r)):o.mozGetAsFile("blob",i))})}:t.toDataURL&&s&&(t.toBlob=function(e,t,i){var r=this;setTimeout(function(){e(s(r.toDataURL(t,i)))})})),"function"==typeof define&&define.amd?define(function(){return s}):"object"==typeof module&&module.exports?module.exports=s:e.dataURLtoBlob=s}(window);var saveAs=saveAs||function(e){"use strict";if(!("undefined"==typeof e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=e.document,i=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,n=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},s=/constructor/i.test(e.HTMLElement)||e.safari,a=/CriOS\/[\d]+/.test(navigator.userAgent),c=e.setImmediate||e.setTimeout,d=function(e){c(function(){throw e},0)},l="application/octet-stream",h=4e4,u=function(e){var t=function(){"string"==typeof e?i().revokeObjectURL(e):e.remove()};setTimeout(t,h)},p=function(e,t,i){t=[].concat(t);for(var r=t.length;r--;){var o=e["on"+t[r]];if("function"==typeof o)try{o.call(e,i||e)}catch(n){d(n)}}},m=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},v=function(t,d,h){h||(t=m(t));var v,f=this,g=t?t.type:void 0,y=g===l,b=function(){p(f,"writestart progress write writeend".split(" "))},E=function(){if((a||y&&s)&&e.FileReader){var r=new FileReader;return r.onloadend=function(){var t=a?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;"),i=e.open(t,"_blank");i||(e.location.href=t),t=void 0,f.readyState=f.DONE,b()},r.readAsDataURL(t),void(f.readyState=f.INIT)}if(v||(v=i().createObjectURL(t)),y)e.location.href=v;else{var o=e.open(v,"_blank");o||(e.location.href=v)}f.readyState=f.DONE,b(),u(v)};return f.readyState=f.INIT,o?(v||(v=i().createObjectURL(t)),void c(function(){r.href=v,r.download=d,n(r),b(),u(v),f.readyState=f.DONE},0)):void E()},f=v.prototype,g=function(e,t,i){return new v(e,t||e.name||"download",i)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,i){return t=t||e.name||"download",i||(e=m(e)),navigator.msSaveOrOpenBlob(e,t)}:(f.abort=function(){},f.readyState=f.INIT=0,f.WRITING=1,f.DONE=2,f.error=f.onwritestart=f.onprogress=f.onwrite=f.onabort=f.onerror=f.onwriteend=null,g)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this);iCn3D.prototype.rebuildScene=function(e){var t=this;this.rebuildSceneBase(e),this.applyDisplayOptions(this.opts,this.dAtoms),this.applyCenterOptions(),this.setCamera(),t.scene_ghost.updateMatrixWorld(!0)},iCn3D.prototype.draw=function(){this.rebuildScene(),this.bImpo&&this.drawImpostorShader(),void 0!==this.biomtMatrices&&this.biomtMatrices.length>1&&(this.bAssembly?this.drawSymmetryMates():this.centerSelection()),this.cnt<=this.maxmaxatomcnt&&void 0!==this.hAtoms&&Object.keys(this.hAtoms).length>0&&Object.keys(this.hAtoms).length<Object.keys(this.atoms).length&&(this.removeHlObjects(),(void 0===this.bShowHighlight||this.bShowHighlight)&&this.addHlObjects()),this.bRender===!0&&(this.applyTransformation(this._zoomFactor,this.mouseChange,this.quaternion),this.render()),this.clearImpostors()};var iCn3DUI=function(e){var t=this;t.bFullUi=!1,t.cfg=e,t.divid=t.cfg.divid,t.pre=t.divid+"_",t.inputid="",t.WIDTH=400,t.HEIGHT=400,t.RESIDUE_WIDTH=10,t.MENU_HEIGHT=0,t.MENU_WIDTH=$(window).width(),t.LESSWIDTH=0,t.LESSWIDTH_RESIZE=20,t.LESSHEIGHT=20,t.ROT_DIR="right",t.bHideSelection=!0,t.ALTERNATE_STRUCTURE=-1,t.EXTRAHEIGHT=0,t.GREY8="#888888",t.GREYB="#BBBBBB",t.GREYC="#CCCCCC",t.GREYD="#DDDDDD",t.bSelectResidue=!1,t.bSelectAlignResidue=!1,t.selectedResidues={},t.bCrashed=!1,t.prevCommands="",t.opts={},t.opts.camera="perspective",t.opts.background="transparent",t.opts.color="chain",t.opts.proteins="ribbon",t.opts.sidec="nothing",t.opts.nucleotides="nucleotide cartoon",t.opts.surface="nothing",t.opts.opacity="1.0",t.opts.wireframe="no",t.opts.map="nothing",t.opts.mapwireframe="yes",t.opts.chemicals="stick",t.opts.water="nothing",t.opts.ions="sphere",t.opts.hbonds="no",t.opts.rotationcenter="molecule center",t.opts.axis="no",t.opts.fog="no",t.opts.slab="no",t.opts.pk="residue",t.opts.chemicalbinding="hide",void 0!==t.cfg.cid&&(t.opts.pk="atom",t.opts.chemicals="ball and stick",t.opts.color="atom"),void 0!==t.cfg.options&&jQuery.extend(t.opts,t.cfg.options),t.modifyIcn3d()};if(iCn3DUI.prototype={constructor:iCn3DUI,modifyIcn3d:function(){var e=this;e.modifyIcn3dshowPicking()},modifyIcn3dshowPicking:function(){var e=this;iCn3D.prototype.showPicking=function(t,i,r){if(void 0!==e.cfg.cid?this.pk=1:this.pk=2,this.showPickingBase(t,i,r),void 0!==i&&void 0!==r){var o=1==this.pk?t.resn+t.resi+"@"+t.name:t.resn+t.resi;$("#"+e.pre+"popup").html(o),$("#"+e.pre+"popup").css("top",r).css("left",i+20).show()}}},show3DStructure:function(){var e=this,t=e.setHtml();$("#"+e.divid).html(t),e.setViewerWidthHeight();var i,r;i=e.cfg.width.toString().indexOf("%")!==-1?e.WIDTH*e.cfg.width.substr(0,e.cfg.width.toString().indexOf("%"))/100-e.LESSWIDTH:e.cfg.width,r=e.cfg.height.toString().indexOf("%")!==-1?e.HEIGHT*e.cfg.height.substr(0,e.cfg.height.toString().indexOf("%"))/100-e.EXTRAHEIGHT-e.LESSHEIGHT:e.cfg.height,$("#"+e.pre+"viewer").width(i).height(r),$("#"+e.pre+"canvas").width(i).height(r),parseInt(i)<=200&&$("#"+e.pre+"toolbox").hide(),e.allEventFunctions(),e.allCustomEvents(),void 0!=e.cfg.showmenu&&0==e.cfg.showmenu?$("#"+e.pre+"toolbox").hide():$("#"+e.pre+"toolbox").show(),void 0!=e.cfg.showtitle&&0==e.cfg.showtitle?$("#"+e.pre+"title").hide():$("#"+e.pre+"title").show(),e.icn3d=new iCn3D(e.pre+"canvas"),e.isMobile()||(e.icn3d.scaleFactor=2),e.handleContextLost(),void 0!==e.cfg.bCalphaOnly&&(e.icn3d.bCalphaOnly=e.cfg.bCalphaOnly),e.loadStructure()},setHtml:function(){var e=this,t="";return t+="<div id='"+e.pre+"viewer' style='position:relative; width:100%; height:100%;'>",t+="<div id='"+e.pre+"popup' class='icn3d-text icn3d-popup'></div>",t+="<div id='"+e.pre+"title' style='position:absolute; top:20px; left:80px; color:"+e.GREYD+";'></div>",void 0===e.cfg.mmtfid&&(t+="<div id='"+e.pre+"wait' style='width:100%; height: 100%; background-color: rgba(0,0,0, 0.8);'><div style='padding-top:15%; text-align: center; font-size: 2em; color: #FFFF00;'>Loading the structure...</div></div>"),t+="<canvas id='"+e.pre+"canvas' style='width:100%; height:100%; background-color: #000;'>Your browser does not support WebGL.</canvas>",t+="<div class='icn3d-tabBox' id='"+e.pre+"toolbox'>",t+="<span class='icn3d-bottomTab'>Tools</span>",t+="<div class='icn3d-insideTab' style='overflow: auto;'>",t+="<form action='' id='"+e.pre+"paraform' method='POST'>",void 0===e.cfg.cid?(t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Proteins&nbsp;</b>",t+="<select id='"+e.pre+"proteins'>",t+="<option value='ribbon' selected>Ribbon</option>",t+="<option value='strand'>Strand</option>",t+="<option value='cylinder and plate'>Cylinder and Plate</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='c alpha trace'>C Alpha Trace</option>",t+="<option value='b factor tube'>B Factor Tube</option>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Side Chains&nbsp;</b>",t+="<select id='"+e.pre+"sidec'>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing' selected>Hide</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Nucleotides&nbsp;</b>",t+="<select id='"+e.pre+"nucleotides'>",t+="<option value='nucleotide cartoon' selected>Cartoon</option>",t+="<option value='o3 trace'>O3' Trace</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Chemicals&nbsp;</b>",t+="<select id='"+e.pre+"chemicals'>",t+="<option value='lines'>Lines</option>",t+="<option value='stick' selected>Stick</option>",t+="<option value='ball and stick'>Ball and Stick</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>"):(t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Chemicals&nbsp;</b>",t+="<select id='"+e.pre+"chemicals'>",t+="<option value='lines'>Lines</option>",t+="<option value='stick'>Stick</option>",t+="<option value='ball and stick' selected>Ball and Stick</option>",t+="<option value='schematic'>Schematic</option>",t+="<option value='sphere'>Sphere</option>",t+="<option value='nothing'>Hide</option>",t+="</select>",t+="</div>"),t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Color&nbsp;</b>",t+="<select id='"+e.pre+"color'>",void 0===e.cfg.cid?(t+="<option value='spectrum'>Spectrum</option>",t+="<option value='secondary structure'>Secondary Structure</option>",t+="<option value='charge'>Charge</option>",t+="<option value='hydrophobic'>Hydrophobic</option>",t+="<option value='chain' selected>Chain</option>",t+="<option value='residue'>Residue</option>",t+="<option value='atom'>Atom</option>",t+="<option value='b factor'>B-factor</option>"):t+="<option value='atom' selected>Atom</option>",void 0!==e.cfg.align&&(t+="<option value='conserved'>Identity</option>"),t+="<option value='red'>Red</option>",t+="<option value='green'>Green</option>",t+="<option value='blue'>Blue</option>",t+="<option value='magenta'>Magenta</option>",t+="<option value='yellow'>Yellow</option>",t+="<option value='cyan'>Cyan</option>",t+="</select>",t+="</div>",t+="<div class='icn3d-option'>",t+="<b>&nbsp;&nbsp;Camera&nbsp;</b>",t+="<select id='"+e.pre+"camera'>",
t+="<option value='perspective' selected>Perspective</option>",t+="<option value='orthographic'>Orthographic</option>",t+="</select>",t+="</div>",e.isMobile()||(t+="<div class='icn3d-option'>",t+='&nbsp;&nbsp;<b>Select</b>: hold "Alt" and select<br/>',t+='&nbsp;&nbsp;<b>Union</b>: hold "Ctrl" to union<br/>',t+="&nbsp;&nbsp;<b>Switch</b>: after picking, press up/down arrow",t+="</div>"),t+="<div class='icn3d-option'>",t+="&nbsp;&nbsp;<button id='"+e.pre+"saveimage'>Save Image</button> <button id='"+e.pre+"reset'>Reset</button> <button id='"+e.pre+"help'>Help</button>",t+="</div>",t+="</form>",t+="</div>",t+="</div>",t+="</div>",t+="<!-- dialog will not be part of the form -->",t+="<div id='"+e.pre+"alldialogs' class='icn3d-hidden'>",t+="</div>"},loadStructure:function(){var e=this;if(e.icn3d.molTitle="",void 0!==e.cfg.mmtfid)e.inputid=e.cfg.mmtfid,e.downloadMmtf(e.cfg.mmtfid);else if(void 0!==e.cfg.pdbid){e.inputid=e.cfg.pdbid;var t=e.cfg.pdbid.toLowerCase();e.downloadPdb(t)}else if(void 0!==e.cfg.mmdbid)e.inputid=e.cfg.mmdbid,e.downloadMmdb(e.cfg.mmdbid);else if(void 0!==e.cfg.gi)e.downloadGi(e.cfg.gi);else if(void 0!==e.cfg.cid){e.inputid=e.cfg.cid;var i="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+e.cfg.cid+"/description/jsonp";$.ajax({url:i,dataType:"jsonp",tryCount:0,retryLimit:1,success:function(t){void 0!==t.InformationList&&void 0!==t.InformationList.Information&&(e.icn3d.molTitle=t.InformationList.Information[0].Title)},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}}),e.downloadCid(e.cfg.cid)}else if(void 0!==e.cfg.mmcifid)e.inputid=e.cfg.mmcifid,e.downloadMmcif(e.cfg.mmcifid);else if(void 0!==e.cfg.align)e.inputid=e.cfg.align,e.downloadAlignment(e.cfg.align);else if(void 0!==e.cfg.url){var r=e.cfg.url.split("|"),o=r[0],i=r[1];e.inputid=void 0,e.downloadUrl(i,o)}else alert("Please input a gi, MMDB ID, PDB ID, CID, or mmCIF ID...")},renderStructure:function(e){var t=this;e?(jQuery.extend(t.icn3d.opts,t.opts),t.icn3d.draw()):t.icn3d.draw()},selectAll:function(){var e=this;for(var t in e.icn3d.atoms)e.icn3d.hAtoms[t]=1},setCamera:function(e,t){var i=this;i.icn3d.opts[e]=t,i.icn3d.draw()},setColor:function(e,t){var i=this;i.icn3d.opts[e]=t,i.selectAll(),i.icn3d.setColorByOptions(i.icn3d.opts,i.icn3d.atoms),i.icn3d.draw()},setStyle:function(e,t){var i=this,r={};switch(i.selectAll(),e){case"proteins":r=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.proteins);break;case"sidec":r=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.sidec),calpha_atoms=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.calphas),r=i.icn3d.unionHash(r,calpha_atoms);break;case"nucleotides":r=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.nucleotides);break;case"chemicals":r=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.chemicals);break;case"ions":r=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.ions);break;case"water":r=i.icn3d.intHash(i.icn3d.hAtoms,i.icn3d.water)}if("sidec"===e)for(var o in r)i.icn3d.atoms[o].style2=t;else for(var o in r)i.icn3d.atoms[o].style=t;i.icn3d.opts[e]=t,i.icn3d.draw()},clickTab:function(){var e=this;$("#"+e.pre+"toolbox > .icn3d-bottomTab").click(function(t){var i=$("#"+e.pre+"toolbox > .icn3d-insideTab").height();0===i?$("#"+e.pre+"toolbox > .icn3d-insideTab").height(260):$("#"+e.pre+"toolbox > .icn3d-insideTab").height(0)})},changeProteinStyle:function(){var e=this;$("#"+e.pre+"proteins").change(function(t){t.preventDefault(),$("#"+e.pre+"sidec").val("nothing")})},clickReset:function(){var e=this;$("#"+e.pre+"reset").click(function(t){t.preventDefault(),e.icn3d.resetOrientation(),e.icn3d.draw()})},clickSaveimage:function(){var e=this;$("#"+e.pre+"saveimage").click(function(t){t.preventDefault();var i=e.inputid?e.inputid:"custom";e.saveFile(i+"_image.png","png")})},clickHelp:function(){var e=this;$("#"+e.pre+"help").click(function(e){e.preventDefault(),window.open("https://www.ncbi.nlm.nih.gov/Structure/icn3d/docs/icn3d_help.html","_blank")})},showSubsets:function(){var e=this;$("#"+e.pre+"filter").click(function(e){e.preventDefault();for(var t=document.getElementsByName(pre+"filter_ckbx"),i="",r="&het=0",o=0,n=t.length;o<n;++o)t[o].checked&&("chemicals"==t[o].value?r="&het=2":i+=t[o].value+",");""==i&&(i=t[0].value);var s=document.URL+"&mols="+i+"&complexity=2"+r;window.open(s,"_self")})},changeSelection:function(){var e=this;["camera","color","sidec","proteins","chemicals","water","ions","nucleotides"].forEach(function(t){$("#"+e.pre+t).change(function(i){"camera"===t?e.setCamera(t,$("#"+e.pre+t).val()):"color"===t?e.setColor(t,$("#"+e.pre+t).val()):e.setStyle(t,$("#"+e.pre+t).val())})})},allEventFunctions:function(){var e=this;e.clickTab(),e.changeProteinStyle(),e.clickReset(),e.clickSaveimage(),e.clickHelp(),e.showSubsets(),e.windowResize(),e.changeSelection()},allCustomEvents:function(){},download2Ddgm:function(e,t){}},"undefined"==typeof jQuery)throw new Error("iCn3DUI requires jQuery");if("undefined"==typeof iCn3D)throw new Error("iCn3DUI requires iCn3D");iCn3DUI.prototype.rotStruc=function(e,t){var i=this;if(i.icn3d.bStopRotate)return!1;if(i.icn3d.rotateCount>i.icn3d.rotateCountMax)return i.icn3d.resetOrientation(),!1;if(++i.icn3d.rotateCount,void 0!==t&&t)if("left"===e)i.ROT_DIR="left";else if("right"===e)i.ROT_DIR="right";else if("up"===e)i.ROT_DIR="up";else{if("down"!==e)return!1;i.ROT_DIR="down"}if("left"===e&&"left"===i.ROT_DIR)i.icn3d.rotateLeft(1);else if("right"===e&&"right"===i.ROT_DIR)i.icn3d.rotateRight(1);else if("up"===e&&"up"===i.ROT_DIR)i.icn3d.rotateUp(1);else{if("down"!==e||"down"!==i.ROT_DIR)return!1;i.icn3d.rotateDown(1)}setTimeout(function(){i.rotStruc(e)},100)},iCn3DUI.prototype.showTitle=function(){var e=this;if(void 0!==e.icn3d.molTitle&&""!==e.icn3d.molTitle){var t=e.icn3d.molTitle;if(void 0===e.inputid)e.icn3d.molTitle.length>40&&(t=e.icn3d.molTitle.substr(0,40)+"..."),$("#"+e.pre+"title").html(t);else if(void 0!==e.cfg.cid){var i=e.getLinkToStructureSummary();$("#"+e.pre+"title").html("PubChem CID <a href='"+i+"' target='_blank' style='color:"+e.GREYD+"'>"+e.inputid.toUpperCase()+"</a>: "+t)}else if(void 0!==e.cfg.align)$("#"+e.pre+"title").html(t);else{var i=e.getLinkToStructureSummary();e.icn3d.molTitle.length>40&&(t=e.icn3d.molTitle.substr(0,40)+"...");var r="";$("#"+e.pre+"title").html("PDB ID <a href='"+i+"' target='_blank' style='color:"+e.GREYD+"'>"+e.inputid.toUpperCase()+"</a>"+r+": "+t)}}else $("#"+e.pre+"title").html("")},iCn3DUI.prototype.getLinkToStructureSummary=function(e){var t=this,i="https://www.ncbi.nlm.nih.gov/structure/?term=";if(i=void 0!==t.cfg.cid?"https://www.ncbi.nlm.nih.gov/pccompound/?term=":t.inputid.indexOf(",")!==-1?"https://www.ncbi.nlm.nih.gov/structure/?term=":"https://www.ncbi.nlm.nih.gov/Structure/pdb/",void 0===t.inputid)i="https://www.ncbi.nlm.nih.gov/pccompound/?term="+t.molTitle;else{var r=t.inputid.split("_");1===r.length?(i+=t.inputid,void 0!==e&&e&&t.setLogCmd("link to Structure Summary "+t.inputid+": "+i,!1)):2===r.length&&(i+=r[0]+" OR "+r[1],void 0!==e&&e&&t.setLogCmd("link to structures "+r[0]+" and "+r[1]+": "+i,!1))}return i},iCn3DUI.prototype.isIE=function(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");return!!(t>0||navigator.userAgent.match(/Trident.*rv\:11\./))},iCn3DUI.prototype.passFloat32=function(e,t){var i=this,r=e.length;t||(t=new Uint8Array(4*r));for(var o=i.getDataView(t),n=0;n<r;++n)o.setFloat32(4*n,e[n],!0);return i.getUint8View(t)},iCn3DUI.prototype.passInt8=function(e,t){var i=this,r=e.length;t||(t=new Uint8Array(1*r));for(var o=i.getDataView(t),n=0;n<r;++n)o.setInt8(1*n,e[n],!0);return i.getUint8View(t)},iCn3DUI.prototype.passInt16=function(e,t){var i=this,r=e.length;t||(t=new Uint8Array(2*r));for(var o=i.getDataView(t),n=0;n<r;++n)o.setInt16(2*n,e[n],!0);return i.getUint8View(t)},iCn3DUI.prototype.passInt32=function(e,t){var i=this,r=e.length;t||(t=new Uint8Array(4*r));for(var o=i.getDataView(t),n=0;n<r;++n)o.setInt32(4*n,e[n],!0);return i.getUint8View(t)},iCn3DUI.prototype.getUint8View=function(e){var t=this;return t.getView(Uint8Array,e)},iCn3DUI.prototype.getDataView=function(e){var t=this;return t.getView(DataView,e)},iCn3DUI.prototype.getView=function(e,t,i){return t?new e(t.buffer,t.byteOffset,t.byteLength/(i||1)):void 0},iCn3DUI.prototype.getBlobFromBufferAndText=function(e,t){for(var i=this,r=new Uint8Array(e),o=new Uint8Array(t.length),n=0;n<t.length;++n)o[n]=i.passInt8([t.charCodeAt(n)])[0];var s=[];s.push(new Blob([r],{type:"application/octet-stream"})),s.push(new Blob([o],{type:"application/octet-stream"}));var a=new Blob(s,{type:"image/png"});return a},iCn3DUI.prototype.getTransformationStr=function(e){var t={factor:1,mouseChange:{x:0,y:0},quaternion:{_x:0,_y:0,_z:0,_w:1}};return t.factor=parseFloat(e.factor).toPrecision(5),t.mouseChange.x=parseFloat(e.mouseChange.x).toPrecision(5),t.mouseChange.y=parseFloat(e.mouseChange.y).toPrecision(5),t.quaternion._x=parseFloat(e.quaternion._x).toPrecision(5),t.quaternion._y=parseFloat(e.quaternion._y).toPrecision(5),t.quaternion._z=parseFloat(e.quaternion._z).toPrecision(5),t.quaternion._w=parseFloat(e.quaternion._w).toPrecision(5),"1.0000"==t.factor&&(t.factor=1),"0.0000"==t.mouseChange.x&&(t.mouseChange.x=0),"0.0000"==t.mouseChange.y&&(t.mouseChange.y=0),"0.0000"==t.quaternion._x&&(t.quaternion._x=0),"0.0000"==t.quaternion._y&&(t.quaternion._y=0),"0.0000"==t.quaternion._z&&(t.quaternion._z=0),"1.0000"==t.quaternion._w&&(t.quaternion._w=1),JSON.stringify(t)},iCn3DUI.prototype.saveFile=function(e,t,i){var r,o=this;if("command"===t){for(var n="",s=0,a=o.icn3d.commands.length;s<a;++s){var c=o.icn3d.commands[s].trim();if(s==a-1){var d=c.split("|||"),l={};l.factor=o.icn3d._zoomFactor,l.mouseChange=o.icn3d.mouseChange,l.quaternion=o.icn3d.quaternion,c=d[0]+"|||"+o.getTransformationStr(l)}n+=c+"\n"}var h=decodeURIComponent(n);r=new Blob([h],{type:"text;charset=utf-8;"})}else if("png"===t){o.icn3d.render();var u=!0;if(window.File&&window.FileReader&&window.FileList&&window.Blob||(u=!1),o.isIE()){if(r=o.icn3d.renderer.domElement.msToBlob(),u){var p=new FileReader;p.onload=function(t){var i=t.target.result,n=o.shareLinkUrl(),s="";o.bInputfile?(s+="\nStart of type file======\n",s+=o.InputfileType+"\n",s+="End of type file======\n",s+="Start of data file======\n",s+=o.InputfileData,s+="End of data file======\n",s+="Start of state file======\n",s+=n,s+="End of state file======\n"):s+="\nShare Link: "+n,r=o.getBlobFromBufferAndText(i,s),saveAs(r,e)},p.readAsArrayBuffer(r)}}else o.icn3d.renderer.domElement.toBlob(function(t){if(!u)return r=t,void saveAs(r,e);var i=new FileReader;i.onload=function(t){var i=t.target.result,n=o.shareLinkUrl(),s="";o.bInputfile?(s+="\nStart of type file======\n",s+=o.InputfileType+"\n",s+="End of type file======\n",s+="Start of data file======\n",s+=o.InputfileData,s+="End of data file======\n",s+="Start of state file======\n",s+=n,s+="End of state file======\n"):s+="\nShare Link: "+n,r=o.getBlobFromBufferAndText(i,s),saveAs(r,e)},i.readAsArrayBuffer(t)})}else if("html"===t){var n=i,h=decodeURIComponent(n);r=new Blob([h],{type:"text/html;charset=utf-8;"})}else if("text"===t){var h=i;r=new Blob(h,{type:"text;charset=utf-8;"})}else if("binary"===t){var h=i;r=new Blob(h,{type:"application/octet-stream"})}"png"!==t&&saveAs(r,e)},iCn3DUI.prototype.isMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},iCn3DUI.prototype.isMac=function(){return/Mac/i.test(navigator.userAgent)},iCn3DUI.prototype.isSessionStorageSupported=function(){var e="test";try{return sessionStorage.setItem(e,"1"),sessionStorage.removeItem(e),!0}catch(t){return!1}},iCn3DUI.prototype.resizeCanvas=function(e,t,i,r){var o=this;if(void 0!==i&&i||void 0!==o.cfg.resize&&o.cfg.resize){var n=t;$("#"+o.pre+"canvas").width(e).height(n),$("#"+o.pre+"viewer").width(e).height(t),o.icn3d.setWidthHeight(e,n),(void 0===r||r)&&o.icn3d.draw()}},iCn3DUI.prototype.handleContextLost=function(){var e=this,t=$("#"+e.pre+"canvas")[0];t.addEventListener("webglcontextlost",function(e){e.preventDefault()},!1),t.addEventListener("webglcontextrestored",function(t){console.log("WebGL context was lost. Reset WebGLRenderer and launch iCn3D again."),e.icn3d.renderer=new THREE.WebGLRenderer({canvas:e.icn3d.container.get(0),antialias:!0,preserveDrawingBuffer:!0,alpha:!0}),e.icn3d.draw()},!1)},iCn3DUI.prototype.windowResize=function(){var e=this;void 0!==e.cfg.resize&&e.cfg.resize&&!e.isMobile()&&$(window).resize(function(){e.WIDTH=$(window).width(),e.HEIGHT=$(window).height();var t=e.WIDTH-e.LESSWIDTH_RESIZE,i=e.HEIGHT-e.LESSHEIGHT-e.EXTRAHEIGHT;void 0!==e.icn3d&&e.resizeCanvas(t,i)})},iCn3DUI.prototype.setViewerWidthHeight=function(){var e=this;e.WIDTH=$(window).width(),e.HEIGHT=$(window).height();var t=$("#"+e.pre+"viewer").width(),i=$("#"+e.pre+"viewer").height();t&&e.WIDTH>t&&(e.WIDTH=t),i&&e.HEIGHT>i&&(e.HEIGHT=i),e.isMac()&&e.isMobile()&&(e.WIDTH<e.MENU_WIDTH&&(e.WIDTH=e.MENU_WIDTH),e.HEIGHT=$(window).height()/$(window).width()*e.MENU_WIDTH),e.cfg.width.toString().indexOf("%")===-1&&(e.WIDTH=parseInt(e.cfg.width)+e.LESSWIDTH),e.cfg.height.toString().indexOf("%")===-1&&(e.HEIGHT=parseInt(e.cfg.height)+e.EXTRAHEIGHT+e.LESSHEIGHT)},iCn3DUI.prototype.shareLinkUrl=function(){var e=this,t="https://www.ncbi.nlm.nih.gov/Structure/icn3d/full.html?",i=-1;void 0!==e.cfg.inpara&&(i=e.cfg.inpara.indexOf("&command="));var r=i!==-1?e.cfg.inpara.substr(0,i):e.cfg.inpara,o=0;void 0!==r?(t+=r.substr(1)+"&command=",o=1):(t+="command=",o=0),e.bInputfile&&(o=0);var n={};n.factor=e.icn3d._zoomFactor,n.mouseChange=e.icn3d.mouseChange,n.quaternion=e.icn3d.quaternion;for(var s=!1,a="",c=o,d=e.icn3d.commands.length;c<d;++c){s=!0;var l=e.icn3d.commands[c].split("|||"),h=l[0].trim();c===d-1?(1!==c&&0!==c&&(t+="; "),t+=h+"|||"+e.getTransformationStr(n)):1===c?t+=h:1!==c&&c!==d-1&&(t+="; "+h),a+=e.icn3d.commands[c]+"\n"}return s||(t=t.substr(0,t.length-9)),e.bInputfile&&(t=a),t},iCn3DUI.prototype.addLabel=function(e,t,i,r,o,n,s,a){var c=this,d={};"0"!==o&&""!==o&&"undefined"!==o||(o=void 0),"0"!==n&&""!==n&&"undefined"!==n||(n=void 0),"0"!==s&&""!==s&&"undefined"!==s||(s=void 0);var l=new THREE.Vector3;l.x=t,l.y=i,l.z=r,d.position=l,d.text=e,d.size=o,d.color=n,d.background=s,void 0===c.icn3d.labels[a]&&(c.icn3d.labels[a]=[]),void 0!==a?c.icn3d.labels[a].push(d):c.icn3d.labels.custom.push(d),c.icn3d.removeHlObjects()},iCn3DUI.prototype.showLoading=function(){var e=this;$("#"+e.pre+"wait")&&$("#"+e.pre+"wait").show(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").hide(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").hide()},iCn3DUI.prototype.hideLoading=function(){var e=this;void 0!==e.bCommandLoad&&e.bCommandLoad||($("#"+e.pre+"wait")&&$("#"+e.pre+"wait").hide(),$("#"+e.pre+"canvas")&&$("#"+e.pre+"canvas").show(),$("#"+e.pre+"cmdlog")&&$("#"+e.pre+"cmdlog").show())},iCn3DUI.prototype.downloadMmcif=function(e){var t,i,r=this;t="https://files.rcsb.org/view/"+e+".cif",i="text",r.icn3d.bCid=void 0,$.ajax({url:t,dataType:i,cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){r.showLoading()},complete:function(){r.hideLoading()},success:function(e){t="https://www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi",$.ajax({url:t,type:"POST",data:{mmciffile:e},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){r.showLoading()},complete:function(){r.hideLoading()},success:function(e){r.loadMmcifData(e)},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}})},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}})},iCn3DUI.prototype.downloadMmcifSymmetry=function(e,t){var i=this;return i.deferredSymmetry=$.Deferred(function(){i.downloadMmcifSymmetryBase(e,t)}),i.deferredSymmetry.promise()},iCn3DUI.prototype.downloadMmcifSymmetryBase=function(e,t){var i,r,o=this;i=o.isMac()?"https://files.rcsb.org/view/"+e+".cif":"https://files.rcsb.org/header/"+e+".cif",r="text",o.icn3d.bCid=void 0,$.ajax({url:i,dataType:r,cache:!0,tryCount:0,retryLimit:1,success:function(r){i="https://www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi",$.ajax({url:i,type:"POST",data:{mmcifheader:r},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(i){if(void 0!==i.emd&&(o.icn3d.emd=i.emd),o.bAssemblyUseAsu&&o.loadMmcifSymmetry(i),"mmtfid"===t&&void 0!==i.missingseq){for(var r=0,n="",s={},a=0,c=i.missingseq.length;a<c;++a){var d=i.missingseq[a].resn,l=i.missingseq[a].chain,h=i.missingseq[a].resi,u=e+"_"+l;void 0===s[u]&&(s[u]=[]);var p={};p.resi=h,p.name=o.icn3d.residueName2Abbr(d).toLowerCase(),l!=n&&(r=0),!isNaN(h)&&(""==n||l!=n||l==n&&h>r)&&(s[u].push(p),r=h,n=l)}o.icn3d.adjustSeq(s)}void 0!==o.deferredSymmetry&&o.deferredSymmetry.resolve()},error:function(e,t,i){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void(void 0!==o.deferredSymmetry&&o.deferredSymmetry.resolve())}})},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}})},iCn3DUI.prototype.loadMmcifData=function(e){var t=this;if(void 0===e.atoms)return alert("invalid atoms data."),!1;t.icn3d.init(),void 0!==e.emd&&(t.icn3d.emd=e.emd),void 0!==t.icn3d.emd?($("#"+t.pre+"mapWrapper1").hide(),$("#"+t.pre+"mapWrapper2").hide(),$("#"+t.pre+"mapWrapper3").hide()):($("#"+t.pre+"emmapWrapper1").hide(),$("#"+t.pre+"emmapWrapper2").hide(),$("#"+t.pre+"emmapWrapper3").hide()),t.loadAtomDataIn(e,e.mmcif,"mmcifid"),void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide();for(var i=void 0!==e.assembly?e.assembly:[],r=0,o=i.length;r<o;++r){void 0==t.icn3d.biomtMatrices[r]&&(t.icn3d.biomtMatrices[r]=(new THREE.Matrix4).identity());for(var n=0,s=i[r].length;n<s;++n)t.icn3d.biomtMatrices[r].elements[n]=i[r][n]}void 0!==t.icn3d.biomtMatrices&&t.icn3d.biomtMatrices.length>1?($("#"+t.pre+"assemblyWrapper").show(),t.icn3d.asuCnt=t.icn3d.biomtMatrices.length):$("#"+t.pre+"assemblyWrapper").hide(),t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()},iCn3DUI.prototype.loadMmcifSymmetry=function(e){for(var t=this,i=e.assembly,r=(e.pmatrix,0),o=i.length;r<o;++r){var n=new THREE.Matrix4;n.fromArray(i[r]),t.icn3d.biomtMatrices[r]=n}t.icn3d.asuCnt=t.icn3d.biomtMatrices.length},iCn3DUI.prototype.parseMmdbData=function(e){var t=this;if(void 0===e.atoms&&void 0===e.molid2rescount)return alert("invalid MMDB data."),!1;t.icn3d.init(),t.interactionData={moleculeInfor:e.moleculeInfor,intrac:e.intrac,intracResidues:e.intracResidues},t.mmdb_data=e;var i=void 0!==e.pdbId?e.pdbId:e.mmdbId;t.inputid=i;var r=e.moleculeInfor,o={},n={},s={};t.icn3d.chainsColor={},t.icn3d.chainsGene={};var a="<table width='100%'><tr><td></td><th>#</th><th align='center'>Chain</th><th align='center'>Residue Count</th></tr>",c=1,d={};for(var l in r){var h="#"+("000000"+r[l].color.toString(16)).slice(-6),u=r[l].chain.trim();void 0===d[u]?d[u]=1:++d[u];var p=1===d[u]?u:u+d[u].toString(),m=i+"_"+p;a+="<tr style='color:"+h+"'><td><input type='checkbox' name='"+t.pre+"filter_ckbx' value='"+l+"' chain='"+m+"'/></td><td align='center'>"+c+"</td><td align='center'>"+p+"</td><td align='center'>"+r[l].resCount+"</td></tr>",o[l]=h,n[m]=l,s[l]=m,t.icn3d.chainsColor[m]=new THREE.Color(h),t.icn3d.chainsGene[m]={geneId:r[l].geneId,geneSymbol:r[l].geneSymbol,geneDesc:r[l].geneDesc},++c}void 0!==t.icn3d.chemicals&&Object.keys(t.icn3d.chemicals).length>0&&(a+="<tr><td><input type='checkbox' name='"+t.pre+"filter_ckbx' value='chemicals'/></td><td align='center'>"+c+"</td><td align='center'>Chemicals</td><td align='center'>"+Object.keys(t.icn3d.chemicals).length+" atoms</td></tr>"),a+="</table>",t.icn3d.molid2color=o,t.icn3d.chain2molid=n,t.icn3d.molid2chain=s,$("#"+t.pre+"accordion5").show(),t.loadAtomDataIn(e,i,"mmdbid"),t.bAssemblyUseAsu=void 0!==e.asuAtomCount,$.when(t.downloadMmcifSymmetry(i)).then(function(){t.downloadMmdbPart2()})},iCn3DUI.prototype.downloadMmdb=function(e,t){var i,r=this;i=void 0!==t&&t?"https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&gi="+e:"https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?v=2&program=icn3d&b=1&s=1&ft=1&uid="+e,r.icn3d.bCid=void 0,void 0!==r.cfg.inpara&&(i+=r.cfg.inpara),void 0===r.chainids2resids&&(r.chainids2resids={}),$.ajax({url:i,dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){r.showLoading()},complete:function(){r.hideLoading()},success:function(o){var n=r.icn3d.isCalphaPhosOnly(o.atoms);n||o.atomCount<=r.icn3d.maxatomcnt?r.parseMmdbData(o):(o=null,$.ajax({url:i+"&complexity=2",dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){r.showLoading()},complete:function(){r.hideLoading()},success:function(e){r.parseMmdbData(e)},error:function(i,o,n){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void(t?alert("This gi "+e+" has no corresponding 3D structure..."):alert("This mmdbid "+e+" with the parameters "+r.cfg.inpara+" may not have 3D structure data. Please visit the summary page for details: https://www.ncbi.nlm.nih.gov/Structure/pdb/"+e))}}))},error:function(i,o,n){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void(t?alert("This gi "+e+" has no corresponding 3D structure..."):alert("This mmdbid "+e+" with the parameters "+r.cfg.inpara+" may not have 3D structure data. Please visit the summary page for details: https://www.ncbi.nlm.nih.gov/Structure/pdb/"+e))}})},iCn3DUI.prototype.downloadMmdbPart2=function(){var e=this;e.bAssemblyUseAsu?($("#"+e.pre+"assemblyWrapper").show(),e.icn3d.bAssembly=!0):($("#"+e.pre+"assemblyWrapper").hide(),e.icn3d.bAssembly=!1),void 0!==e.icn3d.emd?($("#"+e.pre+"mapWrapper1").hide(),$("#"+e.pre+"mapWrapper2").hide(),$("#"+e.pre+"mapWrapper3").hide()):($("#"+e.pre+"emmapWrapper1").hide(),$("#"+e.pre+"emmapWrapper2").hide(),$("#"+e.pre+"emmapWrapper3").hide()),e.icn3d.setAtomStyleByOptions(e.opts),void 0!==e.cfg.blast_rep_id?e.icn3d.setColorByOptions(e.opts,e.icn3d.atoms):e.icn3d.setColorByOptions(e.opts,e.icn3d.atoms,!0),e.renderStructure(),void 0!==e.cfg.rotate&&e.rotStruc(e.cfg.rotate,!0),e.html2ddgm="",void 0!==e.cfg.show2d&&e.cfg.show2d&&(e.openDialog(e.pre+"dl_2ddgm","Interactions"),e.bFullUi&&e.download2Ddgm(e.inputid.toUpperCase())),void 0===e.cfg.align&&1==Object.keys(e.icn3d.structures).length&&null!==$("#"+e.pre+"alternateWrapper")&&$("#"+e.pre+"alternateWrapper").hide(),void 0!==e.deferred&&e.deferred.resolve(),void 0!==e.deferred2&&e.deferred2.resolve()},iCn3DUI.prototype.downloadGi=function(e){var t=this;t.icn3d.bCid=void 0;var i=!0;t.downloadMmdb(e,i)},iCn3DUI.prototype.downloadBlast_rep_id=function(e){var t=this;t.icn3d.bCid=void 0;var i=e.split(",");t.cfg.query_id=i[0],t.cfg.blast_rep_id=i[1];var r=t.cfg.blast_rep_id.split("_")[0];t.downloadMmdb(r)},iCn3DUI.prototype.getMissingResidues=function(e,t,i){for(var r=this,o=-9999,n=0,s=!0,a=0,c=e.length;a<c;++a){var d,l;"mmdbid"===t?(d=e[a][1],l=0):"mmcifid"===t?(d=e[a][1],d=r.icn3d.residueName2Abbr(d),l=0):"align"===t&&(d=e[a][2],l=1),""===d&&(d="x");var h={};h.resi=a+1;var u=parseInt(e[a][l]),p=a==c-1?9999:parseInt(e[a+1][l]);if(0!==u||0===u&&(o===-1||1==p)){if(h.name=d.toLowerCase(),s&&n>0){void 0===r.countNextresiArray[i]&&(r.countNextresiArray[i]=[]);var m=[n,parseInt(e[a][0])];r.countNextresiArray[i].push(m),n=0}s=!1}else h.name=d.toLowerCase(),++n,s=!0;void 0===r.icn3d.chainsSeq[i]&&(r.icn3d.chainsSeq[i]=[]);var v="";h.resi%10===0&&(v=h.resi.toString()),r.icn3d.chainsSeq[i].push(h),o=u}},iCn3DUI.prototype.loadAtomDataIn=function(e,t,i,r){var o=this,n=new THREE.Vector3(9999,9999,9999),s=new THREE.Vector3((-9999),(-9999),(-9999)),a=new THREE.Vector3,c=e.atoms,d=0,l=0,h={},u={};o.pmid=e.pubmedId;var p={},m={},v={};if(o.chainid2title={},o.chainid2sid={},"align"===i){o.pmid="";var f=o.cfg.inpara.indexOf("atype=1")!==-1?"Invariant Core ":"";o.icn3d.molTitle=f+"Structure Alignment of ";for(var g=0,y=e.alignedStructures[0].length;g<y;++g){var b=e.alignedStructures[0][g];1===g&&(o.icn3d.secondId=b.pdbId);for(var E=b.pdbId,C=b.mmdbId,w=b.serialInterval[0],T=b.serialInterval[1];w<=T;++w)h[w]=E.toString(),u[C]=E;for(var w=0,T=b.molecules.length;w<T;++w){var R=b.molecules[w].chain,A=b.molecules[w].kind,S=b.molecules[w].name,x=b.molecules[w].sequence,H=b.molecules[w].sid,_=E+"_"+R;o.bFullUi&&(p[_]=x),m[_]=A,o.chainid2title[_]=S,void 0!==H&&(o.chainid2sid[_]=H)}o.icn3d.molTitle+='<a href="https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdbsrv.cgi?uid='+b.pdbId.toUpperCase()+'" target="_blank" style="color: '+o.GREYD+';">'+b.pdbId.toUpperCase()+"</a>",void 0!==b.descr&&(o.pmid+=b.descr.pubmedid),0===g&&(o.icn3d.molTitle+=" and ",void 0!==b.descr&&(o.pmid+="_"))}o.icn3d.molTitle+=" from VAST+"}else if(void 0!==e.descr&&(o.icn3d.molTitle+=e.descr.name),"mmdbid"===i){var E=e.pdbId,I={};for(var D in e.moleculeInfor){var R=e.moleculeInfor[D].chain.trim(),_=E+"_"+R;I.hasOwnProperty(R)?(++I[R],_+=I[R]):I[R]=1;var A=e.moleculeInfor[D].kind,O=e.moleculeInfor[D].color,H=e.moleculeInfor[D].sid;m[_]=A,v[_]=O,void 0!==H&&(o.chainid2sid[_]=H)}}if(o.countNextresiArray={},o.bFullUi)if("mmdbid"===i||"mmcifid"===i)for(var R in e.sequences){var L=e.sequences[R],_=t+"_"+R;o.getMissingResidues(L,i,_)}else if("align"===i)for(var _ in p){var L=p[_];o.getMissingResidues(L,i,_)}var D,M={},P="",k="",N="",z="",j="",F="",l=0,U=0,V=!0,B=!1,G="",q="";o.mmdbMolidResid2mmdbChainResi={};var W=o.icn3d.isCalphaPhosOnly(c),$=0;biopolymerChainsHash={};for(var g in c){++d,M[g]=d;var Y=c[g];Y.serial=d;var X;"mmdbid"===i||"mmcifid"===i?X=t:"align"===i&&(X=h[d]);var Q=0;if("mmdbid"===i||"align"===i?(Y.resi_ori=parseInt(Y.resi),Y.resi=Y.ids.r,Q=Y.resi-Y.resi_ori):Y.resi=parseInt(Y.resi),void 0!==Y.chain||"mmdbid"!==i&&"align"!==i)Y.chain=""===Y.chain?"Misc":Y.chain;else if("mmdbid"===i)if(D=Y.ids.m,void 0!==o.icn3d.molid2chain[D]){var Z=o.icn3d.molid2chain[D].indexOf("_");Y.chain=o.icn3d.molid2chain[D].substr(Z+1)}else{var K="Misc";++$,"solvent"!==m[j]&&"HOH"!==Y.resn||(Y.resi=$),Y.chain=K}else if("align"===i)if(D=Y.ids.m,void 0!==o.icn3d.pdbid_molid2chain[X+"_"+D])Y.chain=o.icn3d.pdbid_molid2chain[X+"_"+D];else{var K="Misc";++$,"solvent"!==m[j]&&"HOH"!==Y.resn||(Y.resi=$),Y.chain=K}Y.chain=Y.chain.trim(),"mmdbid"!==i&&"align"!==i||(Y.structure=X),z=Y.structure,j=z+"_"+Y.chain,j!==k&&(U=0,l=0),"mmdbid"===i?Y.coord=new THREE.Vector3(Y.coord[0],Y.coord[1],Y.coord[2]):Y.coord=new THREE.Vector3(Y.coord.x,Y.coord.y,Y.coord.z);var J=o.icn3d.residueName2Abbr(Y.resn.substr(0,3));"mmdbid"!==i&&"align"!==i||!o.bFullUi||(o.mmdbMolidResid2mmdbChainResi[X+"_"+Y.ids.m+"_"+Y.ids.r]=X+"_"+Y.chain+"_"+Y.resi),n.min(Y.coord),s.max(Y.coord),a.add(Y.coord);var ee=void 0===o.cfg.mmcifid?"protein"===m[j]:"p"===Y.mt,te=void 0===o.cfg.mmcifid?"nucleotide"===m[j]:"n"===Y.mt,ie=void 0===o.cfg.mmcifid?"solvent"===m[j]:"s"===Y.mt,re=void 0===o.cfg.mmcifid?"ligand"===m[j]||void 0!==m[j]&&m[j].indexOf("other")!==-1||void 0===m[j]:"l"===Y.mt;"Misc"!==Y.chain&&"other"!==m[j]||"protein"===biopolymerChainsHash[j]||"nucleotide"===biopolymerChainsHash[j]||("CA"===Y.name?biopolymerChainsHash[j]="protein":"P"===Y.name?biopolymerChainsHash[j]="nucleotide":biopolymerChainsHash[j]="chemical"),ee||te?(ee?(o.icn3d.proteins[d]=1,"CA"===Y.name&&(o.icn3d.calphas[d]=1),"N"!==Y.name&&"CA"!==Y.name&&"C"!==Y.name&&"O"!==Y.name&&(o.icn3d.sidec[d]=1)):te&&(o.icn3d.nucleotides[d]=1,("O3'"==Y.name||"O3*"==Y.name||W&&"P"==Y.name)&&(o.icn3d.nucleotidesO3[d]=1)),Y.het=!1):ie?(o.icn3d.water[d]=1,Y.het=!0):re&&("HOH"===Y.resn||"O"===Y.resn?o.icn3d.water[d]=1:Y.elem===Y.resn?o.icn3d.ions[d]=1:o.icn3d.chemicals[d]=1,Y.het=!0),"mmdbid"===i?Y.het?Y.color=o.icn3d.atomColors[Y.elem]||o.icn3d.defaultAtomColor:Y.color=void 0!==v[j]?new THREE.Color(v[j]):o.icn3d.chargeColors[Y.resn]:void 0!==Y.color&&(Y.color=new THREE.Color(Y.color))," "!==Y.resn.charAt(0)&&" "===Y.resn.charAt(1)&&(Y.resn=Y.resn.charAt(0)),"HOH"==Y.resn&&(o.icn3d.water[d]=1),o.icn3d.atoms[d]=Y,o.icn3d.dAtoms[d]=1,o.icn3d.hAtoms[d]=1;var _=Y.structure+"_"+Y.chain;void 0===o.icn3d.chains[_]&&(o.icn3d.chains[_]={}),o.icn3d.chains[_][d]=1;var oe=Y.structure+"_"+Y.chain+"_"+Y.resi;void 0===o.icn3d.residues[oe]&&(o.icn3d.residues[oe]={}),o.icn3d.residues[oe][d]=1,F=j+"_"+Y.resi,F!==N&&j!==k&&(V=!0,1!==d&&(void 0===o.icn3d.structures[P]&&(o.icn3d.structures[P]=[]),o.icn3d.structures[P].push(k))),o.icn3d.residueId2Name[oe]=J;var ne="-";if("helix"===Y.ss?ne="H":"sheet"===Y.ss?ne="E":Y.het||te?ne="o":!Y.het&&o.icn3d.residueColors.hasOwnProperty(Y.resn.toUpperCase())?ne="c":"coil"===Y.ss&&(ne="c"),o.icn3d.secondaries[Y.structure+"_"+Y.chain+"_"+Y.resi]=ne,(Y.resi!=l||D!=G)&&o.bFullUi)if(void 0===o.icn3d.chainsSeq[_]&&(o.icn3d.chainsSeq[_]=[],V=!1),V&&!B&&void 0!==o.icn3d.chainsSeq[_][Y.resi-1])o.icn3d.chainsSeq[_][Y.resi-1].name=J;else if(!V||!o.icn3d.chainsSeq[_].hasOwnProperty(Y.resi-1)){var se={};se.resi=Y.resi,se.name=J;var ae="";Y.resi%10===0&&(ae=Y.resi.toString()),o.icn3d.chainsSeq[_].push(se),B=!0}l=Y.resi,P=z,k=j,N=F,G=D,q=X}for(var _ in biopolymerChainsHash)if(!(Object.keys(o.icn3d.chains[_]).length<10)&&"chemical"!==biopolymerChainsHash[_])for(var d in o.icn3d.chains[_]){var Y=o.icn3d.atoms[d];delete o.icn3d.chemicals[d],Y.het=!1,"protein"===biopolymerChainsHash[_]?(o.icn3d.proteins[d]=1,"CA"===Y.name&&(o.icn3d.calphas[d]=1),"N"!==Y.name&&"CA"!==Y.name&&"C"!==Y.name&&"O"!==Y.name&&(o.icn3d.sidec[d]=1)):"nucleotide"===biopolymerChainsHash[_]&&(o.icn3d.nucleotides[d]=1,("O3'"==Y.name||"O3*"==Y.name||W&&"P"==Y.name)&&(o.icn3d.nucleotidesO3[d]=1))}if(e.atoms={},void 0===o.icn3d.structures[z]&&(o.icn3d.structures[z]=[]),o.icn3d.structures[z].push(j),"mmcifid"!==i)for(var g in o.icn3d.atoms)for(var ce=void 0===o.icn3d.atoms[g].bonds?0:o.icn3d.atoms[g].bonds.length,w=0;w<ce;++w)o.icn3d.atoms[g].bonds[w]=M[o.icn3d.atoms[g].bonds[w]];if(o.icn3d.cnt=d,(o.icn3d.cnt>o.icn3d.maxatomcnt||void 0!==o.icn3d.biomtMatrices&&o.icn3d.biomtMatrices.length*o.icn3d.cnt>10*o.icn3d.maxatomcnt)&&(o.opts.proteins="c alpha trace",o.opts.nucleotides="o3 trace"),o.icn3d.pmin=n,o.icn3d.pmax=s,o.icn3d.maxD=s.distanceTo(n),o.icn3d.center=a.multiplyScalar(1/o.icn3d.cnt),o.icn3d.maxD<5&&(o.icn3d.maxD=5),o.icn3d.oriMaxD=o.icn3d.maxD,o.icn3d.oriCenter=o.icn3d.center.clone(),"mmdbid"===i){var de=e.disulfides;if(void 0!==de)for(var g=0,y=de.length;g<y;++g){var le=de[g][0].ca,he=de[g][1].ca,ue=o.icn3d.atoms[le],pe=o.icn3d.atoms[he],me=ue.structure+"_"+ue.chain+"_"+ue.resi,ve=pe.structure+"_"+pe.chain+"_"+pe.resi;void 0===o.icn3d.ssbondpnts[ue.structure]&&(o.icn3d.ssbondpnts[ue.structure]=[]),o.icn3d.ssbondpnts[ue.structure].push(me),o.icn3d.ssbondpnts[ue.structure].push(ve)}}else if("mmcifid"===i){var de=e.disulfides;if(void 0!==de){void 0===o.icn3d.ssbondpnts[t]&&(o.icn3d.ssbondpnts[t]=[]);for(var g=0,y=de.length;g<y;++g){var me=de[g][0],ve=de[g][1];o.icn3d.ssbondpnts[t].push(me),o.icn3d.ssbondpnts[t].push(ve)}for(var fe=Object.keys(o.icn3d.structures),ge=0,ye=fe.length;ge<ye;++ge){var b=fe[ge];if(b!=t){void 0===o.icn3d.ssbondpnts[b]&&(o.icn3d.ssbondpnts[b]=[]);for(var w=0,T=o.icn3d.ssbondpnts[t].length;w<T;++w){var be=o.icn3d.ssbondpnts[t][w],Z=be.indexOf("_"),Ee=b+be.substr(Z);o.icn3d.ssbondpnts[b].push(Ee)}}}}}else if("align"===i){var Ce={};for(var _ in p)if("protein"==m[_])for(var x=p[_],b=_.substr(0,_.indexOf("_")),g=0,y=x.length;g<y;++g)"C"==x[g][2]&&(void 0==Ce[b]&&(Ce[b]=[]),Ce[b].push(_+"_"+x[g][0]));var we=4,Te=we*we;for(var b in Ce)for(var Re=Ce[b],g=0,y=Re.length;g<y;++g)for(var w=g+1,T=Re.length;w<T;++w){var me=Re[g],ve=Re[w],Ae=void 0,Se=void 0;for(var d in o.icn3d.residues[me])if("S"==o.icn3d.atoms[d].elem){Ae=o.icn3d.atoms[d].coord;break}for(var d in o.icn3d.residues[ve])if("S"==o.icn3d.atoms[d].elem){Se=o.icn3d.atoms[d].coord;break}void 0!==Ae&&void 0!==Se&&(Math.abs(Ae.x-Se.x)>we||Math.abs(Ae.y-Se.y)>we||Math.abs(Ae.z-Se.z)>we||(distSqr=(Ae.x-Se.x)*(Ae.x-Se.x)+(Ae.y-Se.y)*(Ae.y-Se.y)+(Ae.z-Se.z)*(Ae.z-Se.z),
distSqr<Te&&(void 0===o.icn3d.ssbondpnts[b]&&(o.icn3d.ssbondpnts[b]=[]),o.icn3d.ssbondpnts[b].push(me),o.icn3d.ssbondpnts[b].push(ve))))}}"align"===i&&void 0!==r&&o.bFullUi&&o.setSeqAlign(r,e.alignedStructures),o.showTitle(),e={}},iCn3DUI.prototype.downloadMmtf=function(e){var t=this;MMTF.fetchReduced(e,function(i){if(10*i.numAtoms>t.icn3d.maxatomcnt){var r=!1;t.parseMmtfData(i,r)}else i=null,MMTF.fetch(e,function(e){var i=!0;t.parseMmtfData(e,i)},function(e){console.error(e)})},function(e){console.error(e)})},iCn3DUI.prototype.parseMmtfData=function(e,t){var i=this;e.numAtoms;i.icn3d.init();var r=new THREE.Vector3(9999,9999,9999),o=new THREE.Vector3((-9999),(-9999),(-9999)),n=new THREE.Vector3,s=e.structureId;if(i.icn3d.molTitle=e.title,void 0!==e.bioAssemblyList&&void 0!==e.bioAssemblyList[0]&&e.bioAssemblyList[0].transformList.length>1){i.icn3d.biomtMatrices=[];for(var a=0,c=e.bioAssemblyList[0].transformList.length;a<c;++a){var d=(new THREE.Matrix4).fromArray(e.bioAssemblyList[0].transformList[a].matrix).transpose();i.icn3d.biomtMatrices.push(d)}}void 0!==i.icn3d.biomtMatrices&&i.icn3d.biomtMatrices.length>1?($("#"+i.pre+"assemblyWrapper").show(),i.icn3d.asuCnt=i.icn3d.biomtMatrices.length):$("#"+i.pre+"assemblyWrapper").hide();var l,h,u,p,m,v,f,g,y,b,E,C,w,T,R,A={},S=[],x="coil",H="",_=0,I=0,D=!1,O={onModel:function(e){l=0===e.modelIndex?s:s+(e.modelIndex+1).toString()},onChain:function(e){D=!1,h=e.chainName;var t=l+"_"+h;void 0===i.icn3d.structures[l]&&(i.icn3d.structures[l]=[]),i.icn3d.structures[l].push(t)},onGroup:function(e){u=e.groupName,p=e.groupId;var t=l+"_"+h+"_"+p;m=0===e.secStruct||2===e.secStruct||4===e.secStruct?"helix":3===e.secStruct?"sheet":e.secStruct===-1?"other":"coil";var r=!1;if(h!==H){if("coil"!==m&&"other"!==m?(v=!0,f=!1):(v=!1,f=!1),"coil"!==x&&"other"!==x){var o=l+"_"+H+"_"+_.toString();for(var n in i.icn3d.residues[o])i.icn3d.atoms[n].ssbegin=!1,i.icn3d.atoms[n].ssend=!0}}else m!==x?"coil"===x||"other"===x?(v=!0,f=!1):"coil"===m||"other"===m?(r=!0,v=!1,f=!1):("sheet"===x&&"helix"===m||"helix"===x&&"sheet"===m)&&(r=!0,v=!0,f=!1):(v=!1,f=!1);if(r){var o=l+"_"+h+"_"+(p-1).toString();for(var n in i.icn3d.residues[o])i.icn3d.atoms[n].ssbegin=!1,i.icn3d.atoms[n].ssend=!0}x=m,H=h,_=p,g=!1,y=!1,b=!1,"non-polymer"===e.chemCompType.toLowerCase()||"other"===e.chemCompType.toLowerCase()||e.chemCompType.toLowerCase().indexOf("saccharide")!==-1?g=!0:e.chemCompType.toLowerCase().indexOf("peptide")!==-1?y=!0:e.chemCompType.toLowerCase().indexOf("dna")!==-1||e.chemCompType.toLowerCase().indexOf("rna")!==-1?b=!0:y=!0;var s=l+"_"+h,a={};a.resi=p,a.name=i.icn3d.residueName2Abbr(u),i.icn3d.residueId2Name[t]=a.name;var c="";a.resi%10===0&&(c=a.resi.toString());var d="-";"helix"===m?d="H":"sheet"===m?d="E":"coil"===m?d="c":"other"===m&&(d="o"),void 0===i.icn3d.chainsSeq[s]&&(i.icn3d.chainsSeq[s]=[]),i.bFullUi&&i.icn3d.chainsSeq[s].push(a),i.icn3d.secondaries[t]=d},onAtom:function(e){if(E=e.element,C=e.atomName,w=new THREE.Vector3(e.xCoord,e.yCoord,e.zCoord),T=e.bFactor,R=e.altLoc,"\0"===e.altLoc&&(R=""),""===R||"A"===R){++I,"SG"===C&&S.push(I),A[e.atomIndex]=I;var s={het:g,serial:I,name:C,alt:R,resn:u,structure:l,chain:h,resi:p,coord:w,b:T,elem:E,bonds:[],bondOrder:[],ss:m,ssbegin:v,ssend:f};i.icn3d.atoms[I]=s,r.min(w),o.max(w),n.add(w);var a=l+"_"+h,c=a+"_"+p;void 0===i.icn3d.chains[a]&&(i.icn3d.chains[a]={}),i.icn3d.chains[a][I]=1,void 0===i.icn3d.residues[c]&&(i.icn3d.residues[c]={}),i.icn3d.residues[c][I]=1,y?(i.icn3d.proteins[I]=1,"CA"===C&&(i.icn3d.calphas[I]=1),"N"!==C&&"CA"!==C&&"C"!==C&&"O"!==C&&(i.icn3d.sidec[I]=1)):b?(i.icn3d.nucleotides[I]=1,!t||"O3'"!=C&&"O3*"!=C?t||"P"!=C||(i.icn3d.nucleotidesO3[I]=1):i.icn3d.nucleotidesO3[I]=1):E.toLowerCase()===u.toLowerCase()?i.icn3d.ions[I]=1:"HOH"===u||"WAT"===u||"SQL"===u||"H2O"===u||"W"===u||"DOD"===u||"D3O"===u?i.icn3d.water[I]=1:i.icn3d.chemicals[I]=1,i.icn3d.dAtoms[I]=1,i.icn3d.hAtoms[I]=1}},onBond:function(e){var t=A[e.atomIndex1],r=A[e.atomIndex2];if(A.hasOwnProperty(e.atomIndex1)&&A.hasOwnProperty(e.atomIndex2)&&(i.icn3d.atoms[t].bonds.push(r),i.icn3d.atoms[r].bonds.push(t),g)){var o=e.bondOrder;i.icn3d.atoms[t].bondOrder.push(o),i.icn3d.atoms[r].bondOrder.push(o),2===o?(i.icn3d.doublebonds[t+"_"+r]=1,i.icn3d.doublebonds[r+"_"+t]=1):3===o&&(i.icn3d.triplebonds[t+"_"+r]=1,i.icn3d.triplebonds[r+"_"+t]=1)}}};MMTF.traverse(e,O);for(var L=S.length,a=0,c=L;a<c;++a)for(var M=a+1;M<c;++M){var P=S[a],k=S[M],N=i.icn3d.atoms[P],z=i.icn3d.atoms[k];if($.inArray(k,N.bonds)!==-1){var j=N.structure+"_"+N.chain+"_"+N.resi,F=z.structure+"_"+z.chain+"_"+z.resi;void 0===i.icn3d.ssbondpnts[N.structure]&&(i.icn3d.ssbondpnts[N.structure]=[]),i.icn3d.ssbondpnts[N.structure].push(j),i.icn3d.ssbondpnts[N.structure].push(F)}}i.icn3d.cnt=I,(i.icn3d.cnt>i.icn3d.maxatomcnt||void 0!==i.icn3d.biomtMatrices&&i.icn3d.biomtMatrices.length*i.icn3d.cnt>10*i.icn3d.maxatomcnt)&&(i.opts.proteins="c alpha trace",i.opts.nucleotides="o3 trace"),i.icn3d.pmin=r,i.icn3d.pmax=o,i.icn3d.maxD=o.distanceTo(r),i.icn3d.center=n.multiplyScalar(1/i.icn3d.cnt),i.icn3d.maxD<5&&(i.icn3d.maxD=5),i.icn3d.oriMaxD=i.icn3d.maxD,i.icn3d.oriCenter=i.icn3d.center.clone(),void 0===i.cfg.align&&1==Object.keys(i.icn3d.structures).length&&$("#"+i.pre+"alternateWrapper").hide(),i.icn3d.setAtomStyleByOptions(i.opts),i.icn3d.setColorByOptions(i.opts,i.icn3d.atoms),i.renderStructure(),i.showTitle(),void 0!==i.cfg.rotate&&i.rotStruc(i.cfg.rotate,!0),void 0!==i.deferred&&i.deferred.resolve(),void 0!==i.deferred2&&i.deferred2.resolve()},iCn3DUI.prototype.downloadPdb=function(e){var t,i,r=this;t="https://files.rcsb.org/view/"+e+".pdb",i="text",r.icn3d.bCid=void 0,$.ajax({url:t,dataType:i,cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){r.showLoading()},complete:function(){r.hideLoading()},success:function(e){r.loadPdbData(e)},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}})},iCn3DUI.prototype.downloadUrl=function(e,t){var i=this,r="text";i.icn3d.bCid=void 0,$.ajax({url:e,dataType:r,cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){$("#"+i.pre+"wait")&&$("#"+i.pre+"wait").show(),$("#"+i.pre+"canvas")&&$("#"+i.pre+"canvas").hide(),$("#"+i.pre+"cmdlog")&&$("#"+i.pre+"cmdlog").hide()},complete:function(){$("#"+i.pre+"wait")&&$("#"+i.pre+"wait").hide(),$("#"+i.pre+"canvas")&&$("#"+i.pre+"canvas").show(),$("#"+i.pre+"cmdlog")&&$("#"+i.pre+"cmdlog").show()},success:function(e){i.InputfileData=e,i.InputfileType=t,"pdb"===t?i.loadPdbData(e):"mol2"===t?i.loadMol2Data(e):"sdf"===t?i.loadSdfData(e):"xyz"===t?i.loadXyzData(e):"mmcif"===t&&i.loadMmcifData(e)},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}})},iCn3DUI.prototype.loadPdbData=function(e){var t=this;return t.icn3d.loadPDB(e),void 0!==t.icn3d.biomtMatrices&&t.icn3d.biomtMatrices.length>1?($("#"+t.pre+"assemblyWrapper").show(),t.icn3d.asuCnt=t.icn3d.biomtMatrices.length):$("#"+t.pre+"assemblyWrapper").hide(),void 0!==t.icn3d.emd?($("#"+t.pre+"mapWrapper1").hide(),$("#"+t.pre+"mapWrapper2").hide(),$("#"+t.pre+"mapWrapper3").hide()):($("#"+t.pre+"emmapWrapper1").hide(),$("#"+t.pre+"emmapWrapper2").hide(),$("#"+t.pre+"emmapWrapper3").hide()),t.icn3d.bSecondaryStructure?void t.loadPdbDataRender():(t.deferredSecondary=$.Deferred(function(){var i=t.icn3d.isCalphaPhosOnly(t.icn3d.hash2Atoms(t.icn3d.proteins)),r=i?"1":"0";t.loadPdbDataBase(e,r)}),t.deferredSecondary.promise())},iCn3DUI.prototype.loadPdbDataBase=function(e,t){var i=this,r="https://www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi";$.ajax({url:r,type:"POST",data:{dssp:"t",calphaonly:t,pdbfile:e},dataType:"jsonp",cache:!0,tryCount:0,retryLimit:1,success:function(e){var t=e;if(JSON.stringify(e).indexOf("Oops there was a problem")===-1)for(var r in i.icn3d.chainsSeq)for(var o=r.indexOf("_"),n=r.substr(o+1),s=i.icn3d.chainsSeq[r],a="coil",c=0,d=s.length;c<d;++c){var l=s[c].resi,h=n+"_"+l,u="c";t.hasOwnProperty(h)&&(u=t[h]);var p;p="H"===u?"helix":"E"===u?"sheet":"coil";var m=r+"_"+l;i.icn3d.secondaries[m]=u;var v=0;if(p!==a?"coil"===a?(ssbegin=!0,ssend=!1):"coil"===p?(v=2,ssbegin=!1,ssend=!1):("sheet"===a&&"helix"===p||"helix"===a&&"sheet"===p)&&(v=1,ssbegin=!0,ssend=!1):(ssbegin=!1,ssend=!1),1==v){var f=r+"_"+(l-1).toString();for(var g in i.icn3d.residues[f])i.icn3d.atoms[g].ssbegin=!0,i.icn3d.atoms[g].ssend=!1}else if(2==v){var f=r+"_"+(l-1).toString();for(var g in i.icn3d.residues[f])i.icn3d.atoms[g].ssbegin=!1,i.icn3d.atoms[g].ssend=!0}for(var g in i.icn3d.residues[m])i.icn3d.atoms[g].ss=p,i.icn3d.atoms[g].ssbegin=ssbegin,i.icn3d.atoms[g].ssend=ssend;a=p}i.loadPdbDataRender(),void 0!==i.deferredSecondary&&i.deferredSecondary.resolve()},error:function(e,t,r){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):(i.loadPdbDataRender(),void(void 0!==i.deferredSecondary&&i.deferredSecondary.resolve()))}})},iCn3DUI.prototype.loadPdbDataRender=function(){var e=this;e.pmid=e.icn3d.pmid,void 0===e.cfg.align&&1==Object.keys(e.icn3d.structures).length&&$("#"+e.pre+"alternateWrapper").hide(),e.icn3d.setAtomStyleByOptions(e.opts),e.icn3d.setColorByOptions(e.opts,e.icn3d.atoms),e.renderStructure(),e.showTitle(),void 0!==e.cfg.rotate&&e.rotStruc(e.cfg.rotate,!0),void 0!==e.deferred&&e.deferred.resolve(),void 0!==e.deferred2&&e.deferred2.resolve()},iCn3DUI.prototype.downloadCid=function(e){var t=this,i="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+e+"/record/SDF/?record_type=3d&response_type=display";t.opts.pk="atom",t.opts.chemicals="ball and stick",t.icn3d.opts.pk="atom",t.icn3d.opts.chemicals="ball and stick",t.icn3d.bCid=!0,$.ajax({url:i,dataType:"text",cache:!0,tryCount:0,retryLimit:1,beforeSend:function(){t.showLoading()},complete:function(){t.hideLoading()},success:function(i){var r=t.loadSdfAtomData(i,e);void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),r?(t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()):alert("The SDF of CID "+e+" has the wrong format...")},error:function(e,t,i){if(this.tryCount++,this.tryCount<=this.retryLimit)return void $.ajax(this)}}).fail(function(){alert("This CID may not have 3D structure...")})},iCn3DUI.prototype.loadSdfData=function(e){var t=this,i=t.loadSdfAtomData(e);void 0===t.cfg.align&&1==Object.keys(t.icn3d.structures).length&&$("#"+t.pre+"alternateWrapper").hide(),i?(t.icn3d.setAtomStyleByOptions(t.opts),t.icn3d.setColorByOptions(t.opts,t.icn3d.atoms),t.renderStructure(),void 0!==t.cfg.rotate&&t.rotStruc(t.cfg.rotate,!0),void 0!==t.deferred&&t.deferred.resolve(),void 0!==t.deferred2&&t.deferred2.resolve()):alert("The SDF file has the wrong format...")},iCn3DUI.prototype.loadSdfAtomData=function(e,t){var i=this,r=e.split(/\r?\n|\r/);if(r.length<4)return!1;i.icn3d.init();var o=t?t:1,n="A",s=1,a="LIG",c=o,d=o+"_"+n,l=d+"_"+s,h=parseInt(r[3].substr(0,3));if(isNaN(h)||h<=0)return!1;var u=parseInt(r[3].substr(3,3)),p=4;if(r.length<p+h+u)return!1;var m,v,f=0,g=h,y={},b={},E={},C=1;for(m=f;m<g;m++){v=r[p],p++;var w=v.substr(31,3).replace(/ /g,"");if("H"!==w){var T=parseFloat(v.substr(0,10)),R=parseFloat(v.substr(10,10)),A=parseFloat(v.substr(20,10)),S=new THREE.Vector3(T,R,A),x={het:!0,serial:C,name:w,resn:a,structure:o,chain:n,resi:s,coord:S,b:0,elem:w,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};i.icn3d.atoms[C]=x,E[C]=1,y[m]=C,++C}else b[m]=1}i.icn3d.dAtoms=E,i.icn3d.hAtoms=E,i.icn3d.structures[c]=[d],i.icn3d.chains[d]=E,i.icn3d.residues[l]=E,i.icn3d.residueId2Name[l]=a,void 0===i.icn3d.chainsSeq[d]&&(i.icn3d.chainsSeq[d]=[]);var H={};for(H.resi=s,H.name=a,i.icn3d.chainsSeq[d].push(H),m=0;m<u;m++){v=r[p],p++;var _=parseInt(v.substr(0,3))-1+f,I=parseInt(v.substr(3,3))-1+f,D=v.substr(6,3).trim();if(!b.hasOwnProperty(_)&&!b.hasOwnProperty(I)){var O=y[_],L=y[I];i.icn3d.atoms[O].bonds.push(L),i.icn3d.atoms[O].bondOrder.push(D),i.icn3d.atoms[L].bonds.push(O),i.icn3d.atoms[L].bondOrder.push(D),"2"==D?(i.icn3d.doublebonds[O+"_"+L]=1,i.icn3d.doublebonds[L+"_"+O]=1):"3"==D&&(i.icn3d.triplebonds[O+"_"+L]=1,i.icn3d.triplebonds[L+"_"+O]=1)}}return i.setMaxD(),i.showTitle(),!0},iCn3DUI.prototype.setMaxD=function(){var e=this,t=new THREE.Vector3(9999,9999,9999),i=new THREE.Vector3((-9999),(-9999),(-9999)),r=new THREE.Vector3,o=0;for(var n in e.icn3d.atoms){var s=e.icn3d.atoms[n],a=s.coord;r.add(a),t.min(a),i.max(a),++o,s.het&&($.inArray(s.elem,e.icn3d.ionsArray)!==-1?e.icn3d.ions[s.serial]=1:e.icn3d.chemicals[s.serial]=1)}e.icn3d.pmin=t,e.icn3d.pmax=i,e.icn3d.cnt=o,e.icn3d.maxD=e.icn3d.pmax.distanceTo(e.icn3d.pmin),e.icn3d.center=r.multiplyScalar(1/e.icn3d.cnt),e.icn3d.maxD<5&&(e.icn3d.maxD=5),e.icn3d.oriMaxD=e.icn3d.maxD,e.icn3d.oriCenter=e.icn3d.center.clone()},iCn3DUI.prototype.removeHlAll=function(){var e=this;e.removeHlObjects()},iCn3DUI.prototype.removeHlObjects=function(){var e=this;e.icn3d.removeHlObjects()},iCn3DUI.prototype.updateHlAll=function(e,t,i){var r=this;r.updateHlObjects()},iCn3DUI.prototype.updateHlObjects=function(){var e=this;e.icn3d.removeHlObjects(),e.icn3d.addHlObjects()},iCn3DUI.prototype.toggleHighlight=function(){var e=this;e.icn3d.prevHighlightObjects.length>0||e.icn3d.prevHighlightObjects_ghost.length>0?e.clearHighlight():e.showHighlight(),e.setLogCmd("toggle highlight",!0)},iCn3DUI.prototype.clearHighlight=function(){var e=this;e.icn3d.labels.picking=[],e.icn3d.draw(),e.icn3d.removeHlObjects(),e.icn3d.render()},iCn3DUI.prototype.showHighlight=function(){var e=this;e.icn3d.addHlObjects(),e.updateHlAll()},iCn3DUI.prototype.selectAChain=function(e,t,i,r){var o=this,t=t.replace(/\s/g,""),n="select chain "+e;void 0!==r&&r?(o.icn3d.hAtoms=o.icn3d.unionHash(o.icn3d.hAtoms,o.icn3d.chains[e]),void 0===o.menuHlHash&&(o.menuHlHash={})):(o.icn3d.hAtoms={},o.menuHlHash={}),o.menuHlHash[e]=1;for(var s=i?o.icn3d.alnChainsSeq[e]:o.icn3d.chainsSeq[e],a={},c=0,d=s.length;c<d;++c){var l=s[c],h=e+"_"+l.resi,u=l.name;if(""!==u&&"-"!==u){a[h]=1;for(var p in o.icn3d.residues[h])o.icn3d.hAtoms[p]=1}}void 0!==o.icn3d.defNames2Atoms&&o.icn3d.defNames2Atoms.hasOwnProperty(e)||void 0!==o.icn3d.defNames2Residues&&o.icn3d.defNames2Residues.hasOwnProperty(e)||o.addCustomSelection(Object.keys(a),t,t,n,!0),i?o.updateHlAll(void 0,void 0,r):o.updateHlAll(Object.keys(o.menuHlHash),void 0,r)};